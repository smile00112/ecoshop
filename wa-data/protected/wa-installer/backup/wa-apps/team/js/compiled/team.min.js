!function(e){"object"==typeof exports&&exports&&"object"==typeof module&&module&&module.exports===exports?e(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],e):e(jQuery)}(function(e){function t(e){var t=e[0];return t.offsetWidth>0&&t.offsetHeight>0}function i(t){if(t.minTime&&(t.minTime=y(t.minTime)),t.maxTime&&(t.maxTime=y(t.maxTime)),t.durationTime&&"function"!=typeof t.durationTime&&(t.durationTime=y(t.durationTime)),"now"==t.scrollDefault)t.scrollDefault=function(){return t.roundingFunction(y(new Date),t)};else if(t.scrollDefault&&"function"!=typeof t.scrollDefault){var i=t.scrollDefault;t.scrollDefault=function(){return t.roundingFunction(y(i),t)}}else t.minTime&&(t.scrollDefault=function(){return t.roundingFunction(t.minTime,t)});if("string"===e.type(t.timeFormat)&&t.timeFormat.match(/[gh]/)&&(t._twelveHourTime=!0),t.showOnFocus===!1&&-1!=t.showOn.indexOf("focus")&&t.showOn.splice(t.showOn.indexOf("focus"),1),t.disableTimeRanges.length>0){for(var a in t.disableTimeRanges)t.disableTimeRanges[a]=[y(t.disableTimeRanges[a][0]),y(t.disableTimeRanges[a][1])];t.disableTimeRanges=t.disableTimeRanges.sort(function(e,t){return e[0]-t[0]});for(var a=t.disableTimeRanges.length-1;a>0;a--)t.disableTimeRanges[a][0]<=t.disableTimeRanges[a-1][1]&&(t.disableTimeRanges[a-1]=[Math.min(t.disableTimeRanges[a][0],t.disableTimeRanges[a-1][0]),Math.max(t.disableTimeRanges[a][1],t.disableTimeRanges[a-1][1])],t.disableTimeRanges.splice(a,1))}return t}function a(t){var i=t.data("timepicker-settings"),a=t.data("timepicker-list");if(a&&a.length&&(a.remove(),t.data("timepicker-list",!1)),i.useSelect){a=e("<select />",{"class":"ui-timepicker-select"});var o=a}else{a=e("<ul />",{"class":"ui-timepicker-list"});var o=e("<div />",{"class":"ui-timepicker-wrapper",tabindex:-1});o.css({display:"none",position:"absolute"}).append(a)}if(i.noneOption)if(i.noneOption===!0&&(i.noneOption=i.useSelect?"Time...":"None"),e.isArray(i.noneOption)){for(var l in i.noneOption)if(parseInt(l,10)==l){var c=n(i.noneOption[l],i.useSelect);a.append(c)}}else{var c=n(i.noneOption,i.useSelect);a.append(c)}i.className&&o.addClass(i.className),null===i.minTime&&null===i.durationTime||!i.showDuration||("function"==typeof i.step?"function":i.step,o.addClass("ui-timepicker-with-duration"),o.addClass("ui-timepicker-step-"+i.step));var u=i.minTime;"function"==typeof i.durationTime?u=y(i.durationTime()):null!==i.durationTime&&(u=i.durationTime);var f=null!==i.minTime?i.minTime:0,h=null!==i.maxTime?i.maxTime:f+_-1;f>h&&(h+=_),h===_-1&&"string"===e.type(i.timeFormat)&&i.show2400&&(h=_);var m=i.disableTimeRanges,$=0,k=m.length,E=i.step;"function"!=typeof E&&(E=function(){return i.step});for(var l=f,D=0;h>=l;D++,l+=60*E(D)){var x=l,C=w(x,i);if(i.useSelect){var T=e("<option />",{value:C});T.text(C)}else{var T=e("<li />");T.addClass(43200>x%86400?"ui-timepicker-am":"ui-timepicker-pm"),T.data("time",86400>=x?x:x%86400),T.text(C)}if((null!==i.minTime||null!==i.durationTime)&&i.showDuration){var S=g(l-u,i.step);if(i.useSelect)T.text(T.text()+" ("+S+")");else{var V=e("<span />",{"class":"ui-timepicker-duration"});V.text(" ("+S+")"),T.append(V)}}k>$&&(x>=m[$][1]&&($+=1),m[$]&&x>=m[$][0]&&x<m[$][1]&&(i.useSelect?T.prop("disabled",!0):T.addClass("ui-timepicker-disabled"))),a.append(T)}if(o.data("timepicker-input",t),t.data("timepicker-list",o),i.useSelect)t.val()&&a.val(r(y(t.val()),i)),a.on("focus",function(){e(this).data("timepicker-input").trigger("showTimepicker")}),a.on("blur",function(){e(this).data("timepicker-input").trigger("hideTimepicker")}),a.on("change",function(){p(t,e(this).val(),"select")}),p(t,a.val(),"initial"),t.hide().after(a);else{var M=i.appendTo;"string"==typeof M?M=e(M):"function"==typeof M&&(M=M(t)),M.append(o),d(t,a),a.on("mousedown click","li",function(i){t.off("focus.timepicker"),t.on("focus.timepicker-ie-hack",function(){t.off("focus.timepicker-ie-hack"),t.on("focus.timepicker",b.show)}),s(t)||t[0].focus(),a.find("li").removeClass("ui-timepicker-selected"),e(this).addClass("ui-timepicker-selected"),v(t)&&(t.trigger("hideTimepicker"),a.on("mouseup.timepicker click.timepicker","li",function(e){a.off("mouseup.timepicker click.timepicker"),o.hide()}))})}}function n(t,i){var a,n,r;return"object"==typeof t?(a=t.label,n=t.className,r=t.value):"string"==typeof t?a=t:e.error("Invalid noneOption value"),i?e("<option />",{value:r,"class":n,text:a}):e("<li />",{"class":n,text:a}).data("time",String(r))}function r(e,t){return e=t.roundingFunction(e,t),null!==e?w(e,t):void 0}function o(t){if(t.target!=window){var i=e(t.target);i.closest(".ui-timepicker-input").length||i.closest(".ui-timepicker-wrapper").length||(b.hide(),e(document).unbind(".ui-timepicker"),e(window).unbind(".ui-timepicker"))}}function s(e){var t=e.data("timepicker-settings");return(window.navigator.msMaxTouchPoints||"ontouchstart"in document)&&t.disableTouchKeyboard}function l(t,i,a){if(!a&&0!==a)return!1;var n=t.data("timepicker-settings"),r=!1,a=n.roundingFunction(a,n);return i.find("li").each(function(t,i){var n=e(i);return"number"==typeof n.data("time")&&n.data("time")==a?(r=n,!1):void 0}),r}function d(e,t){t.find("li").removeClass("ui-timepicker-selected");var i=y(u(e),e.data("timepicker-settings"));if(null!==i){var a=l(e,t,i);if(a){var n=a.offset().top-t.offset().top;(n+a.outerHeight()>t.outerHeight()||0>n)&&t.scrollTop(t.scrollTop()+a.position().top-a.outerHeight()),a.addClass("ui-timepicker-selected")}}}function c(t,i){if(""!==this.value&&"timepicker"!=i){var a=e(this);if(!a.is(":focus")||t&&"change"==t.type){var n=a.data("timepicker-settings"),r=y(this.value,n);if(null===r)return void a.trigger("timeFormatError");var o=!1;if(null!==n.minTime&&null!==n.maxTime&&(r<n.minTime||r>n.maxTime)&&(o=!0),e.each(n.disableTimeRanges,function(){return r>=this[0]&&r<this[1]?(o=!0,!1):void 0}),n.forceRoundTime){var s=n.roundingFunction(r,n);s!=r&&(r=s,i=null)}var l=w(r,n);o?p(a,l,"error")&&a.trigger("timeRangeError"):p(a,l,i)}}}function u(e){return e.is("input")?e.val():e.data("ui-timepicker-value")}function p(e,t,i){if(e.is("input")){e.val(t);var a=e.data("timepicker-settings");a.useSelect&&"select"!=i&&"initial"!=i&&e.data("timepicker-list").val(r(y(t),a))}return e.data("ui-timepicker-value")!=t?(e.data("ui-timepicker-value",t),"select"==i?e.trigger("selectTime").trigger("changeTime").trigger("change","timepicker"):-1==["error","initial"].indexOf(i)&&e.trigger("changeTime"),!0):(e.trigger("selectTime"),!1)}function f(e){switch(e.keyCode){case 13:case 9:return;default:e.preventDefault()}}function h(i){var a=e(this),n=a.data("timepicker-list");if(!n||!t(n)){if(40!=i.keyCode)return!0;b.show.call(a.get(0)),n=a.data("timepicker-list"),s(a)||a.focus()}switch(i.keyCode){case 13:return v(a)&&(c.call(a.get(0),{type:"change"}),b.hide.apply(this)),i.preventDefault(),!1;case 38:var r=n.find(".ui-timepicker-selected");return r.length?r.is(":first-child")||(r.removeClass("ui-timepicker-selected"),r.prev().addClass("ui-timepicker-selected"),r.prev().position().top<r.outerHeight()&&n.scrollTop(n.scrollTop()-r.outerHeight())):(n.find("li").each(function(t,i){return e(i).position().top>0?(r=e(i),!1):void 0}),r.addClass("ui-timepicker-selected")),!1;case 40:return r=n.find(".ui-timepicker-selected"),0===r.length?(n.find("li").each(function(t,i){return e(i).position().top>0?(r=e(i),!1):void 0}),r.addClass("ui-timepicker-selected")):r.is(":last-child")||(r.removeClass("ui-timepicker-selected"),r.next().addClass("ui-timepicker-selected"),r.next().position().top+2*r.outerHeight()>n.outerHeight()&&n.scrollTop(n.scrollTop()+r.outerHeight())),!1;case 27:n.find("li").removeClass("ui-timepicker-selected"),b.hide();break;case 9:b.hide();break;default:return!0}}function m(i){var a=e(this),n=a.data("timepicker-list"),r=a.data("timepicker-settings");if(!n||!t(n)||r.disableTextInput)return!0;switch(i.keyCode){case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 65:case 77:case 80:case 186:case 8:case 46:r.typeaheadHighlight?d(a,n):n.hide()}}function v(e){var t=e.data("timepicker-settings"),i=e.data("timepicker-list"),a=null,n=i.find(".ui-timepicker-selected");return n.hasClass("ui-timepicker-disabled")?!1:(n.length&&(a=n.data("time")),null!==a&&("string"!=typeof a&&(a=w(a,t)),p(e,a,"select")),!0)}function g(e,t){e=Math.abs(e);var i,a,n=Math.round(e/60),r=[];return 60>n?r=[n,$.mins]:(i=Math.floor(n/60),a=n%60,30==t&&30==a&&(i+=$.decimal+5),r.push(i),r.push(1==i?$.hr:$.hrs),30!=t&&a&&(r.push(a),r.push($.mins))),r.join(" ")}function w(t,i){if("number"!=typeof t)return null;var a=parseInt(t%60),n=parseInt(t/60%60),r=parseInt(t/3600%24),o=new Date(1970,0,2,r,n,a,0);if(isNaN(o.getTime()))return null;if("function"===e.type(i.timeFormat))return i.timeFormat(o);for(var s,l,d="",c=0;c<i.timeFormat.length;c++)switch(l=i.timeFormat.charAt(c)){case"a":d+=o.getHours()>11?$.pm:$.am;break;case"A":d+=o.getHours()>11?$.PM:$.AM;break;case"g":s=o.getHours()%12,d+=0===s?"12":s;break;case"G":s=o.getHours(),t===_&&(s=i.show2400?24:0),d+=s;break;case"h":s=o.getHours()%12,0!==s&&10>s&&(s="0"+s),d+=0===s?"12":s;break;case"H":s=o.getHours(),t===_&&(s=i.show2400?24:0),d+=s>9?s:"0"+s;break;case"i":var n=o.getMinutes();d+=n>9?n:"0"+n;break;case"s":a=o.getSeconds(),d+=a>9?a:"0"+a;break;case"\\":c++,d+=i.timeFormat.charAt(c);break;default:d+=l}return d}function y(e,t){if(""===e||null===e)return null;if("object"==typeof e)return 3600*e.getHours()+60*e.getMinutes()+e.getSeconds();if("string"!=typeof e)return e;e=e.toLowerCase().replace(/[\s\.]/g,""),("a"==e.slice(-1)||"p"==e.slice(-1))&&(e+="m");var i="("+$.am.replace(".","")+"|"+$.pm.replace(".","")+"|"+$.AM.replace(".","")+"|"+$.PM.replace(".","")+")?",a=new RegExp("^"+i+"([0-9]?[0-9])\\W?([0-5][0-9])?\\W?([0-5][0-9])?"+i+"$"),n=e.match(a);if(!n)return null;var r=parseInt(1*n[2],10);if(r>24){if(t&&t.wrapHours===!1)return null;r%=24}var o=n[1]||n[5],s=r;if(12>=r&&o){var l=o==$.pm||o==$.PM;s=12==r?l?12:0:r+(l?12:0)}var d=1*n[3]||0,c=1*n[4]||0,u=3600*s+60*d+c;if(12>r&&!o&&t&&t._twelveHourTime&&t.scrollDefault){var p=u-t.scrollDefault();0>p&&p>=_/-2&&(u=(u+_/2)%_)}return u}var _=86400,$={am:"am",pm:"pm",AM:"AM",PM:"PM",decimal:".",mins:"mins",hr:"hr",hrs:"hrs"},b={init:function(t){return this.each(function(){var n=e(this),r=[];for(var o in e.fn.timepicker.defaults)n.data(o)&&(r[o]=n.data(o));var s=e.extend({},e.fn.timepicker.defaults,r,t);if(s.lang&&($=e.extend($,s.lang)),s=i(s),n.data("timepicker-settings",s),n.addClass("ui-timepicker-input"),s.useSelect)a(n);else{if(n.prop("autocomplete","off"),s.showOn)for(var l in s.showOn)n.on(s.showOn[l]+".timepicker",b.show);n.on("change.timepicker",c),n.on("keydown.timepicker",h),n.on("keyup.timepicker",m),s.disableTextInput&&n.on("keydown.timepicker",f),c.call(n.get(0),null,"initial")}})},show:function(i){var n=e(this),r=n.data("timepicker-settings");if(i&&i.preventDefault(),r.useSelect)return void n.data("timepicker-list").focus();s(n)&&n.blur();var c=n.data("timepicker-list");if(!n.prop("readonly")&&(c&&0!==c.length&&"function"!=typeof r.durationTime||(a(n),c=n.data("timepicker-list")),!t(c))){n.data("ui-timepicker-value",n.val()),d(n,c),b.hide(),c.show();var p={};r.orientation.match(/r/)?p.left=n.offset().left+n.outerWidth()-c.outerWidth()+parseInt(c.css("marginLeft").replace("px",""),10):p.left=n.offset().left+parseInt(c.css("marginLeft").replace("px",""),10);var f;f=r.orientation.match(/t/)?"t":r.orientation.match(/b/)?"b":n.offset().top+n.outerHeight(!0)+c.outerHeight()>e(window).height()+e(window).scrollTop()?"t":"b","t"==f?(c.addClass("ui-timepicker-positioned-top"),p.top=n.offset().top-c.outerHeight()+parseInt(c.css("marginTop").replace("px",""),10)):(c.removeClass("ui-timepicker-positioned-top"),p.top=n.offset().top+n.outerHeight()+parseInt(c.css("marginTop").replace("px",""),10)),c.offset(p);var h=c.find(".ui-timepicker-selected");if(!h.length){var m=y(u(n));null!==m?h=l(n,c,m):r.scrollDefault&&(h=l(n,c,r.scrollDefault()))}if(h&&h.length){var v=c.scrollTop()+h.position().top-h.outerHeight();c.scrollTop(v)}else c.scrollTop(0);return r.stopScrollPropagation&&e(document).on("wheel.ui-timepicker",".ui-timepicker-wrapper",function(t){t.preventDefault();var i=e(this).scrollTop();e(this).scrollTop(i+t.originalEvent.deltaY)}),e(document).on("touchstart.ui-timepicker mousedown.ui-timepicker",o),e(window).on("resize.ui-timepicker",o),r.closeOnWindowScroll&&e(document).on("scroll.ui-timepicker",o),n.trigger("showTimepicker"),this}},hide:function(i){var a=e(this),n=a.data("timepicker-settings");return n&&n.useSelect&&a.blur(),e(".ui-timepicker-wrapper").each(function(){var i=e(this);if(t(i)){var a=i.data("timepicker-input"),n=a.data("timepicker-settings");n&&n.selectOnBlur&&v(a),i.hide(),a.trigger("hideTimepicker")}}),this},option:function(t,n){return"string"==typeof t&&"undefined"==typeof n?e(this).data("timepicker-settings")[t]:this.each(function(){var r=e(this),o=r.data("timepicker-settings"),s=r.data("timepicker-list");"object"==typeof t?o=e.extend(o,t):"string"==typeof t&&(o[t]=n),o=i(o),r.data("timepicker-settings",o),s&&(s.remove(),r.data("timepicker-list",!1)),o.useSelect&&a(r)})},getSecondsFromMidnight:function(){return y(u(this))},getTime:function(e){var t=this,i=u(t);if(!i)return null;var a=y(i);if(null===a)return null;e||(e=new Date);var n=new Date(e);return n.setHours(a/3600),n.setMinutes(a%3600/60),n.setSeconds(a%60),n.setMilliseconds(0),n},isVisible:function(){var e=this,i=e.data("timepicker-list");return!(!i||!t(i))},setTime:function(e){var t=this,i=t.data("timepicker-settings");if(i.forceRoundTime)var a=r(y(e),i);else var a=w(y(e),i);return e&&null===a&&i.noneOption&&(a=e),p(t,a),t.data("timepicker-list")&&d(t,t.data("timepicker-list")),this},remove:function(){var e=this;if(e.hasClass("ui-timepicker-input")){var t=e.data("timepicker-settings");return e.removeAttr("autocomplete","off"),e.removeClass("ui-timepicker-input"),e.removeData("timepicker-settings"),e.off(".timepicker"),e.data("timepicker-list")&&e.data("timepicker-list").remove(),t.useSelect&&e.show(),e.removeData("timepicker-list"),this}}};e.fn.timepicker=function(t){return this.length?b[t]?this.hasClass("ui-timepicker-input")?b[t].apply(this,Array.prototype.slice.call(arguments,1)):this:"object"!=typeof t&&t?void e.error("Method "+t+" does not exist on jQuery.timepicker"):b.init.apply(this,arguments):this},e.fn.timepicker.defaults={appendTo:"body",className:null,closeOnWindowScroll:!1,disableTextInput:!1,disableTimeRanges:[],disableTouchKeyboard:!1,durationTime:null,forceRoundTime:!1,maxTime:null,minTime:null,noneOption:!1,orientation:"l",roundingFunction:function(e,t){if(null===e)return null;if("number"!=typeof t.step)return e;var i=e%(60*t.step);return i>=30*t.step?e+=60*t.step-i:e-=i,e==_&&t.show2400?e:e%_},scrollDefault:null,selectOnBlur:!1,show2400:!1,showDuration:!1,showOn:["click","focus"],showOnFocus:!0,step:30,stopScrollPropagation:!1,timeFormat:"g:ia",typeaheadHighlight:!0,useSelect:!1,wrapHours:!0}});var AccessPage=function(e){var t=function(e){return t=function(e){var t=this;t.$wrapper=e.$wrapper,t.$accessWrapper=t.$wrapper.find(".t-access-wrapper"),t.$accessSlider=t.$wrapper.find(".t-access-slider"),t.$headerApps=t.$wrapper.find(".t-header-apps"),t.$headerList=t.$headerApps.find(".t-apps-list"),t.$apps=t.$headerList.find(".t-app-item"),t.item_count=t.$apps.length,t.type_class=!1,t.left=0,t.items_left=0,t.access_wrapper_w=!1,t.access_slider_w=!1,t.item_w=!1,t.initClass()},t.prototype.initClass=function(){function t(){var a=e.contains(document,i.$wrapper[0]);a?i.reset():e(window).off("resize",t)}var i=this;i.detectSliderWidth(),i.showArrows(),e(window).on("resize",t),i.$wrapper.on("click",".t-action",function(){var t=e(this);t.hasClass("left")&&i.moveSlider(!1),t.hasClass("right")&&i.moveSlider(!0)})},t.prototype.detectSliderWidth=function(){var e=this;e.access_wrapper_w=e.$accessWrapper.outerWidth(),e.access_slider_w=e.$accessSlider.outerWidth(),e.item_w=e.$apps.first().outerWidth()},t.prototype.showArrows=function(){function e(e){t.type_class&&(t.$accessWrapper.removeClass(t.type_class),t.$headerApps.removeClass(t.type_class)),e&&(t.$accessWrapper.addClass(e),t.$headerApps.addClass(e),t.type_class=e)}var t=this;t.left>=0?t.access_wrapper_w<t.access_slider_w?e("type-1"):e():e(t.access_wrapper_w<t.access_slider_w-Math.abs(t.left)?"type-2":"type-3")},t.prototype.setLeft=function(e){var t=this;t.$headerList.css({left:e}),t.$accessSlider.css({left:e}),t.left=e},t.prototype.moveSlider=function(e){var t,i,a=this,n=1,r=a.items_left;e?t=r+n:(t=r-n,0>t&&(t=0)),i=t*a.item_w,i>-(a.access_wrapper_w-a.access_slider_w)&&(i=-(a.access_wrapper_w-a.access_slider_w)),a.items_left=t,a.setLeft(-i),a.showArrows()},t.prototype.reset=function(){var e=this;e.items_left=0,e.setLeft(0),e.detectSliderWidth(),e.showArrows()},t}(e),i=function(e){return i=function(e){var t=this;t.$wrapper=e.$wrapper,t.$header=t.$wrapper.find(".t-elastic-header"),t.wrapper_offset=t.$wrapper.offset(),t.header_w=t.$header.outerWidth(),t.header_h=t.$header.outerHeight(),t.fixed_class="is-fixed",t.is_fixed=!1,t.initClass()},i.prototype.initClass=function(){function t(){var i=e.contains(document,a.$header[0]);i?a.onScroll(n.scrollTop()):n.off("scroll",t)}function i(){var t=e.contains(document,a.$header[0]);t?a.onResize():n.off("resize",i)}var a=this,n=e(window);n.on("scroll",t).on("resize",i)},i.prototype.onScroll=function(e){var t=this,i=e>t.wrapper_offset.top;i?(t.$header.addClass(t.fixed_class).css({top:0,left:t.wrapper_offset.left,width:t.header_w}),t.is_fixed=!0):(t.$header.removeClass(t.fixed_class).removeAttr("style"),t.is_fixed=!1)},i.prototype.onResize=function(){var e=this;e.header_w=e.$wrapper.outerWidth(),e.is_fixed&&e.$header.width(e.header_w)},i}(jQuery);return AccessPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.slider=!1,t.dialogs=[],t.initClass()},AccessPage.prototype.initClass=function(){var e=this;e.initAccessSlider(),e.initElasticHeader(),e.initHover(),e.bindEvents()},AccessPage.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".t-access-status",function(i){i.preventDefault();var a=e(this);a.hasClass("is-admin")&&!t.dialogs.length?e.team.content.load(a.data("uri")):showAccessDialog(a,a.data("app-id"),a.data("user-id"))});var i;e(document).on("team_access_level_changed",i=function(a,n){if(!e.contains(document.body,t.$wrapper[0]))return void e(document).off("team_access_level_changed",i);var r=t.$wrapper.find('table.t-access-table tr[data-user-id="'+n.contact_id+'"] .t-access-status[data-app-id="'+n.app_id+'"]');r.removeClass("type-no type-limited type-full type-"+n.prev_level).addClass("type-"+n.new_level)})},AccessPage.prototype.initAccessSlider=function(){var e=this;e.slider||(e.slider=new t({$wrapper:e.$wrapper}))},AccessPage.prototype.initElasticHeader=function(){var e=this;new i({$wrapper:e.$wrapper})},AccessPage.prototype.closeDialogs=function(){var t=this,i=!1;return t.dialogs.length&&(e.each(t.dialogs,function(t,a){e.contains(document,a.$wrapper[0])&&(a.close(),i=!0)}),t.dialogs=[]),i},AccessPage.prototype.initHover=function(){function t(t){var a=t.data("user-id"),s=t.data("app-id");if(i(),a&&s){var l=e("#t-user-"+a),d=e("#t-app-"+s);l.length&&(l.addClass(o),n=l),d.length&&(d.addClass(o),r=d)}}function i(){n&&(n.removeClass(o),n=!1),r&&(r.removeClass(o),r=!1)}var a=this,n=!1,r=!1,o="highlighted";a.$wrapper.on("mouseenter",".t-access-status",function(){t(e(this))}),a.$wrapper.on("mouseleave",".t-access-status",i)},AccessPage}(jQuery);!function(e){window.AccessDialog=function(e){function t(e){var t=this;t.$dialogWrapper=e.$wrapper,t.$wrapper=t.$dialogWrapper.find(".t-dialog-block"),t.$limitedContent=t.$wrapper.find(".t-limited-access-form"),t.active_class="is-active",t.disabled_class="is-disabled",t.wa_app_url=e.wa_app_url,t.app_id=e.app_id,t.contact_id=e.contact_id,t.teamDialog=t.$dialogWrapper.data("teamDialog")||!1,t.noticeToggle=i(t.$wrapper),t.$activeTab=t.$wrapper.find(".t-access-item."+t.active_class),t.active_access_id=t.$activeTab.data("access-id"),t.is_locked=!1,t.initClass()}function i(t){var i,a,n=t.find(".t-loading"),r=t.find(".t-success"),o="is-visible";return i={loading:function(){r.removeClass(o),n.addClass(o)},success:function(){r.addClass(o),n.removeClass(o),a&&clearTimeout(a),a=setTimeout(function(){e.contains(document,r[0])&&i.hide()},2e3)},hide:function(){a&&clearTimeout(a),n.removeClass(o),r.removeClass(o)}}}return t.prototype.initClass=function(){var e=this;e.bindEvents()},t.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".t-access-item",function(){var i=e(this),a=i.hasClass(t.active_class),n=i.hasClass(t.disabled_class);t.is_locked||a||n?n&&alert(i.data("reason-disabled")):(t.changeTab(i),t.teamDialog&&t.teamDialog.resize())}),t.$wrapper.on("click",'input[type="submit"]',function(e){e.stopPropagation(),t.save()})},t.prototype.changeTab=function(e){var t=this,i=e.data("access-id"),a=t.$limitedContent;t.$activeTab.length&&t.$activeTab.removeClass(t.active_class),e.addClass(t.active_class),t.$activeTab=e,t.$wrapper.find(".t-hint").hide(),"no"==i?t.$wrapper.find(".t-hint.js-access-no").show():"full"==i&&t.$wrapper.find(".t-hint.js-access-full").show(),t.$limitedContent.length&&("limited"==i?a.show():a.hide())},t.prototype.save=function(){function t(t,i){e(document).trigger("team_access_level_changed",{app_id:n.app_id,contact_id:n.contact_id,prev_level:t,new_level:i})}function i(t){var i=n.wa_app_url+"?module=accessSave&action=rights&id="+n.contact_id;return e.post(i,{app_id:n.app_id,name:"backend",value:t},"json")}function a(e){var t=!1,i={no:0,limited:1,full:2};return i.hasOwnProperty(e)&&(t=i[e]),t}var n=this,r=n.$activeTab.data("access-id"),o=a(r);n.is_locked=!0,n.noticeToggle.loading();var s=i(o);"limited"==r&&(s=s.then(function(){var t=n.$limitedContent.find("form");return e.post(t.attr("action"),t.serialize(),"json")})),s.then(function(){t(n.active_access_id,r),n.active_access_id=r,n.noticeToggle.success(),n.is_locked=!1,n.teamDialog.close()})},t}(e),window.ProfileAccessTab=function(t){"use strict";function i(){function t(t){function i(t,i){var a=e(i||this);a.prop("checked")?a.parent().addClass("highlighted"):a.parent().removeClass("highlighted")}return t.find('input[type="checkbox"]').click(i).each(i),t}var i=e("#form-customize-groups");i.length&&(t(e("#form-customize-groups .c-checkbox-menu")),e("#open-customize-groups").click(function(){e("#form-customize-groups").toggle()}),e("#cancel-customize-groups").click(function(){var t=e("#form-customize-groups").hide();return t.find(".loading").hide(),t.find(".errormsg").remove(),!1}),i.submit(function(){var t=e(this);return t.find(".errormsg").remove(),t.find(".loading").show(),e.post(t.attr("action"),t.serialize(),function(i){if("ok"==i.status){try{window.parent.$.team.sidebar.reload()}catch(a){}window.hasOwnProperty("profileTab")&&window.profileTab.reload()}else"fail"==i.status&&t.find(".c-checkbox-menu-container").after(e('<em class="errormsg">'+i.errors.join("<br />")+"</em>"))},"json"),!1}))}function a(){e("#c-credentials-form").submit(function(){var t=e(this);t.find("input.error").removeClass("error"),t.find(".errormsg").remove();var i=t.find(".c-login-input"),a=e.trim(i.val());return a?(e.post(t.attr("action"),t.serialize(),function(i){if("ok"===i.status){t.hide(),l=a,e("#c-login-block").show().find(".c-login-input").val(l).end().find(".c-login").text(l);try{window.parent.$.team.sidebar.reload()}catch(n){}try{window.profileTab.reload()}catch(n){}}else"fail"===i.status&&t.find('input[type="submit"]').parent().prepend(e('<em class="errormsg" style="margin-bottom:10px">'+i.errors.join("<br>")+"</em>"))},"json"),!1):(i.addClass("error").after('<em class="errormsg">'+p["Login is required"]+"</em>"),!1)}).find(".cancel").click(function(){return e("#c-credentials-block").hide(),!1})}function n(){var t=e("#c-login-form"),i=t.find(".c-login-input");t.submit(function(){t.find("input.error").removeClass("error"),t.find(".errormsg").remove();var a=e.trim(i.val());return l===a?!1:a?(t.find(".loading").show(),e.post(t.attr("action"),t.serialize(),function(n){if(t.find(".loading").hide(),"ok"===n.status){if(e("#c-login-block").show(),i.val(a),t.find(".c-login").text(a),t.find(".c-one-tab").show(),t.find(".c-two-tab").hide(),!l)try{window.profileTab.reload()}catch(r){}l=a}else"fail"===n.status&&t.find('input[type="submit"]').parent().prepend(e('<em class="errormsg" style="margin-bottom:10px">'+n.errors.join("\n<br>\n")+"</em>"))},"json"),!1):(i.addClass("error").after('<em class="errormsg">'+p["Login is required."]+"</em>"),!1)}),t.find(".c-tab-toggle").click(function(){return t.find(".c-one-tab,.c-two-tab").toggle(),i.is(":visible")&&i.focus(),!1})}function r(){var t=e("#c-password-form"),i=t.find(".c-password-input"),a=t.find(".c-confirm-password-input");t.submit(function(){return t.find("input.error").removeClass("error"),t.find(".errormsg").remove(),i.val()!==a.val()?(i.addClass("error"),a.after().after('<em class="errormsg">'+p["Passwords do not match."]+"</em>"),!1):(t.find(".loading").show(),e.post(t.attr("action"),t.serialize(),function(n){t.find(".loading").hide(),"ok"===n.status?(d=!0,i.val(""),a.val(""),t.find(".c-one-tab").show(),t.find(".c-two-tab").hide(),e("#c-password-block").show()):"fail"===n.status&&a.after('<em class="errormsg">'+n.errors.join("<br />")+"</em>")},"json"),!1)}),t.find(".c-tab-toggle").click(function(){t.find(".c-one-tab,.c-two-tab").toggle();var e=t.find(".c-password-input");return e.is(":visible")&&e.focus(),!1})}function o(t,i){if(!e.fn.iButton)return void e.ajax({cache:!0,dataType:"script",url:t+"wa-content/js/jquery-plugins/ibutton/jquery.ibutton.min.js?"+i,success:function(){o(t,i)}});var a=e(".basic-user-fields"),n=e("#c-access-link-block").click(function(){if(!confirm(n.data("alert")))return!1;e(".c-shown-on-enabled").hide();var t=r.parent().find(".loading").show();e.post(u+"?module=accessSave&action=ban&id="+c,{magic_word:"please"},function(i){t.hide(),"ok"===i.status&&(a.addClass("gray"),e(".c-shown-on-disabled").show(),e("#tc-user-access-disabled").show().html(i.data.access_disable_msg))},"json")}),r=e("#c-access-link-unblock").click(function(){if(!confirm(r.data("alert")))return!1;e(".c-shown-on-disabled").hide();var t=r.parent().find(".loading").show();e.post(u+"?module=accessSave&action=unban&id="+c,{magic_word:"please"},function(){t.hide(),a.removeClass("gray"),e(".c-shown-on-enabled").show(),e("#tc-user-access-disabled").hide().html("")})})}function s(t,i,a){function n(){r()&&o()}function r(){e("#c-access-rights-hint-warning").hide(),e("#c-access-rights-hint-customize").hide();var i=s.val();switch(void 0===i&&(i="1"),i){case"remove":if(e("#c-credentials-block").hide(),e("#c-login-block").hide(),e("#c-password-block").hide(),a){e("#c-access-rights-by-app").hide(),e(".c-shown-on-access").hide();break}return s.val(f||"0"),e("#c-access-rights-hint-warning").show(),!1;case"0":if(l||d){if(l){e("#c-access-rights-by-app").show(),e(".c-shown-on-access").show(),e("#c-login-block").show(),e("#c-password-block").show();break}return e("#c-login-block").show().find(".cancel").one("click.access",function(){s.val(f),n()}).end().find(".c-tab-toggle:first").click(),e("#c-password-block").show(),!1}return e("#c-credentials-block").show().find(".c-login-input").focus().end().find(".cancel").one("click.access",function(){s.val(f),n()}),!1;case"1":if(l||d){if(l){e("#c-access-rights-by-app").hide(),e(".c-shown-on-access").show(),e("#c-login-block").show(),e("#c-password-block").show();break}return e("#c-login-block").show().find(".cancel").one("click.access",function(){s.val(f),n()}).end().find(".c-tab-toggle:first").click(),e("#c-password-block").show(),!1}return e("#c-credentials-block").show().find(".c-login-input").focus().end().find(".cancel").one("click.access",function(){s.val(f),n()}),!1;default:return!1}return t&&(e("#c-login-block").show(),e("#c-password-block").show()),f=i,!0}function o(){function t(){return e.post(u+"?module=accessSave&action=makeuser",{id:c},"json")}function i(t,i,a){return e.post(u+"?module=accessSave&action=rights&id="+c,{app_id:t,name:i,value:a},"json")}var n=s.val();void 0===n&&(n="1"),function(){switch(n){case"0":return t().then(function(){return i("webasyst","backend",0)});case"1":return i("webasyst","backend",1);case"remove":return e.post(u+"?module=accessSave&action=revoke",{id:c},"json")}}().then(function(){a&&"0"==n?e("#c-access-rights-hint-customize").show():e("#c-access-rights-hint-warning").hide()})}var s=e("#c-access-rights-toggle"),p=e("#access-rights-toggle-confirm"),f=s.val();i?e(".c-shown-on-access").hide():e(".c-shown-on-access").show(),r(),p.on("click",".cancel",function(){s.val(f),p.hide()}),p.on("click",".button",function(){p.hide(),n()}),s.change(function(){if(!l)return void r();e("#c-access-rights-hint-warning").hide(),e("#c-access-rights-hint-customize").hide();var t=s.val();void 0===t&&(t="1"),t===f?p.hide():p.show()})}var l=t.login,d=t.password,c=t.contact_id,u=t.wa_app_url,p=t.loc;i(),a(),n(),r(),t.is_own_profile||o(t.wa_url,t.wa_framework_version),s(t.is_own_profile,t.contact_no_access,t.contact_groups_no_access),new UserAccessTable({$wrapper:e("#c-access-rights-wrapper"),contact_id:c,is_frame:!0})},window.UserAccessTable=function(t){"use strict";var i=t.$wrapper,a=t.contact_id,n=t.is_frame||!1;i.on("click",".t-access-status",function(t){t.preventDefault();var i=e(this);showAccessDialog(i,i.data("app-id"),a,!0,n)});var r;e(document).on("team_access_level_changed",r=function(t,a){return e.contains(document.body,i[0])?void i.find('.t-access-status[data-app-id="'+a.app_id+'"]').removeClass("type-no type-limited type-full type-"+a.prev_level).addClass("type-"+a.new_level):void e(document).off("team_access_level_changed",r)})},window.showAccessDialog=function(t,i,a,n,r){t.trigger("close"),e.post(e.team.app_url+"?module=access&action=dialog",{user_id:a,app_id:i},function(i){var a={html:i};r&&n&&(a.setPosition=function(i){var a=e(window),n=a.width(),r=t.offset().top;return{top:r,left:parseInt((n-i.width)/2)}}),new TeamDialog(a)})}}(jQuery);var CalendarPage=function(e){var t=function(e){return t=function(e){var t=this;t.$wrapper=e.$wrapper,t.$monthSelect=t.$wrapper.find(".month"),t.$yearSelect=t.$wrapper.find(".year"),t.filters_href=e.filters_href,t.month=parseInt(t.$monthSelect.val()),t.year=parseInt(t.$yearSelect.val()),t.initClass()},t.prototype.initClass=function(){var t=this;t.$monthSelect.on("change",function(){var i=e(this).val();return i&&(t.month=parseInt(i)),t.useFilter(),!1}),t.$yearSelect.on("change",function(){var i=e(this).val();return i&&(t.year=parseInt(i)),t.useFilter(),!1}),t.$wrapper.on("click",".t-arrow",function(){var i=e(this);return i.hasClass("left")&&t.changeMonth(!1),i.hasClass("right")&&t.changeMonth(!0),t.useFilter(),!1})},t.prototype.changeMonth=function(e){var t=this;e?t.month>=12?(t.month=1,t.year++):t.month++:t.month<=1?(t.month=12,t.year--):t.month--},t.prototype.useFilter=function(){var t,i=this,a=i.year+"-"+(i.month>9?i.month:"0"+i.month)+"-01",n="start="+a,r=i.filters_href.split("?"),o=r[0],s=r[1]||"",l=s.indexOf("&")>=0?s.split("&"):[s],d=!1;l.length&&e.each(l,function(e,t){var i=t.split("=")[0];"start"==i&&(d=e)}),d||0===d?l[d]=n:l.push(n),t=o+"?"+l.join("&"),e.team.content.load(t)},t}(jQuery);return CalendarPage=function(t){var i=this;i.$wrapper=t.$wrapper,i.$dateFilter=t.$dateFilter,i.filters_href=t.filters_href,i.user_id=t.user_id,i.local_storage=new e.store,i.initClass()},CalendarPage.prototype.initClass=function(){var e=this;new t({$wrapper:e.$dateFilter,filters_href:e.filters_href}),e.initInfoBlock()},CalendarPage.prototype.initInfoBlock=function(){var e=this,t=e.$wrapper.find(".t-info-notice-wrapper"),i=e.local_storage,a="team/calendar_info_warn_block_hide";i.get(a)?t.hide():t.show(),t.find(".t-info-notice-toggle").on("click",function(){i.set(a,1),t.hide()})},CalendarPage}(jQuery),TeamCalendar=function(e){function t(t){var i=[];
return t.each(function(){var t=e(this),a=[];t.find(".t-day-ornament").each(function(){a.push(e(this))}),i.push(a)}),i}return TeamCalendar=function(e){var i=this;i.$wrapper=e.$wrapper,i.$rows=i.$wrapper.find(".t-week-row"),i.days_count=7,i.weeks_count=i.$rows.length,i.selected_class="is-selected",i.active_class="is-active",i.locales=e.locales,i.is_profile=e.is_profile,i.event_view_uri="?module=schedule&action=eventView",i.event_edit_uri="?module=schedule&action=eventEdit",i.day_uri="?module=schedule&action=day",i.user_id=e.user_id,i.has_right_to_change=e.has_right_to_change,i.selected_user_id=e.selected_user_id,i.selected_calendar_id=e.selected_calendar_id,i.period_start=e.period_start,i.period_end=e.period_end,i.daysArray=t(i.$rows),i.wrapper_o=i.$wrapper.offset(),i.wrapper_w=i.$wrapper.width(),i.wrapper_h=i.$wrapper.height(),i.day_w=0,i.day_h=0,i.dialogs=[],i.xhr=!1,i.start=!1,i.end=!1,i.$selectedDays=[],i.is_locked=!1,i.bindEvents(),i.initHoverOnDay(),i.initMove()},TeamCalendar.prototype.bindEvents=function(){function t(e){return a.is_locked||(a.is_locked=!0,a.onMouseMove(e),setTimeout(function(){a.is_locked=!1},10)),!1}function i(){return a.onMouseUp(),a.$wrapper.off("mousemove",t),n.off("mouseup",i),!1}var a=this,n=e(document),r=a.has_right_to_change;r&&(a.$wrapper.find(".show-full-days-events, .t-event-wrapper").on("mousedown",function(e){e.stopPropagation(),a.clearSelection()}),n.on("mousedown",function(){a.clearSelection()}),a.$wrapper.on("mousedown",function(e){e.stopPropagation();var r=a.closeDialogs();return r||(a.onMouseDown(e),a.$wrapper.on("mousemove",t),n.on("mouseup",i)),!1})),a.$wrapper.on("click",".show-full-days-events",function(t){t.preventDefault();var i=a.closeDialogs();i||a.showFullDayEvents(e(this))}),a.$wrapper.on("click",".t-event-block.js-view-event",function(t){t.preventDefault();var i=a.closeDialogs();i||a.showEventDetails(e(this).closest(".t-event-wrapper"))})},TeamCalendar.prototype.showFullDayEvents=function(t){var i=this,a=t.data("events-id").split(","),n=t.data("date"),r={date:n,id:a};i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(i.day_uri,r,function(a){function n(t){var i=t.width,a=t.height,n=(i-s.width)/2,r=(a-s.height)/2,o=s.top-(r>0?r:0),l=s.left-(n>0?n:0),d=e(window).width()-(l+i);if(0>d){var c=10;l-=Math.abs(d)+c}return{top:o,left:l}}var r=t.closest(".t-action-wrapper"),o=r.closest(".t-week-row"),s={top:o.offset().top,left:r.offset().left,width:r.outerWidth(),height:o.outerHeight()},l=new TeamDialog({html:a,setPosition:n});i.addDialog(l)})},TeamCalendar.prototype.showEventDetails=function(t){var i=this,a=t.data("id"),n={"data[id]":a};i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(i.event_view_uri,n,function(e){var t=new TeamDialog({html:e});i.addDialog(t)})},TeamCalendar.prototype.createEvent=function(){var t=this,i=t.daysArray[t.start.week-1][t.start.day-1],a=t.daysArray[t.end.week-1][t.end.day-1],n=i.data("date"),r=a.data("date"),o={"data[start]":!1,"data[end]":!1,"data[contact_id]":t.selected_user_id||t.user_id},s=new Date,l=s.getHours();o["data[start]"]=n.replace("00:00:00",l>=23?"23:59:59":l+1+":00:00"),o["data[end]"]=r.replace("00:00:00",l>=22?"23:59:59":l+2+":00:00"),t.selected_calendar_id&&(o["data[calendar_id]"]=t.selected_calendar_id),t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.post(t.event_edit_uri,o,function(e){var i=new TeamDialog({html:e});t.addDialog(i)})},TeamCalendar.prototype.onMouseDown=function(e){var t=this;t.start=t.getDayPosition(e),t.end=t.start,t.markDays()},TeamCalendar.prototype.onMouseMove=function(e){var t=this,i=t.getDayPosition(e);t.end&&t.end.week==i.week&&t.end.day==i.day||(t.end=i,t.markDays())},TeamCalendar.prototype.initHoverOnDay=function(t){function i(t){var i=s.getDayPosition(t),a=o(i,s.daysArray),l=e(t.target);return l.hasClass("t-event-block")||l.closest(".t-event-block").length?(r(),!1):s.start?(r(),!1):a?a.hasClass(c)?!1:(d&&r(),void n(a)):(r(),!1)}function a(){r()}function n(e){e.addClass(c),d=e}function r(){d&&d.removeClass(c),d=!1}function o(e,t){var i=!1;return t[e.week-1]&&t[e.week-1][e.day-1]&&(i=t[e.week-1][e.day-1]),i}var s=this,l=s.$wrapper,d=!1,c="is-highlighted";l.on("mousemove",i).on("mouseleave",a)},TeamCalendar.prototype.onMouseUp=function(){var e=this;if(e.start.week>e.end.week||e.start.week==e.end.week&&e.start.day>e.end.day){var t={week:e.start.week,day:e.start.day};e.start={week:e.end.week,day:e.end.day},e.end=t}e.createEvent(),e.start=!1,e.end=!1},TeamCalendar.prototype.initMove=function(){function t(t){var i=n.getDayPosition(t),r=n.daysArray[i.week-1][i.day-1];if(!r)return console&&console.log&&console.log("error: date is not exist"),!1;var o=e.team.app_url+"?module=schedule&action=eventMove",l={id:parseInt(s.data("id")),start:r.data("date").replace(" 00:00:00","")};a&&a.abort(),a=e.post(o,l,function(e){"ok"==e.status&&n.reload()},"json")}function i(e){function t(e,t,i){var a={week:t.week,day:t.day},n=7-t.day;return i-=1,n>=i?a.day=a.day+i:(a.week=a.week+1,a.day=i-n,a.week>e.length&&(a={week:e.length,day:7})),a}var i=r.offset(),a=[i.left,i.left+r.outerWidth()],o=[i.top,i.top+r.outerHeight()];if(n.clearSelection(),e.pageX<=a[0]||e.pageX>=a[1])return!1;if(e.pageY<=o[0]||e.pageY>=o[1])return!1;var l=parseInt(s.data("day-count")||s.closest(".t-column").attr("colspan"));n.start=n.getDayPosition(e),n.end=t(n.daysArray,n.start,l),n.markDays()}var a,n=this,r=n.$wrapper,o=r.find(".js-move-event"),s=!1,l=!1;o.draggable({helper:"clone",appendTo:"body",cursor:"move",delay:200,cursorAt:{top:11,left:16},start:function(t,i){var a=e(i.helper.context),n=i.helper;s=a;var r=parseInt(s.closest(".t-column").attr("colspan")),o=a.data("move-hint")||!1;o&&n.find(".t-event-block").append("<span class='t-day-count'>("+o+")</span>"),n.addClass("is-clone").css({minWidth:parseInt(a.width()/r)+"px",height:a.height()+"px"})},drag:function(e,t){l||(l=!0,setTimeout(function(){l=!1},100),i(e))},stop:function(e,t){n.clearSelection(),s=!1}}),r.droppable({drop:function(e){t(e)}})},TeamCalendar.prototype.markDays=function(){function t(e,t){if(!(e>0&&t>0))return!1;var a=i.daysArray[e-1][t-1];return a.length?(a.addClass(i.selected_class),void i.$selectedDays.push(a)):(console.log("Error: Day isn't exist"),!1)}var i=this;i.deselectDays();var a=e.extend({},i.start),n=e.extend({},i.end);a.week>n.week&&(a=e.extend({},i.end),n=e.extend({},i.start));for(var r=a.week,o=n.week,s=r;o>=s;s++){var l,d;r==o?(l=a.day,d=n.day,l>d&&(l=n.day,d=a.day)):s==r?(l=a.day,d=i.days_count):s==o?(l=1,d=n.day):(l=1,d=i.days_count);for(var c=l;d>=c;c++)t(s,c)}},TeamCalendar.prototype.getDayPosition=function(e){var t=this;t.wrapper_o=t.$wrapper.offset(),t.wrapper_w=t.$wrapper.width(),t.wrapper_h=t.$wrapper.height(),t.day_w=t.wrapper_w/t.days_count,t.day_h=t.wrapper_h/t.weeks_count;var i={top:e.pageY-t.wrapper_o.top,left:e.pageX-t.wrapper_o.left},a=parseInt(i.top/t.day_h)+(i.top%t.day_h>0?1:0),n=parseInt(i.left/t.day_w)+(i.left%t.day_w>0?1:0);return{week:a,day:n}},TeamCalendar.prototype.deselectDays=function(){var t=this;t.$selectedDays.length&&(e.each(t.$selectedDays,function(){e(this).removeClass(t.selected_class)}),t.$selectedDays=[])},TeamCalendar.prototype.clearSelection=function(){var e=this;e.deselectDays(),e.start=!1,e.end=!1},TeamCalendar.prototype.reload=function(){var t=this,i="?module=schedule&action=inc",a={};t.closeDialogs(),t.selected_user_id&&(a.user=t.selected_user_id),t.selected_calendar_id&&(a.calendar=t.selected_calendar_id),t.period_start&&(a.start=t.period_start),t.period_end&&(a.end=t.period_end),t.is_profile&&(a.period=1),e.get(i,a,function(i){e.team.calendar=!1,t.$wrapper.closest(".t-calendar-wrapper").replaceWith(i)})},TeamCalendar.prototype.addDialog=function(e){var t=this;t.dialogs.push(e)},TeamCalendar.prototype.closeDialogs=function(){var t=this,i=!1;t.dialogs.length&&(e.each(t.dialogs,function(t,a){e.contains(document,a.$wrapper[0])&&(a.close(),i=!0)}),t.dialogs=[]);var a=e("#ui-datepicker-div");return a.length&&e(document).trigger("mousedown"),i},TeamCalendar}(jQuery),DayEventsDialog=function(e){return DayEventsDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.event_view_uri="?module=schedule&action=eventView",t.dialog=!1,t.xhr=!1,t.initClass()},DayEventsDialog.prototype.initClass=function(){var t=this;t.$wrapper.on("click",".t-event-block.js-view-event",function(i){i.preventDefault(),t.showEventDetails(e(this).closest(".t-event-wrapper"))})},DayEventsDialog.prototype.showEventDetails=function(t){var i=this,a=t.data("id"),n={"data[id]":a};i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(i.event_view_uri,n,function(e){i.dialog=new TeamDialog({html:e})})},DayEventsDialog}(jQuery),EventEditDialog=function(e){function t(t){var i={};return t.find(".menu-v li").each(function(){var t=e(this),a=t.find(".userpic20"),n=t.data("calendar-id");i[n]={id:n,default_status:t.data("default-status"),name:e.trim(e("<div />").html(t.text()).text()).toLowerCase(),font_color:a.css("color"),bg_color:a.css("background-color")}}),i}function i(t){var i={};return t.find(".menu-v li").each(function(){var t=e(this),a=t.find(".userpic20"),n=t.data("user-id");i[n]={id:n,$icon:a,name:e.trim(e("<div />").html(t.text()).text())}}),i}return EventEditDialog=function(e){var a=this;a.$wrapper=e.$wrapper,a.$form=a.$wrapper.find("form"),a.$statusToggle=a.$wrapper.find(".t-status-toggle"),a.$calendarToggle=a.$wrapper.find(".t-calendar-toggle"),a.$typeToggle=a.$wrapper.find(".t-type-toggle"),a.$userToggle=a.$wrapper.find(".t-user-toggle"),a.$startAltField=a.$wrapper.find("input[name='data[start_alt]']"),a.$endAltField=a.$wrapper.find("input[name='data[end_alt]']"),a.$summaryField=a.$form.find("input[name='data[summary]']"),a.teamDialog=a.$wrapper.data("teamDialog"),a.active_class="is-active",a.extended_class="is-extended",a.selected_class="selected",a.has_error_class="error",a.locales=e.locales,a.event_id=e.event_id,a.calendars=t(a.$calendarToggle),a.users=i(a.$userToggle),a.$activeStatusToggle=a.$statusToggle.find("."+a.active_class)||!1,a.is_status=e.is_status,a.is_locked=!1,a.is_changed=!1,a.user_id=e.user_id,a.calendar_id=e.calendar_id,a.summary=e.summary,a.summary_type=e.summary_type,a.start_date_locale=!1,a.end_date_locale=!1,a.initClass()},EventEditDialog.prototype.initClass=function(){var e=this;e.initDatePicker(),e.initTimePicker(),e.bindEvents(),e.setStatusLocale(),e.is_status&&(e.generateStatusTypes(),e.generatePreview())},EventEditDialog.prototype.bindEvents=function(){var t=this;t.$form.on("submit",function(e){return e.preventDefault(),t.is_locked||t.save(t.$form),!1}),t.$form.on("click",".js-delete-event",function(e){e.preventDefault(),t.is_locked||t.showDeleteConfirm()}),t.$statusToggle.on("click",".t-toggle-button",function(){return t.changeStatus(e(this)),!1}),t.$calendarToggle.on("click",".menu-v a",function(i){i.preventDefault(),t.changeCalendar(e(this))}),t.$startAltField.on("change",function(){t.setStatusLocale(),t.generateStatusTypes(),t.generatePreview()}),t.$endAltField.on("change",function(){t.setStatusLocale(),t.generateStatusTypes(),t.generatePreview()}),t.$summaryField.on("change",function(){t.summary=e(this).val(),t.summary_type="custom"}),t.$form.on("change","input[name='data[status_summary]']",function(){t.summary=e(this).val(),t.$summaryField.val(t.summary)}),t.$form.on("change",'textarea[name="data[description]"]',function(){var i=e(this).val();t.$form.find('textarea[name="data[status_description]"]').val(i)}),t.$form.on("change",'textarea[name="data[status_description]"]',function(){var i=e(this).val();t.$form.find('textarea[name="data[description]"]').val(i)}),t.$form.on("summaryChange",function(){t.$summaryField.val(t.summary)}),t.$userToggle.length&&t.$userToggle.on("click",".menu-v a",function(i){i.preventDefault(),t.changeUser(e(this))}),t.$form.on("change",".js-extended-date",function(){return t.dateToggle(e(this)),!1});var i=t.$form.find("input");i.on("mousedown",function(){var i=e(this),a=i.hasClass(t.has_error_class);a&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()})},EventEditDialog.prototype.initDatePicker=function(){function t(){var t=!1,i=e("#ui-datepicker-div");return i.length&&"none"!=i.css("display")&&(t=i),t}function i(){e(document).trigger("mousedown")}var a=this,n=a.$wrapper.find(".js-datepicker");n.each(function(){var a=e(this),n=a.closest(".t-date-wrapper").find("input[type='hidden']");a.datepicker({altField:n,altFormat:"yy-mm-dd",changeMonth:!0,changeYear:!0,shortYearCutoff:2,showOtherMonths:!0,selectOtherMonths:!0,stepMonths:2,numberOfMonths:2,beforeShow:function(a,n){n.dpDiv.on("click",function(e){e.stopPropagation()}),e(a).on("click",function(a){var n=t();n&&(a.stopPropagation(),i(),e(this).blur())})}})})},EventEditDialog.prototype.initTimePicker=function(){var t=this,i=t.$wrapper.find(".js-timepicker");i.each(function(){var t=e(this),i=!1;t.timepicker(),t.on("showTimepicker",function(){var a=t.data("timepicker-list");i||(a.on("click",function(e){e.stopPropagation()}),i=!0);var n=parseInt(t.offset().top)+parseInt(t.outerHeight())-parseInt(e(window).scrollTop());a.css({position:"fixed",top:n})})})},EventEditDialog.prototype.showDeleteConfirm=function(){var t=this,i="?module=schedule&action=eventDeleteConfirm",a={id:t.event_id};t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(e){new TeamDialog({html:e}),t.is_locked=!1,t.close()})},EventEditDialog.prototype.changeStatus=function(e){var t=this,i=e.hasClass(t.active_class);if(!i){var a=e.data("status-id");t.$activeStatusToggle&&t.$activeStatusToggle.removeClass(t.active_class),e.addClass(t.active_class),t.$activeStatusToggle=e,t.$form.find('input[name="data[is_status]"]').val(a).trigger("change");var n=1==a,r="is-event",o="is-status";if(t.is_status=n,n){t.$wrapper.removeClass(r).addClass(o);var s=t.$form.find(".js-extended-date"),l="checked"==s.attr("checked");l||s.click()}else t.$wrapper.removeClass(o).addClass(r);t.generateStatusTypes(),t.generatePreview(),t.teamDialog.resize()}},EventEditDialog.prototype.changeCalendar=function(e){var t=this,i=e.closest("li"),a=i.data("calendar-id"),n=i.hasClass(t.selected_class);if(!n&&!t.is_locked){t.is_locked=!0,t.calendar_id=a,t.$calendarToggle.find("."+t.selected_class).removeClass(t.selected_class),t.$calendarToggle.find(".t-selected-item").html(e.html()),t.$form.find('input[name="data[calendar_id]"]').val(a).trigger("change");var r=t.$calendarToggle.find(".menu-v");r.hide(),setTimeout(function(){r.removeAttr("style"),t.is_locked=!1},500),t.generateStatusTypes(),t.generatePreview()}},EventEditDialog.prototype.changeUser=function(e){var t=this,i=e.closest("li"),a=i.data("user-id"),n=i.hasClass(t.selected_class);if(!n&&!t.is_locked){t.is_locked=!0,t.user_id=a,t.$userToggle.find("."+t.selected_class).removeClass(t.selected_class),t.$userToggle.find(".t-selected-item").html(e.html()),t.$form.find('input[name="data[contact_id]"]').val(a).trigger("change");var r=t.$userToggle.find(".menu-v");r.hide(),setTimeout(function(){r.removeAttr("style"),t.is_locked=!1},200),t.generatePreview()}},EventEditDialog.prototype.save=function(t){function i(t){function i(e){var t=e.split("-"),i=parseInt(t[0]),a=parseInt(t[1]),n=parseInt(t[2]);return i>0&&a>0&&n>0?new Date(i,a-1,n):!1}function n(t){a.$form.find(".t-error").remove(),e.each(t,function(e,t){var i=a.$form.find("[name='"+t.field+"']");i.length&&i.addClass(a.has_error_class).after('<span class="t-error">'+a.locales[t.locale]+"</span>")})}var r={},o=[];e.each(t,function(e,t){r[t.name]=t.value}),r["data[summary_type]"]||(r["data[summary_type]"]="custom");var s=a.is_status;s&&(r["data[description]"]=r["data[status_description]"]?r["data[status_description]"]:"",delete r["data[status_description]"],r["data[summary]"]=a.summary,delete r["data[status_summary]"]),e.trim(r["data[summary]"]).length||(s?o.push({field:"data[status_summary]",locale:"empty"}):o.push({field:"data[summary]",locale:"empty"})),r["data[start]"].match(/^(\d){4}-(\d){2}-(\d){2}$/)||o.push({field:"data[end]",locale:"date"}),r["data[end]"].match(/^(\d){4}-(\d){2}-(\d){2}$/)||o.push({field:"data[end]",locale:"date"});var l=i(r["data[start]"]),d=i(r["data[end]"]);return l>d&&(o.push({field:"data[start_alt]",locale:"period"}),o.push({field:"data[end_alt]",locale:"period"})),o.length?(n(o),!1):(r["data[start_time]"].length||(r["data[start_time]"]="00:00"),r["data[end_time]"].length||(r["data[end_time]"]="00:00"),r["data[start]"]=r["data[start]"]+" "+r["data[start_time]"],r["data[end]"]=r["data[end]"]+" "+r["data[end_time]"],r["data[is_allday]"]=r["data[is_allday]"]?1:0,delete r["data[start_time]"],delete r["data[end_time]"],delete r["data[start_alt]"],delete r["data[end_alt]"],r)}var a=this,n=i(t.serializeArray()),r="?module=schedule&action=eventSave";a.is_locked=!0,n?e.post(r,n,function(t){if("ok"==t.status)a.reloadCalendar();else if(t.errors){var i=null;e.each(t.errors,function(e,t){"redirect"===t[0]&&(i=t[1])}),i&&(location.href=i)}a.close(),a.is_locked=!1},"json"):a.is_locked=!1},EventEditDialog.prototype.reloadCalendar=function(){e.team.calendar.reload()},EventEditDialog.prototype.dateToggle=function(e){var t=this,i="checked"==e.attr("checked"),a=t.$form.find(".t-date-wrapper");i?a.removeClass(t.extended_class):a.addClass(t.extended_class)},EventEditDialog.prototype.generatePreview=function(){var t=this,i=t.$wrapper.find(".t-preview-block"),a=t.calendars[t.calendar_id],n=a.bg_color,r=a.font_color,o=t.users[t.user_id],s=o.$icon.clone(),l=o.name,d=e("<span class='t-type'>"+(t.summary?t.summary:t.locales.empty_type)+"</span>").css({background:n,color:r});i.html("").append(s).append("<span class='t-user-name'>"+l+"</span>").append(d)},EventEditDialog.prototype.generateStatusTypes=function(){function t(){var t=r.find(".is-template li"),i=t.eq(0),a=t.eq(1),o=e("<ul class='menu-v'></ul>"),s=n.calendars[n.calendar_id];if(s.default_status){var l=i.clone();l.find(".t-type").text(s.default_status),l.find("input:radio").val("default"),o.append(l)}var d=i.clone();d.find(".t-type").text(s.name),d.find("input:radio").val("calendar"),o.append(d);var c=i.clone();c.find(".t-type").text((s.default_status?s.default_status:s.name)+" "+n.locales.till+" "+n.end_date_locale),c.find("input:radio").val("till"),o.append(c);var u=i.clone();u.find(".t-type").text((s.default_status?s.default_status:s.name)+" "+n.locales.from+" "+n.start_date_locale+" "+n.locales.till+" "+n.end_date_locale),u.find("input:radio").val("interval"),o.append(u);var p=a.clone();return p.find("input:radio").val("custom"),n.summary&&p.find("input:text").val(n.summary),o.append(p),r.find(".value").html("").append(o),o}function i(t){t.on("change","input:radio",function(){var t=e(this),i="checked"==t.attr("checked"),a=t.closest("li").find(".t-type"),r=t.closest("li").find("input:text");if(i){if(a.length)n.summary=a.text();else{if(!r.length)return!1;n.summary=r.val()}n.summary_type=t.val(),n.$form.trigger("summaryChange"),n.generatePreview()}}),t.on("focus set","input:text",function(){var t=e(this),i=t.closest("li").find("input:radio");"checked"!=i.attr("checked")&&i.attr("checked","checked").trigger("change"),t.hasClass(n.has_error_class)&&t.removeClass(n.has_error_class).closest(".value").find(".t-error").remove()}),t.on("focus change keyup","input:text",function(){var t=e(this),i=t.val();n.summary=e("<div />").html(t.val()).text(),i.length&&(n.summary_type="custom",n.summary=i),n.generatePreview()})}function a(e){if(!n.summary_type&&n.summary&&(n.summary_type="custom"),n.summary_type){var t=e.find("input:radio[value='"+n.summary_type+"']");t.length?(t.click(),"custom"!==n.summary_type&&e.find("input:text").val("")):"default"==n.summary_type?e.find("input[value='calendar']").click():e.find("input:text").val(n.summary?n.summary:"").trigger("change")}else e.find("input:radio:first").click()}var n=this,r=n.$typeToggle,o=t();i(o),a(o)},EventEditDialog.prototype.setStatusLocale=function(){function t(t){var a=t.val().split(" ")[0],n=a.split("-"),r=parseInt(n[2]),o=parseInt(n[1]),s=parseInt(n[0]),l=(new Date).getFullYear(),d=i.locales.status_type.format,c=i.locales.status_type.months[o],u=e.datepicker.formatDate(d,new Date(s,o-1,r));return u=u.replace("f",c),l==s&&(u=u.replace(", "+s,"").replace(" "+s,"").replace(s+" ","")),u}var i=this,a=i.$wrapper.find("input[name='data[start]']"),n=i.$wrapper.find("input[name='data[end]']");i.start_date_locale=t(a),i.end_date_locale=t(n)},EventEditDialog.prototype.close=function(){var e=this;e.$wrapper.trigger("close")},EventEditDialog}(jQuery),EventViewDialog=function(e){return EventViewDialog=function(e){var t=this;t.$dialogWrapper=e.$wrapper,t.$wrapper=t.$dialogWrapper.find(".t-dialog-block"),t.event_id=e.event_id,t.event_edit_uri="?module=schedule&action=eventEdit",t.xhr=!1,t.initClass()},EventViewDialog.prototype.initClass=function(){var e=this;e.$wrapper.on("click",".js-edit-event",function(t){t.preventDefault(),e.showEditForm()})},EventViewDialog.prototype.showEditForm=function(){var t=this,i={"data[id]":t.event_id};t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.post(t.event_edit_uri,i,function(i){var a=(t.$wrapper.offset(),e.team.calendar);t.close();var n=new TeamDialog({html:i});a.addDialog(n)})},EventViewDialog.prototype.close=function(){var e=this;e.$wrapper.trigger("close")},EventViewDialog}(jQuery),EventDeleteDialog=function(e){return EventDeleteDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.event_id=e.event_id,t.is_locked=!1,t.initClass()},EventDeleteDialog.prototype.initClass=function(){var e=this;e.$block.on("click",".js-delete-event",function(t){t.preventDefault(),e.is_locked||e["delete"]()})},EventDeleteDialog.prototype["delete"]=function(){var t=this,i="?module=schedule&action=eventDelete",a={id:t.event_id};t.is_locked=!0,e.post(i,a,function(i){"ok"==i.status&&(t.$wrapper.trigger("close"),e.team.calendar.reload())})},EventDeleteDialog}(jQuery),GroupPage=function(e){return GroupPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.group_id=e.group_id,t.map_provider=e.map_provider,t.latitude=e.latitude,t.longitude=e.longitude,t.can_manage=e.can_manage,t.map_is_render=!1,t.map_is_shown=!1,t.initClass()},GroupPage.prototype.initClass=function(){var e=this;e.bindEvents(),e.can_manage&&(e.initEditableName(),e.initEditableDescription()),e.initInfoBlock()},GroupPage.prototype.bindEvents=function(){var e=this;e.map_provider&&e.latitude&&e.longitude&&e.$wrapper.on("click",".js-open-map-link",function(){e.showMap()})},GroupPage.prototype.showMap=function(){var e=this,t=e.$wrapper.find(".t-map-wrapper");e.map_is_shown?t.slideUp(200):e.map_is_render?t.slideDown(200):(t.show(),e.initMap(),e.map_is_render=!0),e.map_is_shown=!e.map_is_shown},GroupPage.prototype.initMap=function(){var e=this,t=e.$wrapper.find("#t-location-map"),i=new TeamMap(t,e.map_provider);i.render(e.latitude,e.longitude)},GroupPage.prototype.initEditableName=function(){var t=this,i=t.$wrapper.find(".js-name-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val(),n=a.length&&i.text!==a;if(n){var r=e.team.app_url+"?module=group&action=save",o={"data[id]":t.group_id,"data[name]":a};i.$field.attr("disabled",!0);var s=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(r,o,function(){i.$field.attr("disabled",!1),s.remove(),i.text=a,i.$wrapper.text(a),i.toggle("hide"),e.team.sidebar.reload()})}else a.length||i.$field.val(i.text),i.toggle("hide")}})},GroupPage.prototype.initEditableDescription=function(){var t=this,i=t.$wrapper.find(".js-desc-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val(),n=!a.length;if(i.text!==a){var r=e.team.app_url+"?module=group&action=save",o={"data[id]":t.group_id,"data[description]":a};i.$field.attr("disabled",!0);var s=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(r,o,function(){i.$field.attr("disabled",!1),s.remove(),i.is_empty=n,i.text=a,i.$wrapper.text(a),i.toggle("hide"),n&&e.team.content.reload()})}else i.toggle("hide")}})},GroupPage.prototype.initInfoBlock=function(){var t=this,i=t.$wrapper.find(".t-info-notice-wrapper"),a=new e.store,n="team/empty_group_notice_hide";a.get(n)?i.hide():i.show(),i.find(".t-info-notice-toggle").on("click",function(){a.set(n,1),i.hide()})},GroupPage}(jQuery),GroupManage=function(e){return GroupManage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$groupUsersW=t.$wrapper.find(".t-users-list.is-used-list"),t.$groupUsersHint=t.$wrapper.find(".t-empty-users-in-group"),t.$otherUsersW=t.$wrapper.find(".t-users-list.is-unused-list"),t.$otherUsersHint=t.$wrapper.find(".t-empty-users-outside-group"),t.group_id=e.group_id,t.hidden_class="is-hidden",t.locales=e.locales,t.$sidebarLink=!1,t.is_locked=!1,t.xhr=!1,t.group_count=t.$groupUsersW.find(".t-user-wrapper").length,t.other_count=t.$otherUsersW.find(".t-user-wrapper").length,t.initClass()},GroupManage.prototype.initClass=function(){var e=this;e.bindEvents(),e.initAutoComplete(),e.initEditableName()},GroupManage.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".js-edit-group",function(e){e.preventDefault(),t.group_id&&!t.is_locked&&t.showEditGroupDialog()}),t.$wrapper.on("click",".js-delete-group",function(e){e.preventDefault(),t.group_id&&!t.is_locked&&t.showDeleteDialog()}),t.$groupUsersW.on("click",".js-move-user",function(i){i.preventDefault(),t.is_locked||t.moveUser(e(this).closest(".t-user-wrapper"),!1)}),t.$otherUsersW.on("click",".js-move-user",function(i){i.preventDefault(),t.is_locked||t.moveUser(e(this).closest(".t-user-wrapper"),!0)})},GroupManage.prototype.showEditGroupDialog=function(){var t=this,i="?module=group&action=edit",a={id:t.group_id};t.is_locked||(t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(e){new TeamDialog({html:e}),t.is_locked=!1}))},GroupManage.prototype.showDeleteDialog=function(){var t=this,i=e.team.app_url+"?module=group&action=deleteConfirm",a={id:t.group_id};t.is_locked||(t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(e){new TeamDialog({html:e}),t.is_locked=!1,t.$wrapper.trigger("close")}))},GroupManage.prototype.moveUser=function(t,i){var a,n=this,r={user_id:t.data("user-id"),group_id:n.group_id};n.is_locked||(n.xhr&&(n.xhr.abort(),n.xhr=!1),a=i?e.team.app_url+"?module=group&action=userAdd":e.team.app_url+"?module=group&action=userRemove",n.xhr=e.post(a,r,function(e){"ok"==e.status&&(i?(n.$groupUsersW.append(t),n.group_count++,n.other_count--):(n.$otherUsersW.prepend(t),n.group_count--,n.other_count++),n.group_count<=0?(n.$groupUsersW.addClass(n.hidden_class),n.$groupUsersHint.removeClass(n.hidden_class)):(n.$groupUsersW.removeClass(n.hidden_class),n.$groupUsersHint.addClass(n.hidden_class)),n.other_count<=0?(n.$otherUsersW.addClass(n.hidden_class),n.$otherUsersHint.removeClass(n.hidden_class)):(n.$otherUsersW.removeClass(n.hidden_class),n.$otherUsersHint.addClass(n.hidden_class)),n.setCount(n.group_count)),n.is_locked=!1}))},GroupManage.prototype.setCount=function(t){var i=this,a=e.team.app_url+"group/"+i.group_id+"/";if(i.$sidebarLink||(i.$sidebarLink=e.team.sidebar.$wrapper.find('a[href="'+a+'"] ')),i.$sidebarLink.length){var n,r=i.$sidebarLink.closest("li");r.find(".indicator").remove(),n=r.find(".count"),n.text(t),e.team.sidebar.saveCount(a,t)}},GroupManage.prototype.initAutoComplete=function(){function t(){clearTimeout(l),s.length&&(s.remove(),s=!1)}function i(i){var a=1e3;s=e('<span class="t-hint"><i class="icon16 yes"></i>'+i+"</span>"),o.after(s),l=setTimeout(t,a)}function a(t,i){var a=e.team.app_url+"?module=autocomplete&type=user",n={term:t.term};r.group_id&&(n.group_id=r.group_id),e.post(a,n,function(e){i(e)},"json")}function n(e){var t=r.$otherUsersW.find('.t-user-wrapper[data-user-id="'+e+'"]');t.length?(t.find(".js-move-user").click(),i(r.locales.added)):i(r.locales.in_group)}var r=this,o=r.$wrapper.find(".t-autocomplete-wrapper .t-input"),s=!1,l=0;o.autocomplete({source:a,minLength:2,open:function(){t()},focus:function(){return!1},select:function(e,t){return t.item.id&&n(t.item.id),o.val(""),!1}})},GroupManage.prototype.initEditableName=function(){var t=this,i=t.$wrapper.find(".js-name-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val(),n=a.length&&i.text!==a;if(n){var r=e.team.app_url+"?module=group&action=save",o={"data[id]":t.group_id,"data[name]":a};i.$field.attr("disabled",!0);var s=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(r,o,function(){i.$field.attr("disabled",!1),s.remove(),i.text=a,i.$wrapper.text(a),i.toggle("hide"),e.team.sidebar.reload()})}else a.length||i.$field.val(i.text),i.toggle("hide")}})},GroupManage}(jQuery),GroupEditDialog=function(e){return GroupEditDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.$form=t.$block.find("form"),t.$iconToggle=t.$block.find(".t-icon-toggle"),t.$addressToggle=t.$block.find(".t-address-toggle"),t.$mapToggle=t.$block.find(".t-map-toggle"),t.$submitButton=t.$form.find('input[type="submit"]'),t.selected_class="is-selected",t.hidden_class="is-hidden",t.has_error_class="error",t.locales=e.locales,t.dialog=t.$wrapper.data("teamDialog"),t.$activeType=t.$block.find(".t-type-toggle ."+t.selected_class),t.$activeIcon=t.$iconToggle.find("."+t.selected_class),t.is_locked=!1,t.save_timeout=0,t.is_map_loading=!1,t.bindEvents(),t.initMap(e.map_type||"google")},GroupEditDialog.prototype.bindEvents=function(){var t=this;t.$block.on("click",".t-type-toggle .t-toggle-item",function(i){i.stopPropagation(),t.setType(e(this))}),t.$iconToggle.on("click",".t-icon-item",function(i){i.preventDefault(),t.setIcon(e(this))}),t.$form.on("submit",function(e){e.preventDefault(),t.is_locked||(t.$submitButton.parent().append('<i class="icon16 loading"></i>'),t.save())});var i=t.$form.find("input, textarea");i.on("mousedown",function(){var i=e(this),a=i.hasClass(t.has_error_class);a&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()})},GroupEditDialog.prototype.setType=function(e){var t=this,i=e.data("type");return e.hasClass(t.selected_class)?!1:(t.$activeType.length&&t.$activeType.removeClass(t.selected_class),"group"==i?(t.$iconToggle.removeClass(t.hidden_class),t.$addressToggle.addClass(t.hidden_class),t.$mapToggle.addClass(t.hidden_class)):(t.$iconToggle.addClass(t.hidden_class),t.$addressToggle.removeClass(t.hidden_class),t.$mapToggle.removeClass(t.hidden_class)),e.addClass(t.selected_class),t.$activeType=e,void t.dialog.resize())},GroupEditDialog.prototype.setIcon=function(e){var t=this,i=e.data("icon-class");return e.hasClass(t.selected_class)?!1:(t.$activeIcon.length&&t.$activeIcon.removeClass(t.selected_class),t.$form.find('input[name="data[icon]"]').val(i).trigger("change"),e.addClass(t.selected_class),void(t.$activeIcon=e))},GroupEditDialog.prototype.save=function(){function t(t){function i(t){a.$form.find(".t-error").remove(),e.each(t,function(e,t){var i=a.$form.find("[name='"+t.field+"']");i.length&&i.addClass(a.has_error_class).after('<span class="t-error">'+a.locales[t.locale]+"</span>")})}var n={},r=[];return e.each(t,function(e,t){n[t.name]=t.value}),e.trim(n["data[name]"]).length||r.push({field:"data[name]",locale:"empty"}),r.length?(i(r),!1):n}var i,a=this,n="?module=group&action=save";if(!a.is_locked)if(a.is_locked=!0,i=t(a.$form.serializeArray())){if(a.is_map_loading)return a.is_locked=!1,a.save_timeout=setTimeout(function(){e.contains(document,a.$wrapper[0])&&a.save()},1e3),!1;e.post(n,i,function(t){if("ok"==t.status){var i=e.team.app_url+"group/"+t.data.id+"/manage/";e.team.content.load(i),e.team.sidebar.reload(),a.is_locked=!1}})}else a.is_locked=!1},GroupEditDialog.prototype.initMap=function(t){function i(t){function i(e,t){d.is(":hidden")&&(d.show(),r.data("top",r.offset().top),r.css("top",r.data("top")-d.height()/2)),a.render(e,t),l.val(e),s.val(t)}clearTimeout(u);var o="string"===e.type(t);o?(n.is_map_loading=!0,a.geocode(t,function(e,t){l.val(e),s.val(t),c.hide(),i(e,t),n.is_map_loading=!1;
},function(){d.hide(),s.val(""),l.val(""),c.show(),n.is_map_loading=!1})):i(t.lat,t.lng)}var a,n=this,r=n.$block,o=n.$addressToggle.find(".f-location-edit-address-input"),s=n.$addressToggle.find(".t-location-longitude-input"),l=n.$addressToggle.find(".t-location-latitude-input"),d=n.$mapToggle.find(".t-location-edit-map"),c=n.$addressToggle.find(".t-map-hint"),u=0;if(o.length>0){var p=n.$form.find(".value").first().width();d.width(p),d.height(p/1.618)}a=new TeamMap(d,t);var f=s.val(),h=l.val();f&&h&&i({lat:h,lng:f}),o.on("change",function(){var t=e(this).val();t.length?i(t):(s.val(""),l.val(""),d.hide())}),o.on("keyup",function(){clearTimeout(u);var t=e(this).val();t.length?(n.is_map_loading=!0,u=setTimeout(function(){i(t)},1e3)):(s.val(""),l.val(""),d.hide())})},GroupEditDialog}(jQuery),GroupDeleteDialog=function(e){return GroupDeleteDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.api_enabled=window.history&&window.history.replaceState,t.group_id=e.group_id,t.is_locked=!1,t.initClass()},GroupDeleteDialog.prototype.initClass=function(){var e=this;e.$block.on("click",".js-delete-event",function(t){t.preventDefault(),e.is_locked||e["delete"]()})},GroupDeleteDialog.prototype["delete"]=function(){var t=this,i="?module=group&action=delete",a={id:t.group_id};t.is_locked=!0,e.post(i,a,function(i){"ok"==i.status&&(t.$wrapper.trigger("close"),t.api_enabled?(history.state.content_uri=e.team.app_url,history.replaceState({reload:!0,content_uri:e.team.app_url},"",e.team.app_url),e.team.sidebar.reload(),e.team.content.reload()):location.href=e.team.app_url)},"json")},GroupDeleteDialog}(jQuery),InvitePage=function(e){return InvitePage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-invite-block"),t.$form=t.$wrapper.find("form"),t.errors=e.errors,t.error_class="error",t.is_locked=!1,t.initClass()},InvitePage.prototype.initClass=function(){var e=this;e.showErrors(),e.bindEvents(),e.autoCenter()},InvitePage.prototype.bindEvents=function(){var t=this,i=t.$form;i.on("keydown change","."+t.error_class,function(){e(this).removeClass(t.error_class).parent().find(".errormsg").remove()}),e(window).on("resize",function(){t.autoCenter()})},InvitePage.prototype.showErrors=function(){var t=this,i=t.$form,a=t.errors,n=i.find(":submit:first");e.each(a,function(a,r){var o=i.find('[name="data['+a+']"]');o.length?o.addClass(t.error_class):o=n,o.parent().append(e('<em class="errormsg"></em>').text(r))})},InvitePage.prototype.autoCenter=function(){var t,i=this,a=i.$block,n=a.outerHeight(),r=e(window).height(),o=10;t=parseInt((r-n)/2),o>t&&(t=o),a.css({top:t})},InvitePage}(jQuery),LongActionProcess=function(e){var t,i,a,n,r,o,s,l,d="",c="",u=500,p=750,f=[],h={},m=null,v=!1,g=function(){for(;f.length>0;){var e=f.shift();e&&clearTimeout(e)}},w=function(){var i=e.extend(!0,{},h);i.processId=c,i.cleanup=1,e.post(d,i,function(e){t&&t(e)}).always(function(){g()})},y=function(t){if(!v){t=t||u;var o=setTimeout(function(){var t=e.extend(!0,{},h);t.processId=c,e.post(d,t,function(e){e?e.ready?(i&&i.call(m,e),w()):e.error?n&&n.call(m,e):e.progress?(a&&a.call(m,e),y()):e.warning?(r&&r.call(m,e),y()):y(p):y(p),l&&l.call(m,e)},"json").error(function(){y(p)})},t);f.push(o)}},_=function(){o&&o();var t=e.extend(!0,{},h);e.post(d,t,function(e){e&&e.processId?(c=e.processId,y(100),y(200)):e&&e.error?n&&n.call(m,e):n&&n.call(m,"Server error")},"json").error(function(){n&&n.call(m,"Server error")})},$=function(){v=!0,s&&s.call(m),g()},b=function(e){if(!e.url)throw new Error("Url is required");d=e.url,u=e.step_delay||u,p=e.rest_delay||p,h=e.post_data||h,t=e.onCleanup,i=e.onReady,a=e.onProgress,n=e.onError,r=e.onWarning,o=e.onStart,s=e.onStop,l=e.onAlways,m=this};return e.extend(b.prototype,{start:_,stop:$}),b}(jQuery),TeamMap=function(e){var t=function(t,i,a){var n=this;if(a=a||{},!t)throw Error("DOM element is required");if(n.$map=e(t),n.provider=i,["google","yandex"].indexOf(n.provider)<0)throw Error("Not supported map provider: %s".replace("%s",n.provider));n.map_info=null,n.initClass()};return t.prototype.initClass=function(){},t.prototype.render=function(e,t){var i=this;switch(i.provider){case"google":return i.googleRender(e,t);case"yandex":return i.yandexRender(e,t)}},t.prototype.googleRender=function(e,t){var i=this;i.map_info=i.map_info||{};var a=new google.maps.LatLng(e,t);if(!i.map_info.map){var n={zoom:12,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP};i.map_info.map=new google.maps.Map(i.$map.get(0),n)}i.map_info.marker&&i.map_info.marker.setMap(null),i.map_info.marker=new google.maps.Marker({position:a,map:i.map_info.map}),i.map_info.map.setCenter(a)},t.prototype.yandexRender=function(e,t){var i=this;i.map_info=i.map_info||{};var a=[e,t];if(!i.map_info.map){var n={zoom:12,center:a,controls:["zoomControl","fullscreenControl"]};i.map_info.map=new ymaps.Map(i.$map.get(0),n)}i.map_info.marker&&i.map_info.map.geoObjects.remove(i.map_info.marker),i.map_info.marker=new ymaps.Placemark(a),i.map_info.map.geoObjects.add(i.map_info.marker),i.map_info.map.setCenter(a)},t.prototype.geocode=function(e,t,i){var a=this;switch(a.provider){case"google":return a.googleGeocode(e,t,i);case"yandex":return a.yandexGeocode(e,t,i)}},t.prototype.googleGeocode=function(e,t,i){var a=new google.maps.Geocoder;a.geocode({address:e},function(e,a){if(a==google.maps.GeocoderStatus.OK){var n=e[0].geometry.location;t(n.lat(),n.lng())}else i()})},t.prototype.yandexGeocode=function(e,t,i){ymaps.geocode(e,{results:1}).then(function(e){var a=1;if(e.metaData&&e.metaData.geocoder&&"found"in e.metaData.geocoder&&(a=e.metaData.geocoder.found),0>=a)return void i();var n=e.geoObjects.get(0),r=n.geometry.getCoordinates();t(r[0],r[1])})},t}(jQuery);$.wa.fieldTypesFactory=function(e,t){"use strict";return e=e||$.wa.contactEditorFactory(),e.baseFieldType||(e.baseFieldType={contactType:"person",options:{},createEditor:function(e){this.contactType=e||"person";var t=$.extend({},this);return delete t.createEditor,delete t.initializeFactory,t.parentEditorData={},t.initialize(),t},fieldValue:"",initializeFactory:function(e,t){this.fieldData=e,this.options=t||{}},initialize:function(){this.setValue("")},reinit:function(){this.currentMode="null",this.initialize()},setValue:function(e){this.fieldValue=e,"null"!=this.currentMode&&null!==this.domElement&&("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val");t.length>0&&(e="",t.hasClass("empty")||("checkbox"!=t.attr("type")||t.attr("checked"))&&(e=t.val()))}return e},isModified:function(){return this.fieldValue!=this.getValue()},validate:function(e){var t=this.getValue();return e||!this.fieldData.required||t?null:$_("This field is required.")},newFieldElement:function(t){this.fieldData.read_only&&(t="view");var i=this.newInlineFieldElement(t);if(null===i&&(!this.fieldData.show_empty||"edit"==t))return $('<div style="display: none" class="field" data-field-id="'+this.fieldData.id+'"></div>');var a,n="";return"person"===this.contactType?["firstname","middlename","lastname"].indexOf(this.fieldData.id)>=0?(a="subname",i.find(".val").attr("placeholder",this.fieldData.name)):"title"===this.fieldData.id?(a="subname title",i.find(".val").attr("placeholder",this.fieldData.name)):"jobtitle"===this.fieldData.id?a="jobtitle-company jobtitle":"company"===this.fieldData.id&&(a="jobtitle-company company"):"company"===this.fieldData.id&&(a="company"),e.wrapper(i,this.fieldData.name+n,a).attr("data-field-id",this.fieldData.id)},newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue)return null;var t=null;return"edit"==e?(t=$('<span><input class="val" type="text"></span>'),t.find(".val").val(this.fieldValue)):(t=$('<span class="val"></span>'),t.text(this.fieldValue)),t},showValidationErrors:function(e){if(null!==this.domElement){var t=this.domElement.find(".val");t.parents(".value").children("em.errormsg").remove(),null!==e?(t.parents(".value").append($('<em class="errormsg">'+e+"</em>")),t.addClass("error")):t.removeClass("error")}},fieldData:null,domElement:null,currentMode:"null",parentEditor:null,parentEditorData:null,setMode:function(e,t){if("undefined"==typeof t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,t)){var i=this.domElement;this.domElement=this.newFieldElement(e),null!==i&&i.replaceWith(this.domElement)}return this.domElement}}),e.factoryTypes.Hidden=$.extend({},e.baseFieldType,{newFieldElement:function(t){var i=this.newInlineFieldElement(t);return e.wrapper(i,this.fieldData.name).attr("data-field-id",this.fieldData.id).hide()},newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue)return null;var t=null;return"edit"==e&&(t=$('<span><input type="hidden" class="val" type="text"></span>'),t.find(".val").val(this.fieldValue)),t}}),e.factoryTypes.String=$.extend({},e.baseFieldType,{setValue:function(e){this.fieldValue=e,"null"!=this.currentMode&&null!==this.domElement&&("edit"==this.currentMode?this.domElement.find(".val").val(this.fieldValue):this.domElement.find(".val").html(this.fieldValue))},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val");e="",t.hasClass("empty")||(e=t.val())}return e},newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue)return null;var t=null,i=this.fieldValue;return"edit"==e?(t=this.fieldData.input_height<=1?$('<span><input class="val" type="text"><i class="icon16 loading" style="display:none;"></i></span>'):$('<span><textarea class="val" rows="'+this.fieldData.input_height+'"></textarea></span>'),t.find(".val").val(i)):t=$('<span class="val"></span><i class="icon16 loading" style="display:none;">').text(i),t},setMode:function(e,t){if("undefined"==typeof t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,t)){var i=this.domElement;this.domElement=this.newFieldElement(e),null!==i&&i.replaceWith(this.domElement)}return this.domElement}}),e.factoryTypes.Text=$.extend({},e.factoryTypes.String),e.factoryTypes.Phone=$.extend({},e.baseFieldType),e.factoryTypes.Select=$.extend({},e.baseFieldType,{notSet:function(){return""},newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue)return null;if("view"==e)return $('<span class="val"></span>').text(this.fieldData.options[this.fieldValue]||this.fieldValue);for(var t,i="",a=!1,n=0;n<this.fieldData.oOrder.length;n++){var r=this.fieldData.oOrder[n];!a&&r==this.fieldValue&&this.fieldValue?(a=!0,t=" selected"):t="",""===r&&(t+=" disabled"),i+='<option value="'+r+'"'+t+">"+$.wa.encodeHTML(this.fieldData.options[r])+"</option>"}return $('<div><select class="val '+(this.fieldData.type+"").toLowerCase()+'"><option value=""'+(a?"":" selected")+">"+this.notSet()+"</option>"+i+"</select></div>")}}),e.factoryTypes.Conditional=$.extend({},e.factoryTypes.Select,{unbindEventHandlers:function(){},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val:visible");t.length>0&&(e=t.hasClass("empty")?"":t.val())}return e},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;if(this.unbindEventHandlers(),"view"==t)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));for(var i=this,a=(i.fieldData.parent_field||"").split(":"),n=e.fieldEditors[a.shift()];n&&a.length;){var r=n.subfieldEditors;if(r instanceof Array){n=null;for(var o=0;o<r.length;o++)if(r[o]===i.parentEditor){n=r[o];break}}else n=r[a.shift()]}if(n){var s=this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue,l=$('<input type="text" class="hidden val">').val(s),d=$('<select class="hidden val"></select>').hide(),c=function(){return l.is(":visible")?l.val():d.is(":visible")?d.val():s},u=function(){var e=$(this),t=c(),a=(e.val()||"").toLowerCase(),n=i.fieldData.parent_options[a];if(n){for(l.hide(),d.show().children().remove(),o=0;o<n.length;o++)d.append($("<option></option>").attr("value",n[o]).text(n[o]).attr("selected",i.fieldValue==n[o]));d.val(t)}else l.val(t||"").show().blur(),d.hide()};return setTimeout(function(){if(!n.domElement)return void l.show();n.domElement.on("change",".val",u);var e=n.domElement.find(".val:visible");e.length&&u.call(e.get(0))},0),i.unbindEventHandlers=function(){u&&n.domElement&&n.domElement.find(".val").unbind("change",u),i.unbindEventHandlers=function(){}},$("<div></div>").append(l).append(d)}return $("<div></div>").append($('<input type="text" class="val">').val(i.fieldValue))}}),e.factoryTypes.Timezone=$.extend({},e.factoryTypes.Select,{notSet:function(){return $_("Auto")}}),e.factoryTypes.Region=$.extend({},e.factoryTypes.Select,{notSet:function(){return""},unbindEventHandlers:function(){},setCurrentCountry:function(){var e=this.current_country;return this.current_country=this.parentEditorData.parent.subfieldEditors.country.getValue(),e!==this.current_country?(delete this.fieldData.options,!0):!1},getRegionsControllerUrl:function(t){return e.getRegionsUrl()+t},newInlineFieldElement:function(t){if("view"==t&&!this.fieldValue)return null;this.unbindEventHandlers();var i=this.options||{};if(void 0!==i.country&&(this.current_country=i.country),"view"==t)return $("<div></div>").append($('<span class="val"></span>').text(this.fieldData.options&&this.fieldData.options[this.fieldValue]||this.fieldValue));var a=this;if(this.parentEditorData.parent&&this.parentEditorData.parent.subfieldEditors.country){this.setCurrentCountry();var n;$(document).on("change","select.country",n=function(){if(a.setCurrentCountry()){var e="",i=a.domElement.find(".val");e=i.is("input")?i.val().trim():i.find(":selected").text().trim();var n=function(e,t){var i=t.toLocaleLowerCase();e.find("option").each(function(){return $(this).text().trim().toLocaleLowerCase()===i?($(this).attr("selected",!0),!1):void 0})};a.domElement.empty().append(a.newInlineFieldElement(t).children());var r=a.domElement.find(".val");r.is("input")&&!r.val()?r.val(e):r.is("select")&&e?n(r,e):a.domElement.unbind("load.fieldTypes").bind("load.fieldTypes",function(){var t=a.domElement.find(".val");t.is("select")&&e&&n(t,e)})}}),a.unbindEventHandlers=function(){$(document).off("change","select.country",n),a.unbindEventHandlers=function(){}}}if(!i.no_ajax_select&&void 0===this.fieldData.options&&this.current_country&&this.fieldData.region_countries[this.current_country]){var r=this.current_country;return $.get(this.getRegionsControllerUrl(r),function(e){if(t===a.currentMode&&r===a.current_country){a.fieldData.options=e.data.options||!1,a.fieldData.oOrder=e.data.oOrder||[],$.isPlainObject(a.options)&&void 0!==a.options.country&&delete a.options.country;var i=$("<div></div>");i.append(a.newInlineFieldElement(t).children()),a.domElement.empty().append(a.newInlineFieldElement(t).children()),a.domElement.trigger("load")}},"json"),$("<div></div>").append($('<i class="icon16 loading"></i>'))}if(this.fieldData.options)return $("<div></div>").append(e.factoryTypes.Select.newInlineFieldElement.call(this,t));var o=$("<div></div>").append(e.baseFieldType.newInlineFieldElement.call(this,t));return o.find(".val").val(""),o.find(".val").attr("placeholder",this.fieldData.name+(this.fieldData.required?" ("+$_("required")+")":"")),o}}),e.factoryTypes.Country=$.extend({},e.factoryTypes.Select),e.factoryTypes.Checklist=$.extend({},e.baseFieldType,{validate:function(e){return null},setValue:function(e){if(this.fieldValue=e,"edit"==this.currentMode&&this.domElement){this.domElement.find('input[type="checkbox"]').attr("checked",!1);for(var t in this.fieldValue)this.domElement.find('input[type="checkbox"][value="'+t+'"]').attr("checked",!0)}else"view"==this.currentMode&&this.domElement&&this.domElement.find(".val").html(this.getValueView())},getValue:function(){if("edit"!=this.currentMode||!this.domElement)return this.fieldValue;var e=[];return this.domElement.find('input[type="checkbox"]:checked').each(function(t,i){e.push($(i).val())}),e},getValueView:function(){for(var t="",i=0;i<this.fieldData.oOrder.length;i++){var a=this.fieldData.oOrder[i];this.fieldValue.indexOf(a)<0||(t+=(t?", ":"")+'<a href="'+(this.fieldData.hrefPrefix||"#")+a+'">'+(this.fieldData.options[a]&&e.htmlentities(this.fieldData.options[a])||$_("&lt;no name&gt;"))+"</a>")}return t||$_("&lt;none&gt;")},newInlineFieldElement:function(t){if(!("view"!=t||this.fieldValue&&this.fieldValue.length))return null;if("view"==t)return $('<span class="val"></span>').html(this.getValueView());var i,a=0;for(i in this.fieldData.options)if(a++,a>1)break;if(!a)return null;for(var n="",r=0;r<this.fieldData.oOrder.length;r++)i=this.fieldData.oOrder[r],n+='<li><label><input type="checkbox" value="'+i+'"',this.fieldData.disabled&&this.fieldData.disabled[i]&&(n+=' disabled="disabled"'),-1!==(this.fieldValue||[]).indexOf(i)&&(n+=' checked="checked"'),n+=" />"+(this.fieldData.options[i]&&e.htmlentities(this.fieldData.options[i])||$_("&lt;no name&gt;"))+"</label></li>";return e.initCheckboxList('<div class="c-checkbox-menu-container val"><div><ul class="menu-v compact with-icons c-checkbox-menu">'+n+"</ul></div></div>")}}),e.factoryTypes.Name=$.extend({},e.baseFieldType,{newInlineFieldElement:null,newFieldElement:function(e){return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>')},setValue:function(e){this.fieldValue=e},getValue:function(t){if(this.fieldValue&&!t)return this.fieldValue;var i=[];return"person"==this.contactType?(e.fieldEditors.firstname&&i.push(e.fieldEditors.firstname.getValue()),e.fieldEditors.middlename&&i.push(e.fieldEditors.middlename.getValue()),e.fieldEditors.lastname&&i.push(e.fieldEditors.lastname.getValue())):e.fieldEditors.company&&i.push(e.fieldEditors.company.getValue()),i.join(" ").trim()},validate:function(t){var i=this.getValue(!0);if(!t&&this.fieldData.required&&!i){var a=$("#contact-info-block input:visible:text[value]:not(.empty)").val();if(!a)return $_("At least one of these fields must be filled");e.fieldEditors.firstname.setValue(a)}return null},showValidationErrors:function(t){var i=$("#contact-info-block");if(i.find("div.wa-errors-block").remove(),null!==t){var a=$('<div class="field wa-errors-block"><div class="value"><em class="errormsg">'+t+"</em></div></div>");e.fieldEditors.lastname?e.fieldEditors.lastname.domElement.after(a):i.prepend(a)}for(var n=["firstname","middlename","lastname"],r=0;r<n.length;r++){var o=n[r];e.fieldEditors[o]&&(null!==t?e.fieldEditors[o].domElement.find(".val").addClass("external-error"):e.fieldEditors[o].domElement.find(".val").removeClass("external-error"))}},setMode:function(t,i){if("undefined"==typeof i&&(i=!0),"view"!=t&&"edit"!=t)throw new Error("Unknown mode: "+t);if(this.currentMode!=t&&(this.currentMode=t,i)){var a=this.domElement;this.domElement=this.newFieldElement(t),null!==a&&a.replaceWith(this.domElement)}var n="";return e.fieldEditors.title&&(n=e.fieldEditors.title.getValue()+" "),this.domElement}}),e.factoryTypes.NameSubfield=$.extend({},e.baseFieldType,{}),e.factoryTypes.Multifield=$.extend({},e.baseFieldType,{subfieldEditors:null,subfieldFactory:null,emptySubValue:null,initializeFactory:function(e){if(this.fieldData=e,"undefined"!=typeof this.fieldData.ext){this.fieldData.extKeys=[],this.fieldData.extValues=[];for(var t in this.fieldData.ext)this.fieldData.extKeys[this.fieldData.extKeys.length]=t,this.fieldData.extValues[this.fieldData.extValues.length]=this.fieldData.ext[t]}},initialize:function(){this.subfieldFactory=$.extend({},e.factoryTypes[this.fieldData.type]),this.subfieldFactory.parentEditor=this,this.subfieldFactory.initializeFactory($.extend({},this.fieldData)),this.fieldData=$.extend({},this.fieldData,{required:this.subfieldFactory.fieldData.required}),this.subfieldEditors=[this.subfieldFactory.createEditor(this.contactType)],"object"==typeof this.subfieldEditors[0].fieldValue?(this.emptySubValue=$.extend({},this.subfieldEditors[0].fieldValue),this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0])):(this.emptySubValue={value:this.subfieldEditors[0].fieldValue},this.fieldData.ext&&(this.emptySubValue.ext=this.fieldData.extKeys[0])),this.fieldValue=[this.emptySubValue]},setValue:function(e){e&&"undefined"!=typeof e[0]||(e=[this.emptySubValue]),this.fieldValue=e;var t=0;do{if(this.subfieldEditors.length<=t&&(this.subfieldEditors[t]=this.subfieldFactory.createEditor(this.contactType),"null"!=this.currentMode&&this.subfieldEditors[t].setMode(this.currentMode).insertAfter(this.subfieldEditors[t-1].parentEditorData.domElement)),"undefined"==typeof e[t])throw new Error("At least one record must exist in data at this time.");var i=!1;for(var a in e[t])if("value"!=a&&"ext"!=a){i=!0;break}if(this.subfieldEditors[t].setValue(i?e[t]:e[t].value?e[t].value:""),"undefined"!=typeof this.fieldData.ext){var n=e[t].ext;if("null"!=this.currentMode&&this.subfieldEditors[t].parentEditorData.domElement){var r=this.subfieldEditors[t].parentEditorData.domElement.find("input.ext");r.size()>0&&r[0].setExtValue(n)}}t++}while(t<e.length);if(e.length<this.subfieldEditors.length){for(t=e.length;t<this.subfieldEditors.length;t++)0!==t&&"null"!=this.currentMode&&this.subfieldEditors[t].parentEditorData.domElement.remove();var o=e.length>0?e.length:1;this.subfieldEditors.splice(o,this.subfieldEditors.length-o)}this.origFieldValue=null},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue);for(var e=[],t=0;t<this.subfieldEditors.length;t++){var i=this.subfieldEditors[t];if(e[t]={value:i.getValue()},"undefined"!=typeof this.fieldData.ext){var a=this.fieldValue[t].ext,n=i.parentEditorData.domElement.find("input.ext")[0];"edit"==i.currentMode&&n&&(a=n.getExtValue()),e[t].ext=a}}return e},isModified:function(){for(var e=0;e<this.subfieldEditors.length;e++){var t=this.subfieldEditors[e];if(t.isModified())return!0}return!1},validate:function(e){for(var t=[],i=!0,a=0;a<this.subfieldEditors.length;a++){var n=this.subfieldEditors[a],r=n.validate(!0);r&&(t[a]=r);var o=n.getValue();(o||"string"!=typeof o)&&(i=!1)}return!e&&this.fieldData.required&&i&&(t[0]="This field is required."),t.length<=0?null:t},showValidationErrors:function(e){for(var t=0;t<this.subfieldEditors.length;t++){var i=this.subfieldEditors[t];null!==e&&"undefined"!=typeof e[t]?i.showValidationErrors(e[t]):i.showValidationErrors(null)}},deleteSubfieldButton:function(e){var t=this,i=$('<a class="delete-subfield hint" href="javascript:void(0)">'+$_("delete")+"</a>").click(function(){if(t.subfieldEditors.length<=1)return!1;var i=t.subfieldEditors.indexOf(e);return"null"!=t.currentMode&&t.subfieldEditors[i].parentEditorData.domElement.remove(),t.subfieldEditors.splice(i,1),t.subfieldEditors.length<=1&&t.domElement.find(".delete-subfield").hide(),!1});return this.subfieldEditors.length<=1&&i.hide(),i},newSubFieldElement:function(t,i){i-=0;var a=this.subfieldEditors[i];a.parentEditorData||(a.parentEditorData={}),a.parentEditorData.parent=this,a.parentEditorData.empty=!1;var n;if("function"!=typeof a.newInlineFieldElement){var r="",o=e.wrapper('<span class="replace-me-with-value"></span>',0===i?this.fieldData.name+r:"","no-bot-margins"),s=o.find("span.replace-me-with-value");n=this.fieldValue[i].ext,"edit"==t?n=e.createExtSelect(this.fieldData.ext,n):(n=this.fieldData.ext[this.fieldValue[i].ext]||n,n=$("<strong>"+e.htmlentities(n)+"</strong>")),s.before(n),"edit"==t&&s.before(this.deleteSubfieldButton(a)),s.remove(),a.domElement=this.subfieldEditors[i].newFieldElement(t);var l=this;return a.domElement.find("div.name").each(function(e,t){t.innerHTML.substr(0,l.fieldData.name.length)===l.fieldData.name&&(t.innerHTML="")}),a.parentEditorData.domElement=$("<div></div>").append(o).append(a.domElement),"edit"==t?a.parentEditorData.empty=!1:a.parentEditorData.empty=!a.fieldValue.value&&!a.fieldData.show_empty,a.parentEditorData.domElement}var d=a.newInlineFieldElement(t);if(null===d)return a.parentEditorData.domElement=a.domElement=$("<div></div>"),a.parentEditorData.empty=!0,a.parentEditorData.domElement;a.domElement=d,a.domElement.data("subfield-index",i).attr("data-subfield-index",i);var c=$('<div class="value"></div>').append(d),u=c.find(".replace-with-ext");return u.size()<=0&&(c.append('<span><span class="replace-with-ext"></span></span>'),u=c.find(".replace-with-ext")),"undefined"!=typeof this.fieldData.ext&&(n=this.fieldValue[i].ext,"edit"==t?u.before(e.createExtSelect(this.fieldData.ext,n)):(n=this.fieldData.ext[this.fieldValue[i].ext]||n,u.parents(".ext").size()>0?u.before(e.htmlentities(n)):u.before($('<em class="hint"></em>').text(" "+n)))),"edit"==t&&u.before(this.deleteSubfieldButton(a)),u.remove(),a.parentEditorData.domElement=c,c},newInlineFieldElement:null,newFieldElement:function(t){this.fieldData.read_only&&(t="view");for(var i=$('<div class="multifield-subfields"></div>'),a="function"==typeof this.subfieldFactory.newInlineFieldElement,n=!0,r=0;r<this.subfieldEditors.length;r++){var o=this.newSubFieldElement(t,r);i.append(o),n=n&&this.subfieldEditors[r].parentEditorData.empty}if(n&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');var s;if(s=a?$("<div></div>").append(i):$('<div class="field" data-field-id="'+this.fieldData.id+'"></div>').append(i),"edit"==t){var l;l=a?$('<div class="value multifield-subfields-add-another"><span class="replace-me-with-value"></span></div>'):e.wrapper('<span class="replace-me-with-value"></span>');var d=this;l.find(".replace-me-with-value").replaceWith($('<a href="javascript:void(0)" class="small inline-link"><b><i>'+$_("Add another")+"</i></b></a>").click(function(e){var a=d.subfieldFactory.createEditor(this.contactType),n=d.subfieldEditors.length,r={value:a.getValue(),temp:!0};"undefined"!=typeof d.fieldData.ext&&(r.ext=""),d.fieldValue[n]=r,d.subfieldEditors[n]=a,"null"!=d.currentMode&&a.setMode(d.currentMode),i.append(d.newSubFieldElement(t,n)),d.domElement.find(".delete-subfield").css("display","inline")})),s.append(l)}if(a){var c="";s=e.wrapper(s,this.fieldData.name+c).attr("data-field-id",this.fieldData.id)}return s},setMode:function(e,t){if("undefined"==typeof t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e){if("view"==e&&"edit"==this.currentMode&&this.origFieldValue)this.setValue(this.origFieldValue);else if("view"==this.currentMode&&!this.origFieldValue){this.origFieldValue=[];for(var i=0;i<this.fieldValue.length;i++)this.origFieldValue.push($.extend({},this.fieldValue[i]))}if(this.currentMode=e,t){var a=this.domElement;this.domElement=this.newFieldElement(e),null!==a&&a.replaceWith(this.domElement)}}for(var i=0;i<this.subfieldEditors.length;i++)this.subfieldEditors[i].setMode(e,!1);return this.domElement}}),e.factoryTypes.Composite=$.extend({},e.baseFieldType,{subfieldEditors:null,initializeFactory:function(e,t){if(this.fieldData=e,this.fieldData.required){for(var i in this.fieldData.required)if(this.fieldData.required[i]){this.fieldData.required=!0;break}this.fieldData.required!==!0&&(this.fieldData.required=!1)}this.options=t||{}},initialize:function(){var t={data:{},value:""};this.subfieldEditors={},this.fieldData.subfields=this.fieldData.fields;for(var i in this.fieldData.subfields){var a=this.fieldData.subfields[i],n=$.extend({},e.factoryTypes[a.type]),r=this.fieldData.fields[i];this.fieldData.required&&this.fieldData.required[i]&&(r.required=!0);var o=$.extend({},r,{id:null,multi:!1});n.initializeFactory(o,this.options),n.parentEditor=this,n.parentEditorData={},n.initialize(),n.parentEditorData.sfid=i,n.parentEditorData.parent=this,this.subfieldEditors[i]=n,t.data[i]=n.getValue()}this.fieldValue=t},setValue:function(e){if(e){this.fieldValue=e;for(var t in this.subfieldEditors){var i=this.subfieldEditors[t];"undefined"==typeof e.data?(i.initialize(),i.setValue(i.getValue())):"undefined"!=typeof e.data[t]?i.setValue(e.data[t]):i.setValue(i.getValue())}}},getValue:function(){if("null"==this.currentMode)return $.extend({},this.fieldValue.data);var e={};for(var t in this.subfieldEditors){var i=this.subfieldEditors[t];e[t]=i.getValue()}return e},isModified:function(){for(var e in this.subfieldEditors)if(this.subfieldEditors[e].isModified())return!0;return!1},validate:function(e){var t={},i=!1;for(var a in this.subfieldEditors){var n=this.subfieldEditors[a].validate(e);n&&(t[a]=n,i=!0)}return i?t:null},showValidationErrors:function(e){if(null!==this.domElement)for(var t in this.subfieldEditors){var i=this.subfieldEditors[t];null!==e&&"undefined"!=typeof e[t]?i.showValidationErrors(e[t]):i.showValidationErrors(null)}},newInlineFieldElement:null,newFieldElement:function(t){if(this.fieldData.read_only&&(t="view"),"view"==t&&!this.fieldValue.value&&!this.fieldData.show_empty)return $('<div style="display: none;" class="field" data-field-id="'+this.fieldData.id+'"></div>');var i=$('<div class="composite '+t+' field" data-field-id="'+this.fieldData.id+'"></div>').append(e.wrapper('<span style="display:none" class="replace-with-ext"></span>',this.fieldData.name,"hdr"));for(var a in this.subfieldEditors){var n=this.subfieldEditors[a],r=n.newFieldElement(t);r.attr("data-field-id",a),r.data("fieldId",a),n.domElement=r,i.append(r)}return i},setMode:function(e,t){if("undefined"==typeof t&&(t=!0),"view"!=e&&"edit"!=e)throw new Error("Unknown mode: "+e);if(this.currentMode!=e&&(this.currentMode=e,t)){var i=this.domElement;this.domElement=this.newFieldElement(e),null!==i&&i.replaceWith(this.domElement)}for(var a in this.subfieldEditors)this.subfieldEditors[a].setMode(e,!1);return this.domElement}}),e.factoryTypes.Address=$.extend({},e.factoryTypes.Composite,{showValidationErrors:function(e){if(null!==this.domElement&&(this.domElement.find("em.errormsg").remove(),this.domElement.find(".val").removeClass("error"),e))for(var t in this.subfieldEditors){var i=this.subfieldEditors[t];if("undefined"!=typeof e[t]){var a=i.domElement.find(".val").addClass("error");a.parents(".address-subfield").append($('<em class="errormsg">'+e[t]+"</em>"))}}},newInlineFieldElement:function(e){var t="";if("view"==e){if(!this.fieldValue.value)return null;var i="";return i="string"==typeof this.fieldValue.for_map?this.fieldValue.for_map:this.fieldValue.for_map.coords?this.fieldValue.for_map.coords:this.fieldValue.for_map.with_street,t=$('<div class="address-field"></div>').append(this.fieldValue.value).append('<span style="display:none" class="replace-with-ext"></span> ').append('<a target="_blank" href="//maps.google.com/maps?q='+encodeURIComponent(i)+'&z=15" class="small map-link">'+$_("map")+"</a>")}var a=$('<div class="address-field"></div>');a.append('<span style="display:none" class="replace-with-ext"></span>');for(var n in this.subfieldEditors){var r=this.subfieldEditors[n],o=r.newInlineFieldElement("edit");r.domElement=o,a.append($('<div class="address-subfield"></div>').append(o)),"Hidden"!==r.fieldData.type&&o.find("input.val").attr("placeholder",r.fieldData.name+(r.fieldData.required?" ("+$_("required")+")":""))}return a}}),e.factoryTypes.Birthday=e.factoryTypes.Date=$.extend({},e.baseFieldType,{newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue.value)return null;var t=null,i=this.fieldValue.data||{};if("edit"==e){for(var a=$('<select class="val" data-part="day"><option data=""></option></select>'),n=1;31>=n;n+=1){var r=$('<option data="'+n+'" value="'+n+'">'+n+"</option>");n==i.day&&r.attr("selected",!0),a.append(r)}for(var o=$('<select class="val" data-part="month"><option data=""></option></select>'),s=["January","February","March","April","May","June","July","August","September","October","November","December"],l=0;12>l;l+=1){var d=$_(s[l]),r=$('<option data="'+(l+1)+'"  value="'+(l+1)+'">'+d+"</option>");
l+1==i.month&&r.attr("selected",!0),o.append(r)}var c=$('<input type="text" data-part="year" class="val" style="min-width: 32px; width: 32px;" placeholder="'+$_("year")+'">');i.year&&c.val(i.year),t=$("<span></span>").append(a).append(" ").append(o).append(" ").append(c)}else t=$('<span class="val"></span>').text(this.fieldValue.value);return t},getValue:function(){var e=this.fieldValue;if("edit"==this.currentMode&&null!==this.domElement){var t=this.domElement.find(".val");t.length>0&&(e={value:{day:null,month:null,year:null}},t.each(function(){var t=$(this),i=t.data("part");e.value[i]=parseInt(t.val(),10)||null}))}return e},setValue:function(e){this.fieldValue=e,"null"!=this.currentMode&&null!==this.domElement&&("edit"==this.currentMode?this.domElement.find(".val").each(function(){var t=$(this),i=t.data("part");t.val(e.data[i]||"")}):this.domElement.find(".val").html(this.fieldValue))}}),e.factoryTypes.IM=$.extend({},e.baseFieldType,{setValue:function(e){"undefined"==typeof e&&(e=""),"object"==typeof e?(this.fieldValue=e.data,this.viewValue=e.value):this.fieldValue=this.viewValue=e,"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue)return null;var t=null;return"edit"==e?(t=$('<span><input class="val" type="text"></span>'),t.find(".val").val(this.fieldValue)):t=$('<span class="val"></span>').html(this.viewValue),t}}),e.factoryTypes.SocialNetwork=$.extend({},e.baseFieldType,{setValue:function(e){"undefined"==typeof e&&(e=""),"object"==typeof e?(this.fieldValue=e.data,this.viewValue=e.value):this.fieldValue=this.viewValue=e,"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").val(this.fieldValue):this.domElement.find(".val").html(this.viewValue))},newInlineFieldElement:function(e){if("view"==e&&!this.fieldValue)return null;var t=null;return"edit"==e?(t=$('<span><input class="val" type="text"></span>'),t.find(".val").val(this.fieldValue)):t=$('<span class="val"></span>').html(this.viewValue),t}}),e.factoryTypes.Url=$.extend({},e.factoryTypes.IM,{validate:function(e){var t=$.trim(this.getValue());if(!e&&this.fieldData.required&&!t)return $_("This field is required.");if(!t)return null;/^(https?|ftp|gopher|telnet|file|notes|ms-help)/.test(t)||(t="http://"+t,this.setValue(t));var i="[^`!()\\[\\]{};:'\".,<>?«»“”‘’\\s+]",a="[^`!\\[\\]{}'\"<>«»“”‘’\\s]",n=new RegExp("^(https?|ftp|gopher|telnet|file|notes|ms-help):((//)|(\\\\\\\\))+"+a+"*$","i");return n.test(t)?/^(http|ftp)/.test(t.toLowerCase())&&(n=new RegExp("^(https?|ftp):((//)|(\\\\\\\\))+((?:"+i+"+\\.)+"+i+"{2,6})((/|\\\\|#)"+a+"*)?$","i"),!n.test(t))?$_("Incorrect URL format."):null:$_("Incorrect URL format.")}}),e.factoryTypes.Email=$.extend({},e.factoryTypes.Url,{validate:function(e){var t=$.trim(this.getValue());if(!e&&this.fieldData.required&&!t)return $_("This field is required.");if(!t)return null;var i=new RegExp("^([^@\\s]+)@[^\\s@]+\\.[^\\s@\\.]{2,}$","i");return i.test(t)?null:$_("Incorrect email address format.")}}),e.factoryTypes.Checkbox=$.extend({},e.baseFieldType,{setValue:function(e){this.fieldValue=parseInt(e),"null"!=this.currentMode&&this.domElement&&("edit"==this.currentMode?this.domElement.find("input.val").attr("checked",!!this.fieldValue):this.domElement.find(".val").text(this.fieldValue?"Yes":"No"))},newInlineFieldElement:function(e){var t=null;return"edit"==e?(t=$('<span><input class="val" type="checkbox" value="1" checked="checked"></span>'),this.fieldValue||t.find(".val").removeAttr("checked")):t=$('<span class="val"></span>').text(this.fieldValue?"Yes":"No"),t}}),e.factoryTypes.Number=$.extend({},e.baseFieldType,{validate:function(e){var t=$.trim(this.getValue());return e||!this.fieldData.required||t||0===t?t&&!/^-?[0-9]+([\.,][0-9]+$)?/.test(t)?$_("Must be a number."):null:$_("This field is required.")}}),e.factoryTypes},$.wa.contactEditorFactory=function(e){"use strict";e=$.extend({contact_id:null,current_user_id:null,contactType:"person",baseFieldType:null,saveUrl:"?module=profile&action=save",saveGeocoordsUrl:"?module=contacts&action=saveGeocoords",regionsUrl:"?module=backend&action=regions&country=",el:"#contact-info-block",update_title:!0},e);var t=$.extend({wa_app_url:"",fields:{},fieldsOrder:[],fieldsValues:{},factoryTypes:{},editorFactories:{},fieldEditors:{},initFactories:function(e,t){var i=this;this.fields=e,this.fieldsOrder=t,this.editorFactories={},this.fieldEditors={},this.fieldsOrder=$.each(t,function(t,a){try{if("object"!=typeof e[a]||!e[a].type)throw new Error("Field data error for "+a);if("undefined"==typeof i.factoryTypes[e[a].type])throw new Error("Unknown factory type: "+e[a].type);return e[a].multi?i.editorFactories[a]=$.extend({},i.factoryTypes.Multifield):i.editorFactories[a]=$.extend({},i.factoryTypes[e[a].type]),i.editorFactories[a].initializeFactory(e[a]),a}catch(n){console.log("Unable to init field "+a),console.log(n),e[a]=void 0,delete e[a]}}).filter(function(e){return!!e})},resetFieldEditors:function(){for(var e=0;e<this.fieldsOrder.length;e+=1){var t=this.fieldsOrder[e];"undefined"==typeof this.fieldEditors[t]?this.fieldEditors[t]=this.editorFactories[t].createEditor(this.contactType,t):this.fieldEditors[t].reinit()}},initFieldEditors:function(e){if(!(e instanceof Array)){this.fieldsValues=e;for(var t=0;t<this.fieldsOrder.length;t+=1){var i=this.fieldsOrder[t];if("undefined"==typeof this.editorFactories[i])return void $.wa.controller.contactAction([this.contact_id]);"undefined"==typeof this.fieldEditors[i]&&(this.fieldEditors[i]=this.editorFactories[i].createEditor(this.contactType)),this.fieldEditors[i].setValue(e[i])}}},initContactInfoBlock:function(e){this.switchMode(e,!0)},getSaveUrl:function(){return this.saveUrl},getSaveGeocoordsUrl:function(){return $.wa.contactEditor.wa_backend_url+"?module=profile&action=saveGeocoords"},getRegionsUrl:function(){return $.wa.contactEditor.wa_backend_url+"?module=profile&action=regions&country="},switchMode:function(e,t){function i(e){function t(t){t.bottom<=r?e.addClass(a).css("top",-n.top):t.bottom<n.top+r?e.addClass(a).css("top",t.bottom-n.top-r):e.removeClass(a).removeAttr("style")}var i=window.parent,a="is-sticky",n=e.offset(),r=e.outerHeight();window.profileTab.initScrollWatcher(e,t),i.setTimeout(function(){$(i).trigger("scroll")},4)}var a=$(this.el),n=this;if(t&&(a.html(""),a.removeClass("edit-mode view-mode"),a.off("click.map",".map-link").on("click.map",".map-link",function(){var e=$(this).parent().data("subfield-index");if(void 0!==e){var t=n.fieldEditors.address.fieldValue;n.geocodeAddress(t,e)}})),!("edit"==e&&a.hasClass("edit-mode")||"view"==e&&a.hasClass("view-mode"))){$(this).trigger("before_switch_mode",[e,this]),a.find("div.field.buttons").remove();for(var r=[],o=0;o<this.fieldsOrder.length;o+=1){var s=this.fieldsOrder[o];r.push(s);try{var l=this.fieldEditors[s].setMode(e);$(this).trigger("set_mode",[{mode:e,el:a,field_id:s,field:this.fieldEditors[s]}]),t&&a.append(l)}catch(d){console.log("Error initializing field",s,d)}}var c=this;if("edit"==e){a.addClass("edit-mode"),a.removeClass("view-mode"),$("#edit-contact-link").hide(),a.find(".subname").wrapAll('<div class="subname-wrapper"></div>'),a.find(".jobtitle-company").wrapAll('<div class="jobtitle-company-wrapper"></div>');var u=this.inplaceEditorButtons(r,function(e){if("undefined"!=typeof e&&!e)return!1;if("undefined"!=typeof c.justCreated&&c.justCreated){var t=$("#all-users-sidebar-link .count");throw t.text(1+parseInt(t.text())),new Error("!!! Not implemented because never used. Redirect to contact_id="+c.contact_id)}return c.switchMode("view"),$.scrollTo(0),!1},function(){c.switchMode("view"),$.scrollTo(0)});null===c.contact_id&&u.find(".cancel, .or").remove(),a.append(u),setTimeout(function(){i(a.find(".buttons"))},200)}else a.addClass("view-mode"),a.removeClass("edit-mode"),$("#edit-contact-link").show(),a.find(".subname-wrapper").length&&a.find(".subname").unwrap(),a.find(".jobtitle-company-wrapper").length&&a.find(".jobtitle-company").unwrap();$(this).trigger("after_switch_mode",[e,this])}},saveFields:function(e,i){function a(e,t,i){if(i){for(var a=0;a<i.length;a+=1)if(e[i[a]]&&t[i[a]]&&e[i[a]]!=t[i[a]])return!1}else{for(var n in e)if(e.hasOwnProperty(n)&&e[n]&&t[n]&&e[n]!=t[n])return!1;for(var n in t)if(t.hasOwnProperty(n)&&e[n]&&t[n]&&e[n]!=t[n])return!1}return!0}function n(e){e=void 0===e?!0:e,$.post(l.getSaveUrl(),{data:JSON.stringify(s),type:l.contactType,id:null!=l.contact_id?l.contact_id:0},function(a){if("ok"!=a.status)throw new Exception("AJAX error:",a);var n=l.fieldsValues||{};a=a.data;var o=null;a.data&&a.data.top&&(o=a.data.top),a.data.top=void 0,delete a.data.top,null!=l.contact_id&&l.initFieldEditors(a.data);var s=!1;for(var d in l.fieldEditors)if("undefined"!=typeof a.errors[d]){if(l.fieldEditors[d].showValidationErrors(a.errors[d]),!s)for(s=l.fieldEditors[d].domElement;!s.is(":visible");)s=s.parent()}else"edit"==l.fieldEditors[d].currentMode&&l.fieldEditors[d].showValidationErrors(null);return s?($.scrollTo(s),void $.scrollTo("-=100px")):l.contact_id&&a.data.reload?void window.location.reload():(null===l.contact_id&&(l.justCreated=!0),l.contact_id=a.data.id,!s&&e&&r(n,a),i(!s),void(s||($(t).trigger("contact_saved",a.data),o&&$(t).trigger("top_fields_updated",{data:o}))))},"json")}function r(e,t){var i=$.storage.get("contacts/last_geocoding")||0;if((new Date).getTime()-i>3600){$.storage.del("contacts/last_geocoding");var r=t.data.address;if(!$.isEmptyObject(r)){for(var o=[],d=[],c=0;c<r.length;c+=1){var u=!0;s.address[c]&&(u=!a(r[c].data,(e.address[c]||{}).data||{},["city","country","region","street","zip"])),u&&(o.push(l.sendGeocodeRequest(r[c].for_map)),d.push(c))}if(o.length){var p=function(e,t){if("OK"===e.status){var i=e.results[0].geometry.location.lat||"",a=e.results[0].geometry.location.lng||"";s.address[t].value.lat=i,s.address[t].value.lng=a}else"OVER_QUERY_LIMIT"===e.status&&$.storage.set("contacts/last_geocoding",(new Date).getTime()/1e3)};$.when.apply($,o).then(function(){if(o.length<=1&&"success"===arguments[1])p(arguments[0],d[0]);else for(var e=0;e<arguments.length;e+=1)"success"===arguments[e][1]&&p(arguments[e][0],d[e]);n(!1)})}}}}if(!e){e=[];for(var o in this.fields)this.fields.hasOwnProperty(o)&&e.push(o)}for(var s={},l=this,d=!1,c=0;c<e.length;c++){var u=e[c],p=this.fieldEditors[u].validate();if(p){if(!d)for(d=this.fieldEditors[u].domElement;!d.is(":visible");)d=d.parent();this.fieldEditors[u].showValidationErrors(p)}else this.fieldEditors[u].showValidationErrors(null);s[u]=this.fieldEditors[u].getValue()}return d?($.scrollTo(d),$.scrollTo("-=100px"),void i(!1)):void n(!0)},createExtSelect:function(e,t){var i="",a=!0;for(var n in e){var r="";e[n]!==t&&n!==t||(r=' selected="selected"',a=!1);var o=this.htmlentities(e[n]);i+='<option value="'+("undefined"==typeof e.length?n:o)+'"'+r+">"+o+"</option>"}var s;a?(i+='<option value="%custom" selected="selected">'+$_("other")+"...</option>",s='<input type="text" class="small ext">'):(i+='<option value="%custom">'+$_("other")+"...</option>",s='<input type="text" class="small empty ext">');var l=$('<span><select class="ext">'+i+"</select><span>"+s+"</span></span>"),d=l.children("select");s=l.find("input"),s.val(t),"%custom"!==d.val()&&s.hide(),t=$_("which?");var c=function(){s.val()||s.hasClass("empty")||(s.val(t),s.addClass("empty"))};return s.blur(c),s.focus(function(){s.hasClass("empty")&&(s.val(""),s.removeClass("empty"))}),d.change(function(){var e=d.val();"%custom"===e?(s.hasClass("empty")&&s.val(t),s.show()):(s.hide(),s.addClass("empty"),s.val(e||"")),c()}),s[0].getExtValue=function(){return"%custom"===d.val()&&s.hasClass("empty")?"":s.val()},s[0].setExtValue=function(t){e[t]?d.val(t):d.val("%custom"),s.val(t)},l},inplaceEditorButtons:function(e,t,i){var a=$('<div class="field buttons"><div class="value submit"><em class="errormsg" id="validation-notice"></em></div></div>'),n=this,r=function(){return $(".buttons .loading").show(),n.saveFields(e,function(e){$(".buttons .loading").hide(),t(e)}),!1};$("#tc-contact").off("keyup.contact_save").on("keyup.contact_save",'#contact-info-block.edit-mode input[type="text"]',function(e){13!=e.keyCode||$(e.currentTarget).data("autocomplete")&&$(e.currentTarget).data("contact_id")||r()});var o=$('<input type="submit" class="button green" value="'+$_("Save")+'" />').click(r),n=this,s=$('<a href="javascript:void(0)" class="cancel">'+$_("cancel")+"</a>").click(function(e){return $(".buttons .loading").hide(),"function"!=typeof i?t():i(),n.fieldEditors.name.showValidationErrors(null),$.scrollTo(0),!1});return a.children("div.value.submit").append(o).append('<span class="or"> '+$_("or")+" </span>").append(s).append($('<i class="icon16 loading" style="margin-left: 16px; display: none;"></i>')),a},destroy:function(){$(this.el).html("")},wrapper:function(e,t,i){i="undefined"!=typeof i&&i?" "+i:"";var a=$('<div class="field'+i+'"></div>');return"undefined"!=typeof t&&t&&a.append('<div class="name">'+$.wa.encodeHTML(t)+"</div>"),"object"==typeof e&&e instanceof jQuery&&!(e.find("div.value").size()<=0)||(e=$('<div class="value"></div>').append(e)),a.append(e),a},htmlentities:function(e){var t=document.createElement("div"),i=document.createTextNode(e);return t.appendChild(i),t.innerHTML},geocodeAddress:function(e,t){var i=this;e[t].data.lat&&e[t].data.lng||this.sendGeocodeRequest(e[t].for_map||e[t].value,function(a){e[t].data.lat=a.lat,e[t].data.lng=a.lng,$.post(i.getSaveGeocoordsUrl(),{id:i.contact_id,lat:a.lat,lng:a.lng,sort:t})})},sendGeocodeRequest:function(e,t,i){var a=[];"string"==typeof e?a.push(e):e.with_street&&e.without_street&&e.with_street===e.without_street?a.push(e.with_street):(e.with_street&&a.push(e.with_street),e.without_street&&a.push(e.without_street)),i=!0;var n=$.Deferred(),r=this;return $.ajax({url:"//maps.googleapis.com/maps/api/geocode/json",data:{sensor:!1,address:a[0]},dataType:"json",success:function(e){var o,s;if(e)if("OK"===e.status){for(var l=e.results.length,d=!1,c=0;l>c;c+=1)if(!e.results[c].partial_match){o=e.results[c].geometry.location.lat||"",s=e.results[c].geometry.location.lng||"",t instanceof Function&&t({lat:o,lng:s}),d=!0;break}d?n.resolve([e,"success"]):i?(o=e.results[0].geometry.location.lat||"",s=e.results[0].geometry.location.lng||"",t instanceof Function&&t({lat:o,lng:s}),n.resolve([e,"success"])):a[1]?r.sendGeocodeRequest(a[1],t,!0).always(function(e){n.resolve(e)}):n.resolve([e,"success"])}else n.resolve([e,"success"]);else n.resolve([{},"error"])},error:function(e){n.resolve([e,"error"])}}),n},initCheckboxList:function(e){e=$(e);var t=function(e,t){var i=$(t||this);i.is(":checked")?i.parent().addClass("highlighted"):i.parent().removeClass("highlighted")};return e.find('input[type="checkbox"]').click(t).each(t),e}},e);return $.wa.fieldTypesFactory(t),t},$.wa.contactEditor=$.wa.contactEditorFactory();var Profile=function(e){return Profile=function(e){var t=this;t.$wrapper=e.$wrapper,t.$tabs=t.$wrapper.find(".t-profile-tabs"),t.$tabContentPlace=t.$wrapper.find(".t-dynamic-content"),t.$calendarPlace=t.$wrapper.find(".t-calendar-place"),t.api_enabled=window.history&&window.history.pushState,t.user=e.user||{id:0},t.photo_dialog_url=e.photo_dialog_url,t.photo_save_url=e.photo_save_url,t.is_locked=!1,t.xhr=!1,t.dialogs=[],t.initClass()},Profile.prototype.initClass=function(){var e=this;e.initEditableJobtitle(),e.bindEvents()},Profile.prototype.bindEvents=function(){var t=this;t.$tabs.on("click",".t-tab a",function(){return t.changeTab(e(this)),!1}),t.$calendarPlace.on("click",".js-calendar-toggle",function(i){i.preventDefault(),t.calendarToggle(e(this))}),t.$calendarPlace.on("click",".js-show-outer-calendar-manager",function(e){e.stopPropagation(),t.showOuterDialogDialog()}),t.$wrapper.on("photo_updated photo_deleted",function(e,i){t.$wrapper.find(".t-userpic").attr("src",i.url)}),t.$wrapper.find(".photo-change-link a").click(function(){e("#contact-photo-crop-dialog").remove(),e('<div id="contact-photo-crop-dialog">').data("photo-upload-url",t.photo_save_url).data("photo-delete-url",t.photo_save_url).appendTo(t.$wrapper).waDialog({"class":"large",url:t.photo_dialog_url,onLoad:function(t){var i=e(this);i.find(".dialog-buttons-gradient").append(i.find(".dialog-content-indent .buttons"))}})});var i=t.$wrapper.find(".profile-header-links");i.on("click",".edit-link",function(){t.switchToTab("info",function(e){return"function"==typeof e[0].contentWindow.$.wa.contactEditor.switchMode}).then(function(e){e[0].contentWindow.$.wa.contactEditor.switchMode("edit")})}),i.on("click",".delete-link",function(){var i=e(this).find("i");i.is(".loading")||(i.toggleClass("delete loading"),e.team.confirmContactDelete([t.user.id],{onInit:function(){i.toggleClass("delete loading")},onDelete:function(){e.team.content.load(e.team.app_url)}}))});var a=t.$wrapper.find(".t-profile-tabs-iframes"),n=e("#contact-info-top");a.on("contact_saved",function(e,t){var i=n.closest(".t-profile-page"),a=i.find(".profile .details h1").first();a.children(".contact-name:first").text(t.name),a.children(".title:first").text(t.title);var r=a.closest(".details").find(".jobtitle-company");r.children(".company").text(t.company),r.children(".title").text(t.jobtitle)}),a.on("top_fields_updated",function(e,t){for(var i="",a=0;a<t.length;a++){var r=t[a],o="im"!=r.id&&r.icon?'<i class="icon16 '+r.id+'"></i>':"";i+="<li>"+o+r.value+"</li>"}n.html(i)}),e("#header-customize-groups-link").click(function(){t.switchToTab("access",function(e){return"function"==typeof e[0].contentWindow.ProfileAccessTab}).then(function(e){e[0].contentWindow.$("#form-customize-groups",e[0].contentWindow.body).is(":not(:visible)")&&e[0].contentWindow.$("#open-customize-groups",e[0].contentWindow.body).click()})})},Profile.prototype.switchToTab=function(t,i){function a(){var l=n.children().filter(function(){return t==e(this).data("tab-id")}).first();try{if(!l[0].contentWindow||!i(l))return;setTimeout(function(){o.resolve(l)},0),r.off("tab_content_updated",a),s&&clearInterval(s),s=null}catch(d){}}var n=this.$wrapper.find(".t-profile-tabs-iframes"),r=this.$wrapper.find('.t-tab a[data-tab-id="'+t+'"]'),o=e.Deferred();r.on("tab_content_updated",a);var s=setInterval(a,100);return r.closest(".t-tab").hasClass("is-selected")?a():r.click(),e("html, body").animate({scrollTop:r.offset().top},500),o.promise()},Profile.prototype.changeTab=function(e){if(this.api_enabled){var t=e.data("tab-id"),i=window.location.href.match(/^.*\/(id|u)\/[^\/]+/);if(!i||!t)return;var a=i[0]+"/"+t+"/";history.replaceState({reload:!0,content_uri:a},"",a)}},Profile.prototype.calendarToggle=function(e){var t=this,i="is-short",a=e.find(".t-calendar-toggle .text"),n=t.$calendarPlace.hasClass(i);n?(a.text(e.data("hide-text")),t.$calendarPlace.removeClass(i)):(a.text(e.data("show-text")),t.$calendarPlace.addClass(i))},Profile.prototype.showOuterDialogDialog=function(){function t(){e.post(a,n,function(e){new TeamDialog({html:e,onRefresh:t})}).always(function(){i.is_locked=!1})}var i=this,a="?module=schedule&action=settings",n={};i.user.id>0&&(a+="&id="+i.user.id),i.is_locked||(i.is_locked=!0,t())},Profile.prototype.initEditableJobtitle=function(){var t=this,i=t.$wrapper.find(".js-jobtitle-editable").first();i.length&&new TeamEditable({$wrapper:i,onSave:function(i){var a=i.$field.val(),n=!a.length;if(i.text!==a){var r=e.team.app_url+"?module=profile&action=save",o={id:t.user.id,data:JSON.stringify({jobtitle:a})};i.$field.attr("disabled",!0);var s=e('<i class="icon16 loading"></i>').css("margin","0 0 0 4px").insertAfter(i.$field);e.post(r,o,function(){i.$field.attr("disabled",!1),s.remove(),i.is_empty=n,i.text=a,i.$wrapper.text(a),i.toggle("hide"),n&&i.$wrapper.parent().find(".at").hide()})}else i.toggle("hide")}})},Profile}(jQuery),ActivityLazyLoading=function(e){return ActivityLazyLoading=function(t){var i=this;i.list_name=t.names.list,i.items_name=t.names.items,i.pagind_name=t.names.paging,i.user_id=t.user_id,i.$wrapper=t.$wrapper||!1,i.$list=i.$wrapper.find(i.list_name),i.$window=e(window),i.onLoad=t.onLoad||function(){},i.$paging=i.$wrapper.find(i.pagind_name),i.xhr=!1,i.is_locked=!1,i.addWatcher()},ActivityLazyLoading.prototype.addWatcher=function(){function t(){var n=window&&e.contains(document,i.$paging[0]);n&&a&&window.frameElement&&(n=e.contains(a.document,window.frameElement)),n?i.onScroll():(i.$window.off("scroll",t),e(a).off("scroll",t))}var i=this,a=window.parent;i.$window.on("scroll",t),a&&window.frameElement&&e(a).on("scroll",t)},ActivityLazyLoading.prototype.onScroll=function(){var t=this,i=t.$window,a=i.scrollTop(),n=i.height(),r=t.$paging.offset().top;if(window.parent&&window.frameElement){var o=e(window.parent);n=o.height(),a+=o.scrollTop(),r+=e(window.frameElement).offset().top}a+n>=r&&(t.is_locked||(t.is_locked=!0,t.loadNextPage()))},ActivityLazyLoading.prototype.loadNextPage=function(){var t=this,i=e.team.app_url+"?module=profile&action=activity",a={max_id:t.$paging.data("max-id"),id:t.user_id,timestamp:t.$list.find(t.items_name).last().data("timestamp")};t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(i){var a=e(i),n=a.find(t.list_name+" "+t.items_name),r=a.find(t.pagind_name);t.$list.append(n),t.$paging.after(r),t.$paging.remove(),t.$paging=r,t.is_locked=!1,t.onLoad()})},ActivityLazyLoading}(jQuery),OutsideCalendarsDialog=function(e){return OutsideCalendarsDialog=function(e){var t=this;t.$dialogWrapper=e.$wrapper,t.$wrapper=t.$dialogWrapper.find(".t-dialog-block"),t.$form=t.$wrapper.find("form"),t.is_locked=!1,t.xhr=!1,t.initClass()},OutsideCalendarsDialog.prototype.initClass=function(){var e=this;e.bindEvents()},OutsideCalendarsDialog.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".t-external-calendar-unmount",function(){t.deleteExternalCalendar(e(this).data("id"))}),t.$wrapper.find(".js-add-external-calendar").on("click",function(i){i.preventDefault(),t.close();var a=e(this).attr("href");a&&e.team.content.load(a)})},OutsideCalendarsDialog.prototype.deleteExternalCalendar=function(t){e.get("?module=calendarExternal&action=DeleteConfirm",{id:t},function(t){new TeamDialog({html:t,onOpen:function(t){t.bind("afterDelete",function(){e.team.content.reload()})}})})},OutsideCalendarsDialog.prototype.close=function(){var e=this;e.$wrapper.trigger("close")},OutsideCalendarsDialog}(jQuery),ProfileStatistic=function(e){var t=function(e){function i(e,t){var i=e.offsetWidth,a=e.offsetHeight;return{outer_width:i,outer_height:a,inner_width:i-t.left-t.right,inner_height:a-t.top-t.bottom}}function a(e,t){function i(e){var t=e.split("-"),i=parseInt(t[0]),a=parseInt(t[1])-1,n=parseInt(t[2]);return new Date(i,a,n)}for(var a=[],n=0;n<e.length;n++){for(var r=e[n].data,o=[],s=0;s<r.length;s++){var l=r[s],d=t&&e[n].id!==t?0:parseInt(l.value);o.push({date:i(l.date),value:d})}a.push(o)}var c=d3.layout.stack().offset("zero").values(function(e){return e}).x(function(e){return e.date}).y(function(e){return e.value});return c(a)}function n(e,t,i){var a=null;if(i+=1,e&&i){var n=t*(i-1);a=(e-n)/i,0>a&&(a=0)}return a}function r(e,t){for(var i=t[0],a=t[1]||1,n=a-i,r=n/(e-1),o=[],s=0;e>s;s++){var l=parseInt(s*r*10)/10;o.push(l)}return o}return t=function(e){var t=this;t.app_id=e.app_id,t.$wrapper=e.$wrapper,t.$hint=t.$wrapper.find(".t-hint-wrapper"),t.node=t.$wrapper.find(".t-graph")[0],t.d3node=d3.select(t.node),t.show_class="is-shown",t.charts=e.data,t.data=a(t.charts,t.app_id),t.margin={top:14,right:10,bottom:28,left:34},t.area=i(t.node,t.margin),t.column_indent=4,t.column_width=n(t.area.inner_width,t.column_indent,t.data[0].length),t.svg=!1,t.defs=!1,t.x=!1,t.y=!1,t.xDomain=!1,t.yDomain=!1,t.initGraph()},t.prototype.initGraph=function(){var e=this,t=e.area;e.initGraphCore(),e.svg=e.d3node.append("svg").attr("width",t.outer_width).attr("height",t.outer_height),e.renderBackground(),e.renderCharts(),e.renderAxis()},t.prototype.initGraphCore=function(){function e(){var e=d3.min(a,function(e){return d3.min(e,function(e){return e.value})});e>0&&(e=0);var t=d3.max(a,function(e){return d3.max(e,function(e){return e.value+e.y0})});return[e,t]}function t(){var e,t,i=a[0].length,n=a[0][0].date,r=a[0][1].date,o=a[0][i-1].date,s=parseInt((r.getTime()-n.getTime())/2);return e=new Date(n.getTime()-s),t=new Date(o.getTime()+s),[e,t]}var i=this,a=i.data,n=i.area,r=i.x=d3.time.scale().range([0,n.inner_width]),o=i.y=d3.scale.linear().range([n.inner_height,0]);i.yDomain=e(),i.xDomain=t(),r.domain(i.xDomain),o.domain(i.yDomain)},t.prototype.renderAxis=function(){var e=this,t=e.x,i=e.y,a=e.svg,n=d3.svg.axis().scale(t).orient("bottom").ticks(10),o=d3.svg.axis().scale(i).innerTickSize(2).orient("right").tickValues(r(6,e.yDomain)).tickFormat(function(e){return e+""}),s=a.append("g").attr("class","axis");s.append("g").attr("transform","translate(10,"+e.margin.top+")").attr("class","y").call(o),s.append("g").attr("class","x").attr("transform","translate("+e.margin.left+","+(e.area.outer_height-e.margin.bottom)+")").call(n)},t.prototype.renderBackground=function(){var e,t=this,i=t.area.inner_width,a=t.area.inner_height,n=5,r=t.svg.append("g").attr("class","background").attr("transform","translate("+t.margin.left+","+t.margin.top+")");for(r.append("rect").attr("width",i).attr("height",a),e=0;n>=e;e++){var o=1+(a-2)/n*e;r.append("line").attr("x1",1).attr("x2",i).attr("y1",o).attr("y2",o)}},t.prototype.renderCharts=function(){function e(e,t,i){a.showHint(d3.event,this,e,a.charts[i])}function t(){a.moveHint(this)}function i(){a.hideHint()}var a=this,n=a.svg,r=a.data,o=n.selectAll(".t-graph-wrapper").data(r);o.enter().append("g").attr("class","t-graph-wrapper").attr("transform","translate("+a.margin.left+","+a.margin.top+")");var s=o.selectAll(".rect").data(function(e){return e});s.enter().append("rect").attr("class","rect").style("fill",function(e,t,i){var n=a.charts[i].color;return n?n:!1}).on("mouseover",e).on("mousemove",t).on("mouseout",i),s.transition().duration(1e3).attr("x",function(e,t){return a.x(e.date)-a.column_width/2}).attr("y",function(e){return a.y(e.y0)+a.y(e.value)-a.area.inner_height}).attr("height",function(e){return a.area.inner_height-a.y(e.value)}).attr("width",a.column_width),s.exit().remove(),o.exit().remove()},t.prototype.update=function(e){var t=this;t.data=a(t.charts,e),t.initGraphCore();var i=d3.svg.axis().scale(t.y).innerTickSize(2).orient("right").tickValues(r(6,t.yDomain)).tickFormat(function(e){return e+""});t.svg.selectAll(".axis .y").call(i),t.renderCharts()},t.prototype.showHint=function(t,i,a,n){function r(t){var i=e(window),a=i.width(),n=(i.height(),o.$hint.outerWidth()),r=o.$hint.outerHeight(),s=Math.ceil(t.attr("width")),l=Math.ceil(t.attr("height")),d=2,c=10,u=o.$wrapper.offset(),p=t.offset(),f={left:p.left-u.left+s+c,top:p.top-u.top+(r>l?l-r-d:d)};return a<f.left+n&&(f.left=p.left-(n+c)),f}var o=this,s=e(i),l=Math.ceil(s.attr("height")),d=l>0;if(!d)return!1;var c=a.date,u=o.$hint.find(".t-date"),p=o.$hint.find(".t-app"),f=o.$hint.find(".t-value"),h=c.getMonth()+1;h=10>h?"0"+h:h;var m=c.getDate();m=10>m?"0"+m:m,u.text(m+"."+h+"."+c.getFullYear()),p.text(n.name),f.text(a.value);var v=r(s);o.$hint.css(v).addClass(o.show_class)},t.prototype.moveHint=function(){},t.prototype.hideHint=function(){var e=this;e.$hint.removeAttr("style").removeClass(e.show_class)},t}(jQuery);return ProfileStatistic=function(e){var t=this;t.$wrapper=e.$wrapper,t.$graphWrapper=t.$wrapper.find("#t-graph-wrapper"),t.$header=t.$wrapper.find(".t-header-wrapper"),t.$filters=t.$header.find(".t-filters"),t.graphData=e.graphData,t.app_url=e.app_url,t.app_id=e.app_id,t.group_by=e.group_by,t.timeframe=e.timeframe,t.start_date=e.start_date,t.end_date=e.end_date,t.loading_class="is-loading",t.contact_id=e.contact_id,t.graph=!1,t.xhr=!1,t.initClass()},ProfileStatistic.prototype.initClass=function(){var e=this;e.bindEvents(),e.initGraph(),e.initDatePicker()},ProfileStatistic.prototype.bindEvents=function(){var t=this;t.$filters.on("click",".dropdown .menu-v a",function(i){i.preventDefault(),t.setFilter(e(this))}),t.$filters.on("click",".t-period-filter .menu-v a",function(i){i.preventDefault(),t.changePeriod(e(this))}),t.$filters.on("click",".t-app-filter .menu-v a",function(i){i.preventDefault();var a=e(this).data("app-id");t.changeApp(a?a:!1)}),t.$filters.on("click",".js-set-custom-period",function(i){i.preventDefault(),t.changeCustomPeriod(e(this).closest("form"))})},ProfileStatistic.prototype.initGraph=function(){function i(t){function i(e,t){var i=e.split("-"),a=parseInt(i[0]),n=parseInt(i[1])-1,r=parseInt(i[2]),o=864e5,s=new Date(new Date(a,n,r).getTime()+(t?o:-o)),l=parseInt(s.getFullYear()),d=parseInt(s.getMonth())+1,c=parseInt(s.getDate());return 10>c&&(c="0"+c),10>d&&(d="0"+d),[l,d,c].join("-")}var a=t[0].data.length;return 1===a&&e.each(t,function(e){var a=t[e].data[0],n={value:0,date:i(a.date,!1)},r={value:0,date:i(a.date,!0)};t[e].data=[n,a,r]}),t}var a=this;a.$graphWrapper.length&&a.graphData&&a.graphData.length&&(a.graph=new t({$wrapper:a.$graphWrapper,data:i(a.graphData),app_id:a.app_id}))},ProfileStatistic.prototype.initDatePicker=function(){var t=this,i=t.$wrapper.find(".js-datepicker");i.each(function(){var t=e(this),i=t.parent().find("input[type='hidden']");t.datepicker({altField:i,altFormat:"yy-mm-dd"})})},ProfileStatistic.prototype.changeApp=function(e){var t=this;t.app_id=e?e:!1,t.graph.update(t.app_id)},ProfileStatistic.prototype.setFilter=function(e){var t=e.closest("li"),i=t.closest(".menu-v"),a=i.closest(".dropdown"),n=a.find(".t-selected-item"),r="selected";i.find("."+r).removeClass(r),t.addClass(r),e.trigger("set"),i.hide(),setTimeout(function(){i.removeAttr("style")},500),n.html(e.html())},ProfileStatistic.prototype.changePeriod=function(t){var i=this,a=t.closest(".t-period-filter").find(".t-hidden-part"),n="js-show-period-form",r=!t.hasClass(n),o="is-shown",s=i.loading_class;if(r){a.removeClass(o);var l=i.app_url+"?module=profile&action=stats",d={is_update:!0,id:i.contact_id};t.data("timeframe")&&t.data("groupby")&&(d.timeframe=i.timeframe=t.data("timeframe"),d.groupby=i.group_by=t.data("groupby")),i.app_id&&(d.app_id=i.app_id),i.xhr&&(i.xhr.abort(),i.xhr=!1),i.$wrapper.addClass(s),i.xhr=e.post(l,d,function(e){i.$wrapper.replaceWith(e)})}else a.addClass(o)},ProfileStatistic.prototype.changeCustomPeriod=function(t){function i(t){function i(e,t){var i=a(e),n=a(t),r=Math.abs(n.getTime()-i.getTime()),o=864e5,s=92;return r>s*o}function a(e){var t=e.split("-"),i=parseInt(t[0]),a=parseInt(t[1])-1,n=parseInt(t[2]);return new Date(i,a,n)}var n,r,o,s;if(e.each(t,function(e,t){var i=t.name;"from"==i&&(n=t.value),"to"==i&&(r=t.value),"groupby"==i&&(s=e,o=t.value)}),"days"==o&&s>=0){var l=i(n,r);l&&(t[s].value="months")}return t}var a=this,n=a.app_url+"?module=profile&action=stats",r=t.serializeArray();r.push({name:"is_update",value:!0}),r.push({name:"id",value:a.contact_id}),r.push({name:"timeframe",value:"custom"}),a.app_id&&r.push({name:"app_id",value:a.app_id}),i(r),a.xhr&&(a.xhr.abort(),a.xhr=!1),a.$wrapper.addClass(a.loading_class),a.xhr=e.post(n,r,function(e){a.$wrapper.replaceWith(e)})},ProfileStatistic.prototype.update=function(){},ProfileStatistic}(jQuery),SettingsPage=function(e){return SettingsPage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$calendarToggle=t.$wrapper.find("#t-calendar-settings"),t.$mapToggle=t.$wrapper.find("#t-map-toggle"),t.$form=t.$wrapper.find("form"),t.$submitButton=t.$form.find('input[type="submit"]'),t.locales=e.locales,t.$notice=!1,t.is_locked=!1,t.is_form_changed=!1,t.xhr=!1,t.initClass()},SettingsPage.prototype.initClass=function(){var e=this;e.bindEvents(),e.initSortable()},SettingsPage.prototype.bindEvents=function(){function t(){i.is_form_changed||(i.is_form_changed=!0,i.$submitButton.removeClass("green").addClass("yellow"))}var i=this;i.$calendarToggle.on("click",".js-edit-calendar",function(t){t.preventDefault();var a=parseInt(e(this).closest(".t-calendar-item").data("id"));
a&&i.showEditDialog(a)}),i.$calendarToggle.on("click",".js-add-calendar",function(e){e.preventDefault(),i.showEditDialog()}),i.$mapToggle.on("change","input:radio",function(){var t=e(this),a="checked"==t.attr("checked");if(a){i.$mapToggle.find(".t-hidden-content").hide();var n=t.closest("li").find(".t-hidden-content");n.length&&n.show()}}),i.$form.on("submit",function(e){e.preventDefault(),i.is_form_changed&&i.save(i.$form)}),i.$form.on("change","input, select, textarea",t)},SettingsPage.prototype.initSortable=function(){var e,t=this;t.$calendarToggle.find("ul").sortable({handle:".t-toggle",items:"> .t-calendar-item",axis:"y",start:function(i,a){e=a.item.index(),t.$notice&&(t.$notice.remove(),t.$notice=!1)},stop:function(i,a){e!=a.item.index()&&t.saveCalendarsSort(a)}})},SettingsPage.prototype.showEditDialog=function(t){var i=this,a=e.team.app_url+"?module=calendar",n={};t&&(n.id=t),i.xhr&&(i.xhr.abort(),i.xhr=!1),i.xhr=e.post(a,n,function(e){i.dialog=new TeamDialog({html:e})})},SettingsPage.prototype.saveCalendarsSort=function(t){function i(){var t=[],i=r.$calendarToggle.find(".t-calendar-item");return i.each(function(){var i=e(this),a=i.data("id");a&&a>0&&t.push(a)}),t}function a(t){var i=r.locales.saving||"",a=e('<span class="t-notice"><i class="icon16 loading"></i>'+i+"</span>");return a.appendTo(t),a}function n(t){var i=r.locales.saved||"",a=e('<span class="t-notice"><i class="icon16 yes"></i>'+i+"</span>");return a.appendTo(t),a}var r=this,o=t.item,s=e.team.app_url+"?module=settings&action=calendarsSortSave",l={calendars:i()};r.xhr&&(r.xhr.abort(),r.xhr=!1),r.$notice=a(o),r.xhr=e.post(s,l,function(t){r.$notice.remove(),r.$notice=n(o),setTimeout(function(){r.$notice&&e.contains(document,r.$notice[0])&&r.$notice.remove()},1e3),r.xhr=!1})},SettingsPage.prototype.save=function(t){var i=this,a=e.team.app_url+"?module=settings&action=save",n=t.serializeArray(),r=e('<i class="icon16 loading" style="margin: 0 4px;"></i>');r.insertAfter(i.$submitButton),i.is_locked||(i.is_locked=!0,e.post(a,n,function(t){i.is_form_changed=!1,i.$submitButton.removeClass("yellow").addClass("green"),"ok"===t.status&&("google"===t.data.map_provider?e.getScript("https://maps.googleapis.com/maps/api/js?sensor=false&key="+t.data.google_map_key+"&lang="+t.data.lang):"yandex"===t.data.map_provider&&e.getScript("https://api-maps.yandex.ru/2.1/?lang="+t.data.lang))}).always(function(){r.remove(),i.is_locked=!1}))},SettingsPage}(jQuery),CalendarEditDialog=function(e){return CalendarEditDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.$form=t.$block.find("form"),t.$styleWrapper=t.$block.find(".t-style-wrapper"),t.$limitedToggle=t.$block.find(".t-limited-toggle"),t.$nameField=t.$block.find('input[name="data[name]"]'),t.calendar_id=e.calendar_id,t.selected_class="is-selected",t.hidden_class="is-hidden",t.has_error_class="error",t.locales=e.locales,t.teamDialog=t.$wrapper.data("teamDialog"),t.$selectedStyleButton=t.$styleWrapper.find("."+t.selected_class),t.is_locked=!1,t.xhr=!1,t.initClass()},CalendarEditDialog.prototype.initClass=function(){var e=this;e.bindEvents(),e.initColorPicker()},CalendarEditDialog.prototype.bindEvents=function(){var t=this;t.$block.on("click",".js-delete-calendar",function(e){e.preventDefault(),t.is_locked||t.showDeleteConfirm()}),t.$styleWrapper.on("click",".t-style-item",function(i){i.preventDefault(),t.setStyleToggle(e(this))}),t.$form.on("submit",function(e){e.preventDefault(),t.locked||t.save()}),t.$form.on("change",".t-color-field",function(){t.$selectedStyleButton.length&&(t.$selectedStyleButton.removeClass(t.selected_class),t.$selectedStyleButton=!1)});var i=t.$form.find("input, textarea");i.on("mousedown",function(){var i=e(this),a=i.hasClass(t.has_error_class);a&&i.removeClass(t.has_error_class).closest(".value").find(".t-error").remove()}),t.$nameField.on("change keyup",function(){var i=e(this).val();i=i.length?i:t.locales.preview,t.setPreviewName(i)}),t.$limitedToggle.on("change","input:radio",function(){var i=t.$limitedToggle.find(".t-hidden-content");e(this).val().length?i.show():i.hide(),t.teamDialog.resize()})},CalendarEditDialog.prototype.setStyleToggle=function(e){var t=this,i=e.css("background-color"),a=e.css("color");t.$selectedStyleButton.length&&t.$selectedStyleButton.removeClass(t.selected_class),t.setStyleData(i,a),e.addClass(t.selected_class),t.$selectedStyleButton=e},CalendarEditDialog.prototype.setStyleData=function(e,t){function i(e){var t,i;return t=e.split("(")[1].split(")")[0],t=t.split(",").splice(0,3),i=t.map(function(e){return e=parseInt(e).toString(16),1==e.length?"0"+e:e}),"#"+i.join("")}var a=this;e=i(e),t=i(t),a.$form.find('[name="data[bg_color]"]').val(e).trigger("change"),a.$form.find('[name="data[font_color]"]').val(t).trigger("change")},CalendarEditDialog.prototype.showDeleteConfirm=function(){var t=this,i="?module=calendar&action=deleteConfirm",a={id:t.calendar_id};t.is_locked=!0,t.xhr&&(t.xhr.abort(),t.xhr=!1),t.xhr=e.get(i,a,function(e){new TeamDialog({html:e}),t.is_locked=!1,t.$wrapper.trigger("close")})},CalendarEditDialog.prototype.initColorPicker=function(){var t=this,i=function(e){return i=function(e){var t=this;t.$wrapper=e.$wrapper,t.$field=t.$wrapper.find(".t-color-field"),t.$icon=t.$wrapper.find(".js-show-color-picker"),t.$colorPicker=t.$wrapper.find(".t-color-picker"),t.is_opened=!1,t.farbtastic=!1,t.initClass()},i.prototype.initClass=function(){var t=this;t.farbtastic=e.farbtastic(t.$colorPicker,function(e){t.$field.val(e).change()}),t.$wrapper.data("colorPicker",t),t.bindEvents()},i.prototype.bindEvents=function(){function i(){a.$wrapper.siblings().each(function(){var t=e(this).data("colorPicker");t&&t.is_opened&&t.displayToggle(!1)})}var a=this;a.$field.on("change keyup",function(){var t=e(this).val();a.$icon.css("background-color",t),a.farbtastic.setColor(t)}),a.$icon.on("click",function(e){e.preventDefault(),i(),a.displayToggle(!a.is_opened)}),a.$wrapper.on("click",function(e){e.preventDefault(),e.stopPropagation()}),a.$field.on("focus",function(){a.is_opened||(i(),a.displayToggle(!0))});var n=t.$wrapper.find(".t-dialog-background");n.on("click",function(){a.is_opened&&a.displayToggle(!1)}),t.$block.on("click",function(){a.is_opened&&a.displayToggle(!1)})},i.prototype.displayToggle=function(e){var t=this,i="is-hidden",a=t.$colorPicker;e?(a.removeClass(i),t.is_opened=!0):(a.addClass(i),t.is_opened=!1)},i}(jQuery);t.$styleWrapper.find(".t-color-toggle .t-toggle").each(function(){new i({$wrapper:e(this)})})},CalendarEditDialog.prototype.setPreviewName=function(e){var t=this;t.$styleWrapper.find(".t-style-item").text(e)},CalendarEditDialog.prototype.save=function(){function t(t){function a(t){i.$form.find(".t-error").remove(),e.each(t,function(e,t){var a=i.$form.find("[name='"+t.field+"']");a.length&&a.addClass(i.has_error_class).after('<span class="t-error">'+i.locales[t.locale]+"</span>")})}var n={},r=[];return e.each(t,function(e,t){n[t.name]=t.value}),n["data[is_limited]"]||delete n["data[is_limited]"],e.trim(n["data[name]"]).length||r.push({field:"data[name]",locale:"empty"}),r.length?(a(r),!1):n}var i=this,a="?module=calendar&action=save",n=t(i.$form.serializeArray());i.is_locked||(i.is_locked=!0,n?e.post(a,n,function(t){"ok"==t.status&&(e.team.content.reload(),e.team.sidebar.reload(),i.is_locked=!1)}):i.is_locked=!1)},CalendarEditDialog}(jQuery),CalendarDeleteDialog=function(e){return CalendarDeleteDialog=function(e){var t=this;t.$wrapper=e.$wrapper,t.$block=t.$wrapper.find(".t-dialog-block"),t.calendar_id=e.calendar_id,t.is_locked=!1,t.initClass()},CalendarDeleteDialog.prototype.initClass=function(){var e=this;e.$block.on("click",".js-delete-calendar",function(t){t.preventDefault(),e.is_locked||e["delete"]()})},CalendarDeleteDialog.prototype["delete"]=function(){var t=this,i="?module=calendar&action=delete",a={id:t.calendar_id};t.is_locked=!0,e.post(i,a,function(i){"ok"==i.status&&(e.team.content.reload(),t.$wrapper.trigger("close"))},"json")},CalendarDeleteDialog}(jQuery),Sidebar=function(e){var t=function(){return t=function(t){var i=this;i.$window=e(window),i.$wrapper=t.$wrapper,i.$block=t.$block,i.$content=t.$content,i.top_fix_class="fixed-to-top",i.bottom_fix_class="fixed-to-bottom",i.debug=!1,i.initClass()},t.prototype.log=function(e){var t=this;t.debug&&console.log(e)},t.prototype.initClass=function(){function t(){e.contains(document,w[0])?d():a()}function i(){e.contains(document,w[0])?u():n()}function a(){v.off("scroll",t)}function n(){v.off("scroll",i)}function r(e){f.log("Manual top scroll position"),w.css("top",e).width(p).removeClass(h).removeClass(m),E=!0,x=D=C=!1}function o(e){f.log("Fixed to top scroll position"),w.removeAttr("style").width(p).removeClass(m).addClass(h),e&&(C=!0,w.css("top",e)),E=D=!1,x=!0}function s(){f.log("Fixed to bottom scroll position"),w.removeAttr("style").width(p).removeClass(h).addClass(m),E=x=C=!1,D=!0}function l(){f.log("Default scroll position"),w.removeAttr("style").removeClass(m).removeClass(h),E=x=D=C=!1}function d(){var e=Math.floor(f.$content.outerHeight()),t=Math.floor(w.outerHeight()),i=Math.floor(g.height()),a=v.scrollTop(),n=Math.floor(w.offset().top),d=T>a?1:-1,u=a-$,h=760;p=w.width();var m=!k&&i>_&&y>=h&&!(e&&t>e);if(m){var S=_>t+b,V=$>=a,M=parseInt(n+t-a-_),F=M>0,P=0>=M;if(S)u+b>0?(E||D||!x)&&o(b):(E||x||D||C)&&l();else if(V){if(E||D||x)if(C){var I=$>=n;I&&l()}else l()}else if(F)if(d>0){var j=n>=b+a;j&&(E||!x||D)&&(b?o(b):o())}else(!E||x||D)&&r(n-$);else P?d>0?(!E||x||D)&&r(n-$):(E||x||!D)&&s():(!E||x||D)&&r(n-$)}else k?c(a,t):l();T=a}function c(e,t){var i=Math.floor(g.height()),a=Math.floor(g.offset().top),n=i+a-_-e,r=t-_;k=!1;var l=i>t&&e>$;l&&(n>r?o(b):s())}function u(){y=Math.floor(v.width()),_=Math.floor(v.height()),l(),v.trigger("scroll")}var p,f=this,h=f.top_fix_class,m=f.bottom_fix_class,v=f.$window,g=f.$wrapper,w=f.$block,y=Math.floor(v.width()),_=Math.floor(v.height()),$=w.offset().top,b=0,k=!0,E=!1,D=!1,x=!1,C=!1,T=0;v.on("scroll",t).on("resize",i)},t}();return Sidebar=function(e){var t=this;t.$wrapper=e.$wrapper,t.$groupsWrapper=t.$wrapper.find(".t-groups-list"),t.$groups=t.$groupsWrapper.find("> li"),t.$locationsWrapper=t.$wrapper.find(".t-locations-list"),t.$locations=t.$locationsWrapper.find("> li"),t.$searchForm=t.$wrapper.find(".t-search-form"),t.app_url=e.app_url,t.selected_class="selected",t.storage_count_name="team/sidebar_counts",t.can_sort=e.can_sort,t.link_count_update_date=!1,t.$activeMenuItem=t.$wrapper.find("li."+t.selected_class+":first")||!1,t.counters={},t.storageCount=!1,t.is_locked=!1,t.xhr=!1,t.timer=0,t.initClass()},Sidebar.prototype.initClass=function(){var e=this;e.bindEvents(),e.setCounts(),e.initElasticBlock(),e.initUpdater(),e.can_sort&&e.initSortable(),e.initDroppable(),e.$activeMenuItem.length||e.selectLink()},Sidebar.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click","li > a",function(i){t.onLinkClick(e(this))}),t.$wrapper.on("click",".js-add-user-group",function(e){e.preventDefault(),t.showGroupDialog()}),t.$wrapper.on("click",".js-add-user-location",function(e){e.preventDefault(),t.showGroupDialog(!0)}),t.$searchForm.on("submit",function(i){i.preventDefault();var a=e.trim(t.$searchForm.find(".t-search-field").val());a&&t.showSearch(a)}),e("#t-new-user-link").on("click",function(e){e.preventDefault(),e.stopPropagation(),t.showInviteDialog()})},Sidebar.prototype.onLinkClick=function(t){var i=this,a=t.attr("href");a&&"javascript:"!=a.substr(0,11)&&!t.hasClass("js-no-highlight")&&(i.setItem(t.closest("li")),e.team.setTitle(t.text()))},Sidebar.prototype.setItem=function(e){var t=this;return t.$activeMenuItem&&t.$activeMenuItem[0]==e[0]?!1:(t.$activeMenuItem&&t.$activeMenuItem.removeClass(t.selected_class),e.addClass(t.selected_class),void(t.$activeMenuItem=e))},Sidebar.prototype.selectLink=function(t){var i,a=this;if(t&&(i=a.$wrapper.find('a[href="'+t+'"]:first')),i&&i.length)a.setItem(i.closest("li"));else{var n=a.$wrapper.find("a[href^='"+a.app_url+"']"),r=location.pathname,o=0,s=0;n.each(function(t){var i=e(this),a=i.attr("href"),n=a.length;r.indexOf(a)>=0&&n>o&&(o=n,s=t)}),(s||0===s)&&(i=n.eq(s),a.setItem(i.closest("li")))}},Sidebar.prototype.reload=function(){var t=this,i=t.app_url,a=i+"?module=sidebar";clearTimeout(t.timer),t.xhr&&t.xhr.abort(),t.xhr=e.get(a,function(e){t.xhr=!1,t.$wrapper.replaceWith(e)})},Sidebar.prototype.showInviteDialog=function(){var t=this;t.is_locked||(t.is_locked=!0,e.get(e.team.app_url+"?module=users&action=inviteform",function(e){t.is_locked=!1,new TeamDialog({html:e})}))},Sidebar.prototype.showGroupDialog=function(t){var i=this,a=e.team.app_url+"?module=group&action=edit",n={type:t?"location":"group"};i.is_locked||(i.is_locked=!0,e.get(a,n,function(e){new TeamDialog({html:e}),i.is_locked=!1}))},Sidebar.prototype.setCounts=function(){function t(t,i,a,n){var o=t.indexOf(r.app_url)>=0;if(o){var s=r.$wrapper.find('a[href="'+t+'"]');if(s.length){var l=i-a,d=e('<strong class="small highlighted t-indicator '+(l>=0?"is-green":"is-red")+'">'+l+"</strong>");l>=0&&(s.append(d),s.one("click",function(a){a.preventDefault(),d.remove(),r.saveCount(t,i),r.link_count_update_date=n,e(document).one("wa_loaded",function(){r.link_count_update_date=!1})}))}}}function i(e){var t={},i=localStorage.getItem(e);return i&&(t=JSON.parse(i)),t}function a(){var t={},i=r.$wrapper.find("li .js-count"),a=n();return i.each(function(){var i=e(this),n=parseInt(i.text()),o=i.closest("li"),s=o.find("> a");n>=0&&(r.counters[s.attr("href")]=i,t[s.attr("href")]={count:n,date:a})}),t}function n(){var e=new Date,t=parseInt(e.getUTCDate()),i=parseInt(e.getUTCMonth())+1,a=parseInt(e.getUTCFullYear()),n=parseInt(e.getUTCHours()),r=parseInt(e.getUTCMinutes()),o=parseInt(e.getUTCSeconds());return result={year:a,month:i,day:t,hours:n,minutes:r,seconds:o}}var r=this,o=a(),s=i(r.storage_count_name);r.storageCount=e.extend(!0,{},o),s&&e.each(s,function(e,i){var a=e in o,n=a&&o[e].count>=0,s=n&&o[e].count!=i.count,l=i.count>=0;l&&s&&(r.storageCount[e].count=i.count,r.storageCount[e].date=i.date,t(e,o[e].count,i.count,i.date))}),r.setStorage()},Sidebar.prototype.saveCount=function(e,t){var i=this;e in i.storageCount&&(i.storageCount[e].count=t),i.setStorage()},Sidebar.prototype.updateCount=function(e,t){var i,a=this;return!e||!t&&0!==t?!1:(i=a.counters[e]||!1,a.saveCount(e,t),void(i.length?i.text(t):a.reload()))},Sidebar.prototype.setStorage=function(){var e=this;localStorage.setItem(e.storage_count_name,JSON.stringify(e.storageCount))},Sidebar.prototype.initElasticBlock=function(){var i=this;e(document).ready(function(){new t({$wrapper:e("#wa-app"),$block:i.$wrapper,$content:e("#t-content")});var a=e(window);a.scrollTop()>0&&a.trigger("scroll")})},Sidebar.prototype.initUpdater=function(){var t=this,i=3e5;t.timer=setTimeout(function(){e.contains(document,t.$wrapper[0])&&t.reload()},i)},Sidebar.prototype.initSortable=function(){function t(t){var i=[],a=t.find("> li");return a.each(function(){var t=e(this),a=t.data("group-id");a&&a>0&&i.push(a)}),i}function i(t,i){c&&(c.abort(),c=!1),c=e.post(t,i,function(e){c=!1})}var a,n=this,r=n.$groupsWrapper,o=n.$groups,s=n.$locationsWrapper,l=n.$locations,d=e.team.app_url+"?module=group&action=sortSave",c=!1;o.length>1&&r.sortable({items:"> li",axis:"y",delay:200,tolerance:"pointer",start:function(e,t){a=t.item.index()},stop:function(e,n){if(n.item.removeAttr("style"),a!=n.item.index()){var o=t(r);i(d,{groups:o})}}}),l.length>1&&s.sortable({items:"> li",axis:"y",delay:200,tolerance:"pointer",start:function(e,t){a=t.item.index()},stop:function(e,n){if(n.item.removeAttr("style"),a!=n.item.index()){var r=t(s);i(d,{locations:r})}}})},Sidebar.prototype.initDroppable=function(){function t(t,i){var a,n=parseInt(t.data("group-id")),o=parseInt(i.data("user-id")),s=e.team.app_url+"?module=group&action=userAdd";return n>0&&o>0?(a={user_id:o,group_id:n},r&&r.abort(),void(r=e.post(s,a,function(t){"ok"==t.status&&e.team.sidebar.reload(),r=!1}))):!1}var i=this,a="js-drop-place",n="is-hovered",r=!1;i.$groups.each(function(){var i=e(this),r=i.hasClass(a);r&&i.droppable({tolerance:"pointer",hoverClass:n,over:function(e,t){var a=t.draggable.hasClass("ui-draggable");a||i.removeClass(n)},drop:function(i,a){t(e(this),a.draggable)}})}),i.$locations.each(function(){var i=e(this),r=i.hasClass(a);r&&i.droppable({tolerance:"pointer",hoverClass:n,over:function(e,t){var a=t.draggable.hasClass("ui-draggable");a||i.removeClass(n)},drop:function(i,a){t(e(this),a.draggable)}})})},Sidebar.prototype.showSearch=function(t){var i=this;t=encodeURIComponent(t);var a=i.app_url+"search/"+t+"/";e.team.content.load(a)},Sidebar}(jQuery);!function(e){e.team={app_url:!1,content:!1,sidebar:!1,calendar:!1,title_pattern:"Team — %s",setTitle:function(t){if(t){var i=history.state;i&&(i.title=t),document.title=e.team.title_pattern.replace("%s",t)}},confirmContactDelete:function(t,i){e.post("?module=users&action=prepareDelete",{id:t},function(e){var t=new TeamDialog({html:e});i&&i.onInit&&i.onInit(),i&&i.onCancel&&t.$wrapper.on("close",i.onCancel),(i.onCancel||i.onDelete)&&t.$wrapper.on("contacts_deleted",function(e,a){i&&i.onCancel&&t.$wrapper.off("close",i.onCancel),i&&i.onDelete&&i.onDelete(a)})})},setSync:function(t){function i(){console.log("send sync request"),e.post(e.team.app_url+"?module=calendarExternal&action=sync").always(function(){a=null,n=setTimeout(i,o)}).error(function(){return!1})}var a,n,r=Math.floor(100*Math.random())/100,o=3e4+3e4*r;t?i():setTimeout(i,o/2)}}}(jQuery);var ContentRouter=function(e){return ContentRouter=function(t){var i=this;i.$window=e(window),i.$content=t.$content,i.api_enabled=window.history&&window.history.pushState,i.xhr=!1,i.is_enabled=!0,i.initClass()},ContentRouter.prototype.initClass=function(){var e=this;e.bindEvents()},ContentRouter.prototype.bindEvents=function(){var t=this,i=window.location.origin+e.team.app_url;e(document).on("click","a",function(e){var a=t.is_enabled&&this.href.substr(0,i.length)==i;a&&(e.preventDefault(),t.load(this.href))}),t.api_enabled&&(window.onpopstate=function(e){e.stopPropagation(),t.onPopState(e)})},ContentRouter.prototype.load=function(t,i){var a=this,n=t.indexOf(e.team.app_url)>=0;return n?(a.animate(!0),a.xhr&&a.xhr.abort(),e(document).trigger("wa_before_load",{content_uri:t}),void(a.xhr=e.get(t,function(n){!i&&a.api_enabled&&history.pushState({reload:!0,content_uri:t},"",t),a.setContent(n),a.animate(!1),a.xhr=!1,e(document).trigger("wa_loaded")}))):(alert("Determine the path error"),!1)},ContentRouter.prototype.reload=function(){var e=this,t=e.api_enabled&&history.state&&history.state.content_uri?history.state.content_uri:!1;t&&e.load(t,!0)},ContentRouter.prototype.setContent=function(e){var t=this;t.$content.html(e)},ContentRouter.prototype.onPopState=function(t){var i=this,a=t.state||!1;if(a){if(!a.content_uri)return alert("Determine the path error"),!1;e(document).trigger("wa_before_load",{content_uri:a.content_uri}),a.reload?i.reload(a.content_uri):a.content&&i.setContent(a.content),a.title&&e.team.setTitle(a.title),e.team.sidebar.selectLink(a.content_uri),e(document).trigger("wa_loaded")}else location.reload()},ContentRouter.prototype.animate=function(t){var i=this,a=i.$content;if(e(".router-loading-indicator").remove(),t){var n=a.find(".t-content-header h1"),r='<i class="icon16 loading router-loading-indicator"></i>';n.length&&n.append(r)}},ContentRouter}(jQuery),TeamDialog=function(e){return TeamDialog=function(t){var i=this;i.$wrapper=e(t.html),i.$block=!1,i.is_full_screen=i.$wrapper.hasClass("is-full-screen"),i.is_full_screen&&(i.$block=i.$wrapper.find(".t-dialog-block")),i.position=t.position||!1,i.is_closed=!1,i.userPosition=t.setPosition||!1,i.onBgClick=t.onBgClick||!1,i.onOpen=t.onOpen||function(){},i.onClose=t.onClose||function(){},i.onRefresh=t.onRefresh||!1,i.onResize=t.onResize||!1,i.initClass()},TeamDialog.prototype.initClass=function(){var e=this;e.$wrapper.data("teamDialog",e),e.show(),e.bindEvents()},TeamDialog.prototype.bindEvents=function(){var t=this,i=e(document),a=t.$block?t.$block:t.$wrapper;setTimeout(function(){function n(){t.is_closed||t.close(),i.off("click",n),i.off("wa_before_load",n)}function r(){var i=e.contains(document,t.$wrapper[0]);i?t.resize():e(window).off("resize",r)}i.on("click",n),i.on("wa_before_load",n),t.$wrapper.on("close",n),t.is_full_screen&&t.$wrapper.on("click",".t-dialog-background",function(e){t.onBgClick?t.onBgClick(e):e.stopPropagation()}),a.on("click",function(e){e.stopPropagation()}),e(document).on("keyup",function(e){var i=27;e.keyCode===i&&t.close()}),a.on("click",".js-close-dialog",function(){n()}),t.is_full_screen&&e(window).on("resize",r)},0)},TeamDialog.prototype.show=function(){var t=this;e("body").append(t.$wrapper),t.setPosition(),t.onOpen(t.$wrapper,t)},TeamDialog.prototype.setPosition=function(){function t(e){return{left:parseInt((r-e.width)/2),top:parseInt((o-e.height)/2)}}var i,a=this,n=e(window),r=n.width(),o=a.is_full_screen?n.height():e(document).height(),s=a.$block?a.$block:a.$wrapper,l=s.outerWidth(),d=s.outerHeight(),c=10;if(a.position)i=a.position;else{var u=a.userPosition?a.userPosition:t;i=u({width:l,height:d})}if(i.left>0&&i.left+l>r&&(i.left=r-l-c),i.top>0)i.top+d>o&&(i.top=o-d-c);else if(i.top=c,a.is_full_screen){var p=s.find(".t-dialog-content");p.hide();var f=s.outerHeight(),h=o-f-2*c;p.height(h).addClass("is-long-content").show()}s.css(i)},TeamDialog.prototype.close=function(){var e=this;e.is_closed=!0,e.$wrapper.remove(),e.onClose(e.$wrapper,e)},TeamDialog.prototype.refresh=function(){var e=this;e.onRefresh&&(e.onRefresh(),e.close())},TeamDialog.prototype.resize=function(){var e=this,t="is-animated",i=!0;i&&e.$block.addClass(t),e.setPosition(),e.onResize&&e.onResize(e.$wrapper,e)},TeamDialog}(jQuery),TeamEditable=function(e){return TeamEditable=function(e){var t=this;t.$wrapper=e.$wrapper,t.save=e.onSave||function(){},t.render=e.onRender||!1,t.is_empty=t.$wrapper.hasClass("is-empty"),t.text=t.is_empty?"":t.$wrapper.text(),t.$field=!1,t.is_edit=!1,t.initClass()},TeamEditable.prototype.initClass=function(){var e=this;e.$field=e.renderField(),e.bindEvents()},TeamEditable.prototype.bindEvents=function(){var e=this;e.$wrapper.on("click",function(){e.toggle()}),e.$field.on("blur",function(){e.save(e)}),e.$field.on("keyup",function(t){var i=13===t.keyCode,a=27===t.keyCode;i?e.save(e):a&&(e.$field.val(e.text),e.toggle("hide"))})},TeamEditable.prototype.renderField=function(){var t=this,i=t.$wrapper.text(),a=e('<input class="bold" type="text" name="" />');t.is_empty||a.val(i);var n,r=t.$wrapper.parent().width(),o=t.$wrapper.width(),s=600;return n=r>s?s:r-50,n=o>n?o:n,a.width(n).hide(),t.$wrapper.after(a),t.render&&t.render(t,a),a},TeamEditable.prototype.toggle=function(e){var t=this,i="hide"!==e;i?(t.$wrapper.hide(),t.$field.show().focus()):(t.$wrapper.show(),t.$field.hide()),t.is_edit=i},TeamEditable}($),UserList=function(e){return UserList=function(e){var t=this;t.$wrapper=e.$wrapper,t.$items=t.$wrapper.find(".t-user-wrapper"),t.is_locked=!1,t.xhr=!1,t.initClass()},UserList.prototype.initClass=function(){var e=this;e.initHightlight(),e.bindEvents()},UserList.prototype.bindEvents=function(){var t=this,i=!1,a="t-drop-here";t.$wrapper.find(".js-move-user").draggable({helper:"clone",delay:200,cursorAt:{top:10,left:20},start:function(t,n){n.helper.addClass("is-clone"),i=e.team.sidebar.$wrapper.find(".js-drop-block"),i.length&&i.addClass(a)},stop:function(e,t){var n=t.helper,r=n.clone(),o=300;r.insertAfter(n).fadeOut(.9*o),setTimeout(function(){r.remove()},o),i.length&&i.removeClass(a)}})},UserList.prototype.initHightlight=function(){function t(e){var t=e.split(" "),i=t[0].split("-"),a=t[1].split(":");return{year:parseInt(i[0]),month:parseInt(i[1]),day:parseInt(i[2]),hours:parseInt(a[0]),minutes:parseInt(a[1]),seconds:parseInt(a[2])}}function i(e){return new Date(e.year,e.month-1,e.day,e.hours,e.minutes,e.seconds)}var a=this,n=e.team.sidebar.link_count_update_date;n&&(n=i(n),a.$items.each(function(){var a=e(this),r=a.data("update-datetime");if(r&&r.length){var o=i(t(r));o>n&&a.addClass("highlighted")}}))},UserList}(jQuery),WelcomePage=function(e){return WelcomePage=function(e){var t=this;t.$wrapper=e.$wrapper,t.$inviteWrapper=t.$wrapper.find("#t-invite-wrapper"),t.$inviteList=t.$inviteWrapper.find(".t-invite-list"),t.locales=e.locales,t.error_class="error",t.is_locked=!1,t.initClass()},WelcomePage.prototype.initClass=function(){var t=this;e(document).on("ready",function(){e.team.content.is_enabled=!1});var i=t.$inviteList.find("input:checkbox");i.each(function(){t.initIButton(e(this))}),t.bindEvents()},WelcomePage.prototype.bindEvents=function(){var t=this;t.$wrapper.on("click",".js-skip-page",function(e){e.stopPropagation()}),t.$wrapper.on("click",".js-send-invites",function(e){e.preventDefault(),t.is_locked||t.sendInvites()}),t.$inviteWrapper.on("click",".js-add-invite",function(e){e.preventDefault(),t.addNewInvite()}),t.$inviteWrapper.on("click",".js-remove-invite",function(t){t.preventDefault(),e(this).closest("li").remove()}),t.$inviteWrapper.on("click","."+t.error_class,function(){t.removeErrors(e(this))})},WelcomePage.prototype.initIButton=function(e){e.iButton({labelOn:"",labelOff:"",classContainer:"t-ibutton ibutton-container mini"})},WelcomePage.prototype.addNewInvite=function(){var t=this,i=t.$inviteWrapper.find(".t-invite-template").clone().html(),a=e("<li>"+i+"</li>");t.$inviteList.append(a);var n=a.find("input:checkbox");t.initIButton(n)},WelcomePage.prototype.sendInvites=function(){function t(){function t(e){return e.match(".+@.+")}var i=[],n=a.$inviteList.find(".t-invite-item"),r=[];return n.each(function(n){var o=e(this).find("input:text"),s=e(this).find("input:checkbox"),l=o.val(),d="checked"==s.attr("checked");if(e.trim(l).length){var c=t(l);c?(i.push({name:"data["+n+"][email]",value:l}),i.push({name:"data["+n+"][access]",value:d})):r.push({$field:o,locale:a.locales.incorrect})}}),r.length?(a.displayErrors(r),!1):i.length?i:!1}function i(t){var i=[];e.each(t,function(e,t){var n=t.name,r=t.text,o=parseInt(n.replace("data[","").replace("][email]","")),s=a.$inviteList.find(".t-invite-item").eq(o).find(".t-field");s.length&&i.push({$field:s,locale:r})}),a.displayErrors(i)}var a=this,n=e.team.app_url+"?module=welcome&action=save",r=t();a.is_locked=!0,r?e.post(n,r,function(t){t.errors&&t.errors.length?i(t.errors):location.href=e.team.app_url}).always(function(){a.is_locked=!1}):a.is_locked=!1},WelcomePage.prototype.removeErrors=function(e){var t=this,i=t.error_class;e?(e.removeClass(i),e.parent().find(".t-error").remove()):(t.$inviteList.find(".t-error").remove(),t.$inviteList.find("."+i).removeClass(i))},WelcomePage.prototype.displayErrors=function(t){var i=this,a=i.error_class;i.removeErrors(),e.each(t,function(e,t){var i='<span class="t-error">'+t.locale+"</span>";t.$field.addClass(a).before(i)})},WelcomePage}(jQuery);
//# sourceMappingURL=team.min.js.map
