/*
 * jQuery Tooltip plugin 1.3
 *
 * http://bassistance.de/jquery-plugins/jquery-plugin-tooltip/
 * http://docs.jquery.com/Plugins/Tooltip
 *
 * Copyright (c) 2006 - 2008 JÃ¶rn Zaefferer
 *
 * $Id: jquery.tooltip.js 5741 2008-06-21 15:22:16Z joern.zaefferer $
 * 
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 */;(function($){var helper={},current,title,tID,IE=$.browser.msie&&/MSIE\s(5\.5|6\.)/.test(navigator.userAgent),track=false;$.tooltip={blocked:false,defaults:{delay:200,fade:false,showURL:true,extraClass:"",noHideOnClick:false,top:15,left:15,id:"tooltip"},block:function(){$.tooltip.blocked=!$.tooltip.blocked;}};$.fn.extend({tooltip:function(settings){settings=$.extend({},$.tooltip.defaults,settings);createHelper(settings);var r=this.each(function(){$.data(this,"tooltip",settings);this.tOpacity=helper.parent.css("opacity");this.tooltipText=this.title;$(this).removeAttr("title");this.alt="";}).mouseover(save).mouseout(hide);if(!settings.noHideOnClick){r.click(hide);}return r;},fixPNG:IE?function(){return this.each(function(){var image=$(this).css('backgroundImage');if(image.match(/^url\(["']?(.*\.png)["']?\)$/i)){image=RegExp.$1;$(this).css({'backgroundImage':'none','filter':"progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true, sizingMethod=crop, src='"+image+"')"}).each(function(){var position=$(this).css('position');if(position!='absolute'&&position!='relative')$(this).css('position','relative');});}});}:function(){return this;},unfixPNG:IE?function(){return this.each(function(){$(this).css({'filter':'',backgroundImage:''});});}:function(){return this;},hideWhenEmpty:function(){return this.each(function(){$(this)[$(this).html()?"show":"hide"]();});},url:function(){return this.attr('href')||this.attr('src');}});function createHelper(settings){if(helper.parent)return;helper.parent=$('<div id="'+settings.id+'"><h3></h3><div class="body"></div><div class="url"></div></div>').appendTo(document.body).hide();if($.fn.bgiframe)helper.parent.bgiframe();helper.title=$('h3',helper.parent);helper.body=$('div.body',helper.parent);helper.url=$('div.url',helper.parent);}function settings(element){return $.data(element,"tooltip");}function handle(event){if(settings(this).delay)tID=setTimeout(show,settings(this).delay);else
show();track=!!settings(this).track;$(document.body).bind('mousemove',update);update(event);}function save(){if($.tooltip.blocked||this==current||(!this.tooltipText&&!settings(this).bodyHandler))return;current=this;title=this.tooltipText;if(settings(this).bodyHandler){helper.title.hide();var bodyContent=settings(this).bodyHandler.call(this);if(bodyContent.nodeType||bodyContent.jquery){helper.body.empty().append(bodyContent)}else{helper.body.html(bodyContent);}helper.body.show();}else if(settings(this).showBody){var parts=title.split(settings(this).showBody);helper.title.html(parts.shift()).show();helper.body.empty();for(var i=0,part;(part=parts[i]);i++){if(i>0)helper.body.append("<br/>");helper.body.append(part);}helper.body.hideWhenEmpty();}else{helper.title.html(title).show();helper.body.hide();}if(settings(this).showURL&&$(this).url())helper.url.html($(this).url().replace('http://','')).show();else
helper.url.hide();helper.parent.addClass(settings(this).extraClass);if(settings(this).fixPNG)helper.parent.fixPNG();handle.apply(this,arguments);}function show(){tID=null;if((!IE||!$.fn.bgiframe)&&settings(current).fade){if(helper.parent.is(":animated"))helper.parent.stop().show().fadeTo(settings(current).fade,current.tOpacity);else
helper.parent.is(':visible')?helper.parent.fadeTo(settings(current).fade,current.tOpacity):helper.parent.fadeIn(settings(current).fade);}else{helper.parent.show();}update();}function update(event){if($.tooltip.blocked)return;if(event&&event.target.tagName=="OPTION"){return;}if(!track&&helper.parent.is(":visible")){$(document.body).unbind('mousemove',update)}if(current==null){$(document.body).unbind('mousemove',update);return;}helper.parent.removeClass("viewport-right").removeClass("viewport-bottom");var left=helper.parent[0].offsetLeft;var top=helper.parent[0].offsetTop;if(event){left=event.pageX+settings(current).left;top=event.pageY+settings(current).top;var right='auto';if(settings(current).positionLeft){right=$(window).width()-left;left='auto';}helper.parent.css({left:left,right:right,top:top});}var v=viewport(),h=helper.parent[0];if(v.x+v.cx<h.offsetLeft+h.offsetWidth){left-=h.offsetWidth+20+settings(current).left;helper.parent.css({left:left+'px'}).addClass("viewport-right");}if(v.y+v.cy<h.offsetTop+h.offsetHeight){top-=h.offsetHeight+20+settings(current).top;helper.parent.css({top:top+'px'}).addClass("viewport-bottom");}}function viewport(){return{x:$(window).scrollLeft(),y:$(window).scrollTop(),cx:$(window).width(),cy:$(window).height()};}function hide(event){if($.tooltip.blocked)return;if(tID)clearTimeout(tID);current=null;var tsettings=settings(this);function complete(){helper.parent.removeClass(tsettings.extraClass).hide().css("opacity","");}if((!IE||!$.fn.bgiframe)&&tsettings.fade){if(helper.parent.is(':animated'))helper.parent.stop().fadeTo(tsettings.fade,0,complete);else
helper.parent.stop().fadeOut(tsettings.fade,complete);}else
complete();if(settings(this).fixPNG)helper.parent.unfixPNG();}})(jQuery);;
/*!
 * jquery-timepicker v1.11.5 - A jQuery timepicker plugin inspired by Google Calendar. It supports both mouse and keyboard navigation.
 * Copyright (c) 2016 Jon Thornton - http://jonthornton.github.com/jquery-timepicker/
 * License: MIT
 */

!function(a){"object"==typeof exports&&exports&&"object"==typeof module&&module&&module.exports===exports?a(require("jquery")):"function"==typeof define&&define.amd?define(["jquery"],a):a(jQuery)}(function(a){function b(a){var b=a[0];return b.offsetWidth>0&&b.offsetHeight>0}function c(b){if(b.minTime&&(b.minTime=t(b.minTime)),b.maxTime&&(b.maxTime=t(b.maxTime)),b.durationTime&&"function"!=typeof b.durationTime&&(b.durationTime=t(b.durationTime)),"now"==b.scrollDefault)b.scrollDefault=function(){return b.roundingFunction(t(new Date),b)};else if(b.scrollDefault&&"function"!=typeof b.scrollDefault){var c=b.scrollDefault;b.scrollDefault=function(){return b.roundingFunction(t(c),b)}}else b.minTime&&(b.scrollDefault=function(){return b.roundingFunction(b.minTime,b)});if("string"===a.type(b.timeFormat)&&b.timeFormat.match(/[gh]/)&&(b._twelveHourTime=!0),b.showOnFocus===!1&&-1!=b.showOn.indexOf("focus")&&b.showOn.splice(b.showOn.indexOf("focus"),1),b.disableTimeRanges.length>0){for(var d in b.disableTimeRanges)b.disableTimeRanges[d]=[t(b.disableTimeRanges[d][0]),t(b.disableTimeRanges[d][1])];b.disableTimeRanges=b.disableTimeRanges.sort(function(a,b){return a[0]-b[0]});for(var d=b.disableTimeRanges.length-1;d>0;d--)b.disableTimeRanges[d][0]<=b.disableTimeRanges[d-1][1]&&(b.disableTimeRanges[d-1]=[Math.min(b.disableTimeRanges[d][0],b.disableTimeRanges[d-1][0]),Math.max(b.disableTimeRanges[d][1],b.disableTimeRanges[d-1][1])],b.disableTimeRanges.splice(d,1))}return b}function d(b){var c=b.data("timepicker-settings"),d=b.data("timepicker-list");if(d&&d.length&&(d.remove(),b.data("timepicker-list",!1)),c.useSelect){d=a("<select />",{"class":"ui-timepicker-select"});var g=d}else{d=a("<ul />",{"class":"ui-timepicker-list"});var g=a("<div />",{"class":"ui-timepicker-wrapper",tabindex:-1});g.css({display:"none",position:"absolute"}).append(d)}if(c.noneOption)if(c.noneOption===!0&&(c.noneOption=c.useSelect?"Time...":"None"),a.isArray(c.noneOption)){for(var i in c.noneOption)if(parseInt(i,10)==i){var k=e(c.noneOption[i],c.useSelect);d.append(k)}}else{var k=e(c.noneOption,c.useSelect);d.append(k)}if(c.className&&g.addClass(c.className),(null!==c.minTime||null!==c.durationTime)&&c.showDuration){"function"==typeof c.step?"function":c.step;g.addClass("ui-timepicker-with-duration"),g.addClass("ui-timepicker-step-"+c.step)}var l=c.minTime;"function"==typeof c.durationTime?l=t(c.durationTime()):null!==c.durationTime&&(l=c.durationTime);var n=null!==c.minTime?c.minTime:0,o=null!==c.maxTime?c.maxTime:n+u-1;n>o&&(o+=u),o===u-1&&"string"===a.type(c.timeFormat)&&c.show2400&&(o=u);var p=c.disableTimeRanges,v=0,x=p.length,y=c.step;"function"!=typeof y&&(y=function(){return c.step});for(var i=n,z=0;o>=i;z++,i+=60*y(z)){var A=i,B=s(A,c);if(c.useSelect){var C=a("<option />",{value:B});C.text(B)}else{var C=a("<li />");C.addClass(43200>A%86400?"ui-timepicker-am":"ui-timepicker-pm"),C.data("time",86400>=A?A:A%86400),C.text(B)}if((null!==c.minTime||null!==c.durationTime)&&c.showDuration){var D=r(i-l,c.step);if(c.useSelect)C.text(C.text()+" ("+D+")");else{var E=a("<span />",{"class":"ui-timepicker-duration"});E.text(" ("+D+")"),C.append(E)}}x>v&&(A>=p[v][1]&&(v+=1),p[v]&&A>=p[v][0]&&A<p[v][1]&&(c.useSelect?C.prop("disabled",!0):C.addClass("ui-timepicker-disabled"))),d.append(C)}if(g.data("timepicker-input",b),b.data("timepicker-list",g),c.useSelect)b.val()&&d.val(f(t(b.val()),c)),d.on("focus",function(){a(this).data("timepicker-input").trigger("showTimepicker")}),d.on("blur",function(){a(this).data("timepicker-input").trigger("hideTimepicker")}),d.on("change",function(){m(b,a(this).val(),"select")}),m(b,d.val(),"initial"),b.hide().after(d);else{var F=c.appendTo;"string"==typeof F?F=a(F):"function"==typeof F&&(F=F(b)),F.append(g),j(b,d),d.on("mousedown click","li",function(c){b.off("focus.timepicker"),b.on("focus.timepicker-ie-hack",function(){b.off("focus.timepicker-ie-hack"),b.on("focus.timepicker",w.show)}),h(b)||b[0].focus(),d.find("li").removeClass("ui-timepicker-selected"),a(this).addClass("ui-timepicker-selected"),q(b)&&(b.trigger("hideTimepicker"),d.on("mouseup.timepicker click.timepicker","li",function(a){d.off("mouseup.timepicker click.timepicker"),g.hide()}))})}}function e(b,c){var d,e,f;return"object"==typeof b?(d=b.label,e=b.className,f=b.value):"string"==typeof b?d=b:a.error("Invalid noneOption value"),c?a("<option />",{value:f,"class":e,text:d}):a("<li />",{"class":e,text:d}).data("time",String(f))}function f(a,b){return a=b.roundingFunction(a,b),null!==a?s(a,b):void 0}function g(b){if(b.target!=window){var c=a(b.target);c.closest(".ui-timepicker-input").length||c.closest(".ui-timepicker-wrapper").length||(w.hide(),a(document).unbind(".ui-timepicker"),a(window).unbind(".ui-timepicker"))}}function h(a){var b=a.data("timepicker-settings");return(window.navigator.msMaxTouchPoints||"ontouchstart"in document)&&b.disableTouchKeyboard}function i(b,c,d){if(!d&&0!==d)return!1;var e=b.data("timepicker-settings"),f=!1,d=e.roundingFunction(d,e);return c.find("li").each(function(b,c){var e=a(c);if("number"==typeof e.data("time"))return e.data("time")==d?(f=e,!1):void 0}),f}function j(a,b){b.find("li").removeClass("ui-timepicker-selected");var c=t(l(a),a.data("timepicker-settings"));if(null!==c){var d=i(a,b,c);if(d){var e=d.offset().top-b.offset().top;(e+d.outerHeight()>b.outerHeight()||0>e)&&b.scrollTop(b.scrollTop()+d.position().top-d.outerHeight()),d.addClass("ui-timepicker-selected")}}}function k(b,c){if(""!==this.value&&"timepicker"!=c){var d=a(this);if(!d.is(":focus")||b&&"change"==b.type){var e=d.data("timepicker-settings"),f=t(this.value,e);if(null===f)return void d.trigger("timeFormatError");var g=!1;if(null!==e.minTime&&null!==e.maxTime&&(f<e.minTime||f>e.maxTime)&&(g=!0),a.each(e.disableTimeRanges,function(){return f>=this[0]&&f<this[1]?(g=!0,!1):void 0}),e.forceRoundTime){var h=e.roundingFunction(f,e);h!=f&&(f=h,c=null)}var i=s(f,e);g?m(d,i,"error")&&d.trigger("timeRangeError"):m(d,i,c)}}}function l(a){return a.is("input")?a.val():a.data("ui-timepicker-value")}function m(a,b,c){if(a.is("input")){a.val(b);var d=a.data("timepicker-settings");d.useSelect&&"select"!=c&&"initial"!=c&&a.data("timepicker-list").val(f(t(b),d))}return a.data("ui-timepicker-value")!=b?(a.data("ui-timepicker-value",b),"select"==c?a.trigger("selectTime").trigger("changeTime").trigger("change","timepicker"):-1==["error","initial"].indexOf(c)&&a.trigger("changeTime"),!0):(a.trigger("selectTime"),!1)}function n(a){switch(a.keyCode){case 13:case 9:return;default:a.preventDefault()}}function o(c){var d=a(this),e=d.data("timepicker-list");if(!e||!b(e)){if(40!=c.keyCode)return!0;w.show.call(d.get(0)),e=d.data("timepicker-list"),h(d)||d.focus()}switch(c.keyCode){case 13:return q(d)&&(k.call(d.get(0),{type:"change"}),w.hide.apply(this)),c.preventDefault(),!1;case 38:var f=e.find(".ui-timepicker-selected");return f.length?f.is(":first-child")||(f.removeClass("ui-timepicker-selected"),f.prev().addClass("ui-timepicker-selected"),f.prev().position().top<f.outerHeight()&&e.scrollTop(e.scrollTop()-f.outerHeight())):(e.find("li").each(function(b,c){return a(c).position().top>0?(f=a(c),!1):void 0}),f.addClass("ui-timepicker-selected")),!1;case 40:return f=e.find(".ui-timepicker-selected"),0===f.length?(e.find("li").each(function(b,c){return a(c).position().top>0?(f=a(c),!1):void 0}),f.addClass("ui-timepicker-selected")):f.is(":last-child")||(f.removeClass("ui-timepicker-selected"),f.next().addClass("ui-timepicker-selected"),f.next().position().top+2*f.outerHeight()>e.outerHeight()&&e.scrollTop(e.scrollTop()+f.outerHeight())),!1;case 27:e.find("li").removeClass("ui-timepicker-selected"),w.hide();break;case 9:w.hide();break;default:return!0}}function p(c){var d=a(this),e=d.data("timepicker-list"),f=d.data("timepicker-settings");if(!e||!b(e)||f.disableTextInput)return!0;switch(c.keyCode){case 96:case 97:case 98:case 99:case 100:case 101:case 102:case 103:case 104:case 105:case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:case 65:case 77:case 80:case 186:case 8:case 46:f.typeaheadHighlight?j(d,e):e.hide()}}function q(a){var b=a.data("timepicker-settings"),c=a.data("timepicker-list"),d=null,e=c.find(".ui-timepicker-selected");return e.hasClass("ui-timepicker-disabled")?!1:(e.length&&(d=e.data("time")),null!==d&&("string"!=typeof d&&(d=s(d,b)),m(a,d,"select")),!0)}function r(a,b){a=Math.abs(a);var c,d,e=Math.round(a/60),f=[];return 60>e?f=[e,v.mins]:(c=Math.floor(e/60),d=e%60,30==b&&30==d&&(c+=v.decimal+5),f.push(c),f.push(1==c?v.hr:v.hrs),30!=b&&d&&(f.push(d),f.push(v.mins))),f.join(" ")}function s(b,c){if("number"!=typeof b)return null;var d=parseInt(b%60),e=parseInt(b/60%60),f=parseInt(b/3600%24),g=new Date(1970,0,2,f,e,d,0);if(isNaN(g.getTime()))return null;if("function"===a.type(c.timeFormat))return c.timeFormat(g);for(var h,i,j="",k=0;k<c.timeFormat.length;k++)switch(i=c.timeFormat.charAt(k)){case"a":j+=g.getHours()>11?v.pm:v.am;break;case"A":j+=g.getHours()>11?v.PM:v.AM;break;case"g":h=g.getHours()%12,j+=0===h?"12":h;break;case"G":h=g.getHours(),b===u&&(h=c.show2400?24:0),j+=h;break;case"h":h=g.getHours()%12,0!==h&&10>h&&(h="0"+h),j+=0===h?"12":h;break;case"H":h=g.getHours(),b===u&&(h=c.show2400?24:0),j+=h>9?h:"0"+h;break;case"i":var e=g.getMinutes();j+=e>9?e:"0"+e;break;case"s":d=g.getSeconds(),j+=d>9?d:"0"+d;break;case"\\":k++,j+=c.timeFormat.charAt(k);break;default:j+=i}return j}function t(a,b){if(""===a||null===a)return null;if("object"==typeof a)return 3600*a.getHours()+60*a.getMinutes()+a.getSeconds();if("string"!=typeof a)return a;a=a.toLowerCase().replace(/[\s\.]/g,""),("a"==a.slice(-1)||"p"==a.slice(-1))&&(a+="m");var c="("+v.am.replace(".","")+"|"+v.pm.replace(".","")+"|"+v.AM.replace(".","")+"|"+v.PM.replace(".","")+")?",d=new RegExp("^"+c+"([0-9]?[0-9])\\W?([0-5][0-9])?\\W?([0-5][0-9])?"+c+"$"),e=a.match(d);if(!e)return null;var f=parseInt(1*e[2],10);if(f>24){if(b&&b.wrapHours===!1)return null;f%=24}var g=e[1]||e[5],h=f;if(12>=f&&g){var i=g==v.pm||g==v.PM;h=12==f?i?12:0:f+(i?12:0)}var j=1*e[3]||0,k=1*e[4]||0,l=3600*h+60*j+k;if(12>f&&!g&&b&&b._twelveHourTime&&b.scrollDefault){var m=l-b.scrollDefault();0>m&&m>=u/-2&&(l=(l+u/2)%u)}return l}var u=86400,v={am:"am",pm:"pm",AM:"AM",PM:"PM",decimal:".",mins:"mins",hr:"hr",hrs:"hrs"},w={init:function(b){return this.each(function(){var e=a(this),f=[];for(var g in a.fn.timepicker.defaults)e.data(g)&&(f[g]=e.data(g));var h=a.extend({},a.fn.timepicker.defaults,f,b);if(h.lang&&(v=a.extend(v,h.lang)),h=c(h),e.data("timepicker-settings",h),e.addClass("ui-timepicker-input"),h.useSelect)d(e);else{if(e.prop("autocomplete","off"),h.showOn)for(var i in h.showOn)e.on(h.showOn[i]+".timepicker",w.show);e.on("change.timepicker",k),e.on("keydown.timepicker",o),e.on("keyup.timepicker",p),h.disableTextInput&&e.on("keydown.timepicker",n),k.call(e.get(0),null,"initial")}})},show:function(c){var e=a(this),f=e.data("timepicker-settings");if(c&&c.preventDefault(),f.useSelect)return void e.data("timepicker-list").focus();h(e)&&e.blur();var k=e.data("timepicker-list");if(!e.prop("readonly")&&(k&&0!==k.length&&"function"!=typeof f.durationTime||(d(e),k=e.data("timepicker-list")),!b(k))){e.data("ui-timepicker-value",e.val()),j(e,k),w.hide(),k.show();var m={};f.orientation.match(/r/)?m.left=e.offset().left+e.outerWidth()-k.outerWidth()+parseInt(k.css("marginLeft").replace("px",""),10):m.left=e.offset().left+parseInt(k.css("marginLeft").replace("px",""),10);var n;n=f.orientation.match(/t/)?"t":f.orientation.match(/b/)?"b":e.offset().top+e.outerHeight(!0)+k.outerHeight()>a(window).height()+a(window).scrollTop()?"t":"b","t"==n?(k.addClass("ui-timepicker-positioned-top"),m.top=e.offset().top-k.outerHeight()+parseInt(k.css("marginTop").replace("px",""),10)):(k.removeClass("ui-timepicker-positioned-top"),m.top=e.offset().top+e.outerHeight()+parseInt(k.css("marginTop").replace("px",""),10)),k.offset(m);var o=k.find(".ui-timepicker-selected");if(!o.length){var p=t(l(e));null!==p?o=i(e,k,p):f.scrollDefault&&(o=i(e,k,f.scrollDefault()))}if(o&&o.length){var q=k.scrollTop()+o.position().top-o.outerHeight();k.scrollTop(q)}else k.scrollTop(0);return f.stopScrollPropagation&&a(document).on("wheel.ui-timepicker",".ui-timepicker-wrapper",function(b){b.preventDefault();var c=a(this).scrollTop();a(this).scrollTop(c+b.originalEvent.deltaY)}),a(document).on("touchstart.ui-timepicker mousedown.ui-timepicker",g),a(window).on("resize.ui-timepicker",g),f.closeOnWindowScroll&&a(document).on("scroll.ui-timepicker",g),e.trigger("showTimepicker"),this}},hide:function(c){var d=a(this),e=d.data("timepicker-settings");return e&&e.useSelect&&d.blur(),a(".ui-timepicker-wrapper").each(function(){var c=a(this);if(b(c)){var d=c.data("timepicker-input"),e=d.data("timepicker-settings");e&&e.selectOnBlur&&q(d),c.hide(),d.trigger("hideTimepicker")}}),this},option:function(b,e){return"string"==typeof b&&"undefined"==typeof e?a(this).data("timepicker-settings")[b]:this.each(function(){var f=a(this),g=f.data("timepicker-settings"),h=f.data("timepicker-list");"object"==typeof b?g=a.extend(g,b):"string"==typeof b&&(g[b]=e),g=c(g),f.data("timepicker-settings",g),h&&(h.remove(),f.data("timepicker-list",!1)),g.useSelect&&d(f)})},getSecondsFromMidnight:function(){return t(l(this))},getTime:function(a){var b=this,c=l(b);if(!c)return null;var d=t(c);if(null===d)return null;a||(a=new Date);var e=new Date(a);return e.setHours(d/3600),e.setMinutes(d%3600/60),e.setSeconds(d%60),e.setMilliseconds(0),e},isVisible:function(){var a=this,c=a.data("timepicker-list");return!(!c||!b(c))},setTime:function(a){var b=this,c=b.data("timepicker-settings");if(c.forceRoundTime)var d=f(t(a),c);else var d=s(t(a),c);return a&&null===d&&c.noneOption&&(d=a),m(b,d),b.data("timepicker-list")&&j(b,b.data("timepicker-list")),this},remove:function(){var a=this;if(a.hasClass("ui-timepicker-input")){var b=a.data("timepicker-settings");return a.removeAttr("autocomplete","off"),a.removeClass("ui-timepicker-input"),a.removeData("timepicker-settings"),a.off(".timepicker"),a.data("timepicker-list")&&a.data("timepicker-list").remove(),b.useSelect&&a.show(),a.removeData("timepicker-list"),this}}};a.fn.timepicker=function(b){return this.length?w[b]?this.hasClass("ui-timepicker-input")?w[b].apply(this,Array.prototype.slice.call(arguments,1)):this:"object"!=typeof b&&b?void a.error("Method "+b+" does not exist on jQuery.timepicker"):w.init.apply(this,arguments):this},a.fn.timepicker.defaults={appendTo:"body",className:null,closeOnWindowScroll:!1,disableTextInput:!1,disableTimeRanges:[],disableTouchKeyboard:!1,durationTime:null,forceRoundTime:!1,maxTime:null,minTime:null,noneOption:!1,orientation:"l",roundingFunction:function(a,b){if(null===a)return null;if("number"!=typeof b.step)return a;var c=a%(60*b.step);return c>=30*b.step?a+=60*b.step-c:a-=c,a==u&&b.show2400?a:a%u},scrollDefault:null,selectOnBlur:!1,show2400:!1,showDuration:!1,showOn:["click","focus"],showOnFocus:!0,step:30,stopScrollPropagation:!1,timeFormat:"g:ia",typeaheadHighlight:!0,useSelect:!1,wrapHours:!0}});;
/*
 * JavaScript Templates 2.1.0
 * https://github.com/blueimp/JavaScript-Templates
 *
 * Copyright 2011, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 *
 * Inspired by John Resig's JavaScript Micro-Templating:
 * http://ejohn.org/blog/javascript-micro-templating/
 */

/*jslint evil: true, regexp: true */
/*global document, define */

(function ($) {
    "use strict";
    var tmpl = function (str, data, nocache) {
        var f = !/[^\w\-\.:]/.test(str) ?
            ( !nocache ?
                    (tmpl.cache[str] = tmpl.cache[str] || tmpl(tmpl.load(str))) :
                        tmpl.cache[str] = tmpl(tmpl.load(str))
            ) :
            new Function(
                tmpl.arg + ',tmpl',
                "var _e=tmpl.encode" + tmpl.helper + ",_s='" +
                    str.replace(tmpl.regexp, tmpl.func) +
                    "';return _s;"
            );
        return data ? f(data, tmpl) : function (data) {
            return f(data, tmpl);
        };
    };
    tmpl.cache = {};
    tmpl.load = function (id) {
        var e = document.getElementById(id),
            pattern = /<\\\/(\w+)/g,
            replace = '<'+'/$1';
        if(!e && console) {
            throw { message: 'template with id='+id+' not found' };
        }
        return e?(e.tagName.toLowerCase() == 'textarea' ? e.value: document.getElementById(id).innerHTML).replace(pattern, replace):null;
    };
    tmpl.regexp = /([\s'\\])(?![^%]*%\})|(?:\{%(=|#)([\s\S]+?)%\})|(\{%)|(%\})/g;
    tmpl.func = function (s, p1, p2, p3, p4, p5) {
        if (p1) { // whitespace, quote and backspace in interpolation context
            return {
                "\n": "\\n",
                "\r": "\\r",
                "\t": "\\t",
                " " : " "
            }[s] || "\\" + s;
        }
        if (p2) { // interpolation: {%=prop%}, or unescaped: {%#prop%}
            if (p2 === "=") {
                return "'+_e(" + p3 + ")+'";
            }
            return "'+(" + p3 + "||'')+'";
        }
        if (p4) { // evaluation start tag: {%
            return "';";
        }
        if (p5) { // evaluation end tag: %}
            return "_s+='";
        }
    };
    tmpl.encReg = /[<>&"'\x00]/g;
    tmpl.encMap = {
        "<"   : "&lt;",
        ">"   : "&gt;",
        "&"   : "&amp;",
        "\""  : "&quot;",
        "'"   : "&#39;"
    };
    tmpl.encode = function (s) {
        return String(s || "").replace(
            tmpl.encReg,
            function (c) {
                return tmpl.encMap[c] || "";
            }
        );
    };
    tmpl.arg = "o";
    tmpl.helper = ",print=function(s,e){_s+=e&&(s||'')||_e(s);}" +
        ",include=function(s,d){_s+=tmpl(s,d);}";
    if (typeof define === "function" && define.amd) {
        define(function () {
            return tmpl;
        });
    } else {
        $.tmpl = tmpl;
    }
}(this));;
(function($) {

    $.fn.lazyLoad = function(options, ext) {

        if (options == 'stop') {
            var settings = this.data('lazyLoadSettings');
            if (settings) {
                settings.stopped = true;
            }
            return;
        }
        
        if (options == 'reload') {
            var settings = this.data('lazyLoadSettings');
            if (settings) {
                settings.stopped = false;
                settings.loading = false;
                this.get(0).onscroll = null;
                this.lazyLoad(settings);
            }
            return;
        }

        if (options == 'sleep') {
            var settings = this.data('lazyLoadSettings');
            if (settings) {
                settings.loading = true;
            }
            return;
        }

        if (options == 'wake') {
            var settings = this.data('lazyLoadSettings');
            if (settings) {
                settings.loading = false;
            }
            return;
        }

        if (options == 'force') {
            var settings = this.data('lazyLoadSettings');
            if (settings) {
                if (!settings.loading) {
                    settings.load();
                }
            }
            return;
        }

        this.data('lazyLoadSettings', $.extend({
            distance: 50,
            load: function() {},
            container: container,
            state: 'wake',
            hash: location.hash.replace(/^[^#]*#\/*/, '').split('/')[0] || null,
            distanceBetweenBottoms: null
        }, options || {}));

        var settings = this.data('lazyLoadSettings');
        settings.loading = false;
        settings.stopped = false;

        var win = $(window);
        var container = settings.container || $(this);

        init();

        function init()
        {
            if (settings.hash !== null) {
                if (!$.isArray(settings.hash)) {
                    settings.hash = [settings.hash];
                }
            }
            $.fn.lazyLoad.call(win, settings.state);
            initHandler();
        }

        function scrollHandler()
        {
            if (settings.stopped) {
                this.onscroll = null;
                return;
            }
            if (!settings.stopped && !settings.loading && distanceBetweenBottoms(container, win) <= settings.distance) {
                if (settings.hash !== null) {
                    var loc_hash = location.hash.replace(/^[^#]*#\/*/, '').split('/')[0];
                    if (settings.hash.indexOf(loc_hash) === -1) {
                        this.onscroll = null;
                        return;
                    }
                }
                settings.load();
            }
        }

        function initHandler()
        {
            var interval = 350;
            var timerId = setTimeout(function() {
                if (settings.stopped) {
                    clearTimeout(timerId);
                    return;
                }
                if (settings.hash !== null) {
                    var loc_hash = location.hash.replace(/^[^#]*#\/*/, '').split('/')[0];
                    if (settings.hash.indexOf(loc_hash) === -1) {
                        clearTimeout(timerId);
                        return;
                    }
                }
                if (!settings.loading) {
                    var r = distanceBetweenBottoms(container, win);
                    if (distanceBetweenBottoms(container, win) <= settings.distance) {
                        settings.load();
                        timerId = setTimeout(arguments.callee, interval);
                    } else {
                        win.get(0).onscroll = scrollHandler;
                        clearTimeout(timerId);
                    }
                } else {
                    timerId = setTimeout(arguments.callee, interval);
                }
            }, interval);
        }

        var distanceBetweenBottoms = typeof settings.distanceBetweenBottoms === 'function' ?
            settings.distanceBetweenBottoms :
            function (container, win, offset) {
                container = typeof container === 'string' ? $(container) : container;
                offset = offset || 0;
                return (container.position().top + container.outerHeight() - offset) - (win.scrollTop() + win.height());
            };
    };
})(jQuery);
;
(function ($) {
    $.storage = new $.store();
    $.orders = {
        options: {
            view: 'table'      // default view
        },

        //
        // Init-related
        //

        init: function (options) {
            var that = this;
            that.options = options;
            if (typeof($.History) != "undefined") {
                $.History.bind(function () {
                    that.dispatch();
                });
            }
            $.wa.errorHandler = function (xhr) {
                if ((xhr.status === 403) || (xhr.status === 404) ) {
                    var text = $(xhr.responseText);
                    if (text.find('.dialog-content').length) {
                        text = $('<div class="block double-padded"></div>').append(text.find('.dialog-content *'));

                    } else {
                        text = $('<div class="block double-padded"></div>').append(text.find(':not(style)'));
                    }
                    $("#s-content").empty().append(text);
                    $.orders.onPageNotFound();
                    return false;
                }
                return true;
            };
            var hash = window.location.hash;
            if (hash === '#/' || !hash) {
                this.dispatch();
            } else {
                $.wa.setHash(hash);
            }

            this.initSearch();

            // sync with app counters
            $(document).bind('wa.appcount', function(event, data) {
                var cnt = parseInt(data.shop, 10);
                $('#s-pending-orders .small').text(cnt ? '+' + cnt : '');

                // update prefix of document.title. Prefix looks like: (\d+).
                // Take into account extreme cases: cnt=0 or no prefix yet
                var match = document.title.match(/\(\d+\) /);
                if (match) {
                    document.title = document.title.replace(match[0], cnt ? '(' + cnt + ') ' : '');
                } else {
                    if (cnt) {
                        document.title = '(' + cnt + ') ' + document.title;
                    }
                }
            });

            $(function () {
                $("#maincontent").on('click', '.s-alert-close', function () {
                    var alerts = $.storage.get('shop/alerts');
                    var $item = $(this).parent();
                    if (!alerts) {
                        alerts = [];
                    }
                    alerts.push($item.data('alert'));
                    alerts = alerts.filter(function (elem, index, self) {
                        return (elem != null) && (index == self.indexOf(elem));
                    });
                    $.storage.set('shop/alerts', alerts);
                    $item.remove();
                    return false;
                });
            });

            this.checkAlerts();
        },

        onPageNotFound: function() {
            if ($.order_list) {
                $.order_list.finit();
            }
        },

        initSearch: function() {
            var search_input = $("#s-orders-search");

            var autocomplete_url = '?action=autocomplete&type=order';
            var last_response = [];

            var onSelect = function(autocomplete_item) {
                switch (autocomplete_item.autocomplete_item_type) {
                    case 'order':
                        $.wa.setHash('#/order/' + autocomplete_item.id + '/');
                        search_input.val(autocomplete_item.value);
                        break;
                    case 'contact':
                        $.wa.setHash('#/orders/contact_id=' + autocomplete_item.id + '/');
                        search_input.val(autocomplete_item.value);
                        break;
                    case 'product':
                        $.wa.setHash('#/orders/product_id=' + autocomplete_item.id + '/');
                        search_input.val(autocomplete_item.value);
                        break;
                    case 'coupon':
                        $.wa.setHash('#/orders/coupon_id=' + autocomplete_item.id + '/');
                        break;
                    case 'tracking_number':
                        $.wa.setHash('#/orders/tracking_number=' + autocomplete_item.value + '/');
                        break;
                    case 'shipping':
                        $.wa.setHash('#/orders/shipping_id=' + autocomplete_item.id + '/');
                        break;
                    case 'payment':
                        $.wa.setHash('#/orders/payment_id=' + autocomplete_item.id + '/');
                        break;
                    case 'city':
                        $.wa.setHash('#/orders/city=' + autocomplete_item.value + '/');
                        break;
                    case 'region':
                        $.wa.setHash('#/orders/region=' + ((autocomplete_item.value || '').split(':')[1] || '') + '/');
                        break;
                    case 'country':
                        $.wa.setHash('#/orders/country=' + autocomplete_item.value + '/');
                        break;
                    default:
                        // search
                        break;
                }
            };

            search_input.unbind('keydown').
                bind('keydown', function(event) {
                    if (event.keyCode == 13 || event.keyCode == 10) { // 'Enter'
                        var self = $(this);
                        if (!$(this).val()) {
                            location.hash = '#/orders/all/';
                            self.autocomplete("close");
                            return false;
                        } else {
                            if (last_response && $.isArray(last_response) && last_response.length) {
                                onSelect(last_response[0]);
                                setTimeout(function() {
                                    self.autocomplete("close");
                                }, 150);
                                return false;
                            }
                        }
                    }
                });

            search_input.autocomplete({
                minLength: 1,
                delay: 300,
                html: true,
                select: function(event, ui) {
                    //location.hash = '#/order/'+ui.item.id+'/';
                    onSelect(ui.item);
                    return false;
                },
                source : function(request, response) {
                    $.getJSON(autocomplete_url, request, function(r) {
                        last_response = r;
                        response(r);
                    });
                }
            });
        },

        //
        // Dispatch-related
        //

        // dispatch() ignores the call if prevHash == hash
        prevHash: null,
        hash: null,

        // if this is > 0 then this.dispatch() decrements it and ignores a call
        skipDispatch: 0,

        /** Cancel the next n automatic dispatches when window.location.hash changes */
        stopDispatch: function (n) {
            this.skipDispatch = n;
        },

        // Change location hash without triggering dispatch
        forceHash: function(hash) {
            if (location.hash != hash) {
                this.skipDispatch++;
                $.wa.setHash(hash);
            }
        },

        /** Implements #hash-based navigation. Called every time location.hash changes. */
        dispatch: function (hash) {
            if (this.skipDispatch > 0) {
                this.skipDispatch--;
                return false;
            }
            if (hash === undefined || hash === null) {
                hash = window.location.hash;
            }
            hash = hash.replace(/(^[^#]*#\/*|\/$)/g, ''); /* fix syntax highlight*/
            if (this.hash !== null) {
                this.prevHash = this.hash;
            }
            this.hash = hash;
            if (hash) {
                hash = hash.split('/');
                if (hash[0]) {
                    var actionName = "";
                    var attrMarker = hash.length;
                    var lastValidActionName = null;
                    var lastValidAttrMarker = null;
                    for (var i = 0; i < hash.length; i++) {
                        var h = hash[i];
                        if (i < 2) {
                            if (i === 0) {
                                actionName = h;
                            } else if (parseInt(h, 10) != h && h.indexOf('=') == -1) {
                                actionName += h.substr(0,1).toUpperCase() + h.substr(1);
                            } else {
                                break;
                            }
                            if (typeof(this[actionName + 'Action']) == 'function') {
                                lastValidActionName = actionName;
                                lastValidAttrMarker = i + 1;
                            }
                        } else {
                            break;
                        }
                    }
                    attrMarker = i;

                    if (typeof(this[actionName + 'Action']) !== 'function' && lastValidActionName) {
                        actionName = lastValidActionName;
                        attrMarker = lastValidAttrMarker;
                    }

                    var attr = hash.slice(attrMarker);
                    this.preExecute(actionName);
                    if (typeof(this[actionName + 'Action']) == 'function') {
                        $.shop.trace('$.orders.dispatch',[actionName + 'Action',attr]);
                        this[actionName + 'Action'].apply(this, attr);
                    } else {
                        $.shop.error('Invalid action name:', actionName+'Action');
                    }
                    this.postExecute(actionName);
                } else {
                    this.preExecute();
                    this.defaultAction();
                    this.postExecute();
                }
            } else {
                this.preExecute();
                this.defaultAction();
                this.postExecute();
            }
        },

        back: function() {
            var prevHash = ($.orders.prevHash || '');
            location.hash = prevHash ? prevHash + '/' : '';
        },

        preExecute: function(actionName, attr) {
        },

        postExecute: function(actionName, attr) {
            this.actionName = actionName;
        },

        //
        // Action handlers.
        // Called by dispatch when corresponding location.hash is set.
        //

        defaultAction: function () {
            this.ordersAction();
        },

        couponsAction: function() {
            if ($.order_list) {
                $.order_list.finit();
            }
            this.load('?module=coupons');
        },

        ordersEditAction: function(id) {
            this.load('?module=order&action=edit&id='+id, function() {
                if ($.order_list) {
                    $.order_list.finit();
                }
            });
        },

        ordersNewAction: function () {
            this.load('?module=order&action=edit', function() {
                if ($.order_list) {
                    $.order_list.finit();
                }
            });
        },

        ordersAction: function(params) {

            if (params === 'hash') {
                params = {
                    hash: Array.prototype.slice.call(arguments, 1).join('/')
                };
            } else {
                var search_hash = '';
                if (params === 'search') {
                    search_hash = Array.prototype.slice.call(arguments, 1);
                }
                if (arguments.length > 1) {
                    params = Array.prototype.join.call(arguments, '/');
                }
                if (!params) {
                    // default params
                    params = "state_id=new|processing|paid";
                } else if (params === 'all') {
                    params = '';
                }
                params = $.shop.helper.parseParams(params || '');
                if (!params.view) {
                    params.view = $.storage.get('shop/orders/view') || this.options.view;
                }
                $.storage.set('shop/orders/view', params.view);
                if ($.order_edit) {
                    $.order_edit.slideBack();
                }
                if (search_hash) {
                    params.search = search_hash;
                }
            }

            if (this.actionName !== 'orders' || !$.order_list) {
                if ($.order_list) {
                    $.order_list.finit();
                }
                this.load('?module=orders&'+this.buildOrdersUrlComponent(params), function() {
                    if ($.order_list) {
                        $.order_list.dispatch(params);
                    }
                });
            } else {
                $.order_list.dispatch(params);
            }
        },

        orderAction: function(id, params) {
            params = $.shop.helper.parseParams(params || '');
            if (!params.view) {
                params.view = $.storage.get('shop/orders/view') || this.options.view;
            }
            $.storage.set('shop/orders/view', params.view);

            if ($.order_edit) {
                $.order_edit.slideBack();
            }
            this.load('?module=order&id='+encodeURIComponent(id)+'&'+this.buildOrdersUrlComponent(params), function() {
                $("#s-content").find('h1 .back.order-list').show();
            });
            if ($.order_list) {
                $.order_list.finit();
            }
        },

        //
        // Various helpers
        //

        buildOrdersUrlComponent: function(params) {
            var params_str = '';
            for (var name in params) {
                if (params.hasOwnProperty(name) && name !== 'view') {
                    params_str += '&' + name + '=' + params[name];
                }
            }
            return 'view=' + (params.view || this.options.view) + params_str;
        },

        /** Helper to load data into main content area. */
        load: function (url, options, fn) {
            if (typeof options === 'function') {
                fn = options;
                options = {};
            } else {
                options = options || {};
            }
            var r = Math.random();
            this.random = r;
            var self = this;
            return  $.get(url, function(result) {
                if ((typeof options.check === 'undefined' || options.check) && self.random != r) {
                    // too late: user clicked something else.
                    return;
                }
                (options.content || $("#s-content")).removeClass('bordered-left').html(result);
                if (typeof fn === 'function') {
                    fn.call(this);
                }

                // $('html, body').animate({scrollTop:0}, 200);
                var $window = $(window);
                setTimeout( function () {
                    $window.trigger("scroll");
                }, 250);

                showOrdersViewToggle();
                showOrdersSortMenu();


                $('.level2').show();
                $('#s-sidebar').width(200).show();


                self.checkAlerts();
            });

            function showOrdersViewToggle() {
                var $ordersViewToggle = $("#s-orders-views"),
                    is_orders_page = $("#s-order, #s-orders").length;

                if ($ordersViewToggle.length) {
                    if (is_orders_page) {
                        $ordersViewToggle.css("visibility", "visible");
                    } else {
                        $ordersViewToggle.css("visibility", "hidden");
                    }
                }
            }

            function showOrdersSortMenu() {
                var $ordersSortMenu = $("#s-orders-sort"),
                    is_orders_page = $("#s-order, #s-orders").length;

                if ($ordersSortMenu.length) {
                    if (is_orders_page) {
                        $ordersSortMenu.css("visibility", "visible");
                    } else {
                        $ordersSortMenu.css("visibility", "hidden");
                    }
                }
            }
        },


        checkAlerts: function () {
            var alerts = $.storage.get('shop/alerts');
            $.shop.trace('checkAlerts',alerts);
            $('.s-alert').each(function () {
                if ($.inArray($(this).data('alert'), alerts) == -1) {
                    $(this).show();
                }
            });
        }
    };
})(jQuery);;
( function($) {

    $.order_list = {

        /**
         * Current order
         * {Number}
         */
        id: 0,

        /**
         * {Object}
         * */
        options: {},

        /**
         * Jquery object related to list container
         * {Object|null}
         */
        container: null,

        /**
         * Jquery object
         * {Object|null}
         */
        $selectionMenu: null,

        /**
         * Jquery object related to sidebar
         * {Object|null}
         */
        sidebar: null,

        /**
         * Jquery object related to 'select all checkbox input'
         * {Object|null}
         */
        select_all_input: null,

        /**
         * Params by which list is filtered
         * {Object}
         */
        filter_params: {},

        /**
         * Params by which list is filtered (for passing to lazy-loader)
         * {String}
         */
        filter_params_str: '',

        /**
         * Params of dispatching
         * {Object}|null
         */
        params: null,

        /**
         * Id of timer
         * {Number}
         */
        timer_id: 0,

        /**
         * Jquery object to to which lazy_loader is bined
         * {Object}
         */
        lazy_load_win: null,

        /**
         * Cache of all printforms
         * {Object}|null
         */
        all_printforms: null,

        /**
         * Sort of list
         */
        sort: ['create_datetime', 'desc'],

        /**
         * Collection of xhr-deffered objects for synchronization
         * {Object}
         */
        xhrs: {
            lazy_load: null,
            update_load: null,
            printforms: null
        },

        init: function(options) {
            this.options = options = options || {};
            this.filter_params = options.filter_params || {};
            this.filter_params_str = options.filter_params_str || '';
            this.container = $('#order-list');
            if (options.view == 'table') {
                this.container = $('#order-list').find('tbody:first');
                this.$selectionMenu = this.options["$selectionMenu"];
                if (this.$selectionMenu) {
                    $("#mainmenu .s-level2").append(this.$selectionMenu);
                    this.select_all_input = this.$selectionMenu.find('.s-order-list-select-all')
                    this.select_all_input.attr('checked', false);
                }
            }
            this.sidebar = $('#s-sidebar');
            this.id = options.id || 0;

            if (options.orders && options.orders.length && options.view) {
                try {
                    this.container.append(
                        tmpl('template-order-list-' + this.options.view, {
                            orders: options.orders
                        }, true
                    ));
                    this.container.trigger('append_order_list', [options.orders]);
                } catch (e) {
                    if (console) {
                        console.log(e.stack);
                    }
                    return this;
                }
                delete options.orders;
                delete this.options.orders;
            }

            if (options.lazy_loading) {
                this.initLazyLoad(options.lazy_loading);
            }

            if (options.counters) {
                this.updateCounters(options.counters);
            }

            if (options.update_process && options.count) {
                this.updateProcess('run', options.update_process);
            }

            if (options.sort && options.sort[0]) {
                options.sort[0] = '' + options.sort[0];
                var available_sort_values = $('#s-orders-sort .s-sort').map(function () {
                    var sort = $(this).data('sort') || '';
                    return sort ? sort : false;
                }).toArray();
                if (available_sort_values.indexOf(options.sort[0]) < 0) {
                    options.sort[0] = available_sort_values[0];
                }
                options.sort[1] = (options.sort[1] || '');
                options.sort[1] = options.sort[1].toLowerCase() === 'desc' ? 'desc' : 'asc';
                this.sort = options.sort;
            }

            this.initView();
        },

        initLazyLoad: function(options) {
            var self = this;
            var count = self.options.count;
            var total_count = self.options.total_count;

            var win = $(window);

            win.lazyLoad('stop');
            if (count < total_count) {
                win.lazyLoad({
                    container: this.options.view ? self.container : win,
                    state: (typeof options.auto === 'undefined' ? true: options.auto) ? 'wake' : 'stop',
                    hash: ['orders', ''],   // ['', 'orders']
                    load: function() {
                        win.lazyLoad('sleep');
                        $('.lazyloading-link').hide();
                        $('.lazyloading-progress').show();
                        var last_li = self.container.find('.order:last');
                        var id = parseInt(last_li.attr('data-order-id'), 10);
                        if (!id) {
                            console.log("Unkown last item");
                            win.lazyLoad('stop');
                            return;
                        }
                        var process = function() {
                            return $.getJSON(self.buildLoadListUrl(id),
                                    function (r) {
                                        if (r.status == 'ok') {
                                            try {
                                                self.container.append(
                                                    tmpl('template-order-list-' + self.options.view, {
                                                        orders: r.data.orders,
                                                        check_all: self.options.view == 'table' ? self.select_all_input.attr('checked') : false
                                                    }
                                                ));
                                                self.container.trigger('append_order_list', [r.data.orders]);
                                                var order = self.container.find('[data-order-id='+self.options.id+']');
                                                if (order.length) {
                                                    self.container.find('.selected').removeClass('selected');
                                                    self.container.find('[data-order-id='+self.options.id+']').addClass('selected');
                                                }
                                            } catch (e) {
                                                if (console) {
                                                    console.log(e.stack);
                                                }
                                                win.lazyLoad('stop');
                                                return;
                                            }

                                            $('.lazyloading-progress-string').text(r.data.progress.loaded + ' ' + r.data.progress.of);
                                            $('.lazyloading-progress').hide();
                                            $('.lazyloading-chunk').text(r.data.progress.chunk);

                                            if (r.data.loaded >= r.data.total_count) {
                                                win.lazyLoad('stop');
                                                $('.lazyloading-link').hide();
                                            } else {
                                                $('.lazyloading-link').show();
                                                win.lazyLoad('wake');
                                            }
                                        } else {
                                            if (console) {
                                                console.log('Error when loading orders: ' + r.errors);
                                            }
                                            win.lazyLoad('stop');
                                        }
                                    }
                                ).error(function(r) {
                                    if (console) {
                                        if (r && r.errors) {
                                            console.log('Error when loading orders: ' + r.errors);
                                        } else if (r) {
                                            console.log(r);
                                        } else {
                                            console.log('Error when loading orders');
                                        }
                                    }
                                    win.lazyLoad('stop');
                                });
                        };
                        if (self.xhrs.update_load === null) {
                            self.xhrs.lazy_load = process();
                        } else {
                            self.xhrs.update_load.then(function() {
                                self.xhrs.lazy_load = process();
                            });
                        }
                    }
                });
                $('#s-orders').off('click', '.lazyloading-link').
                    on('click', '.lazyloading-link', function() {
                        win.lazyLoad('force');
                        return false;
                    }
                );
                this.lazy_load_win = win;
            }
        },

        initView: function() {
            var that = this;

            this.initSortMenu();

            this.initSidebar();
            if (this.options.view == 'table' && that.$selectionMenu && that.$selectionMenu.length) {
                this.initSelecting();
            }
            if (this.options.id) {
                this.loadOrder(this.options.id);
            }
            var orders_view_ul = $('#s-orders-views');
            orders_view_ul.find('li.selected').removeClass('selected');
            orders_view_ul.find('li[data-view="'+this.options.view+'"]').addClass('selected');
            orders_view_ul.find('li a').each(function() {
                var self = $(this);
                var li = $(this).parents('li:first');
                self.attr('href', '#/orders/view=' + li.attr('data-view') + ($.order_list.options.filter_params_str ? '&'+$.order_list.options.filter_params_str : '') + '/');
            });


            var performAction = function(action_id, selected_orders) {
                var finish = function(r, onFinish) {
                    $.order_list.updateCounters({
                        state_counters: r.data.state_counters,
                        common_counters: {
                            pending: r.data.pending_count
                        }
                    });

                    if (!$.isEmptyObject(r.data.orders)) {
                        $.order_list.updateListItems(r.data.orders);
                    }
                    $.order_list.select_all_input.trigger('select', false);

                    var ids = [];
                    var filter_params = $.order_list.filter_params;
                    if (!$.isEmptyObject(r.data.orders)) {
                        for (var i = 0, n = r.data.orders.length; i < n; i++) {
                            if (!$.isEmptyObject(filter_params) && filter_params.state_id) {
                                if ($.type(filter_params.state_id) === 'string' && filter_params.state_id !== r.data.orders[i].state_id) {
                                    ids.push(r.data.orders[i].id);
                                } else if ($.type(filter_params.state_id) === 'array' && filter_params.state_id.indexOf(r.data.orders[i].state_id) !== -1) {
                                    ids.push(r.data.orders[i].id);
                                }
                            }
                        }
                    }
                    if (!$.isEmptyObject(ids)) {
                        $.order_list.hideListItems(ids).done(function() {
                            if (!$.order_list.container.find('.order:not(:hidden):first').length) {
                                var html = '<div class="block double-padded align-center blank"><br><br><br><br><span class="gray large">'+$_("There are no orders in this view.")+'</span><div class="clear-left"></div></div></div>';
                                $('#s-content').html(html);
                            }
                        });
                    }

                    if (onFinish instanceof Function) {
                        onFinish(r);
                    }
                };
                var step = function(offset, onFinish) {
                    offset = offset || 0;
                    $.shop.jsonPost(
                        '?module=orders&action=performAction' +
                            '&id='+action_id +
                            '&offset=' + offset +
                            '&' + $.order_list.options.filter_params_str,
                        selected_orders,
                        function(r) {
                            if (r.status == 'ok') {
                                if (r.data.offset < r.data.total_count) {
                                    step(r.data.offset, finish);
                                } else {
                                    finish(r, onFinish);
                                }
                            } else {
                                finish(r, onFinish);
                            }
                        }
                    );
                };
                step(0, function() {
                    $.orders.dispatch();
                });
            };

            if (that.$selectionMenu) {
                that.$selectionMenu.on("click", "a", function () {
                    var $link = $(this),
                        action_id = $link.data("action-id");

                    if (action_id) {
                        onActionClick(action_id);
                    }
                    return false;
                });
            }

            function onActionClick( action_id ) {
                var selected_orders = $.order_list.getSelectedOrders();
                if (!selected_orders.order_id) { // means all orders
                    if (confirm($_('Perform action to all selected orders?'))) {
                        performAction(action_id, selected_orders);
                    }
                } else {
                    performAction(action_id, selected_orders);
                }
            }

        },

        loadOrder: function(order_id) {
            this.container.find('.selected').removeClass('selected');
            this.container.find('[data-order-id=' + order_id + ']').addClass('selected');

            var order_title = $('#s-order-title');
            order_title.find('.loading').show();
            $.orders.load(
                '?module=order&id= ' + order_id + '&' + this.filter_params_str,
                { content: $('#s-order') },
                function() {
                    this.id = order_id;
                }
            );
        },

        getSelectedOrders: function(serialize) {
            serialize = serialize || false;
            var data = { count: 0, all: false };
            if (this.select_all_input.attr('checked')) {
                data.all = true;
                var filter_params = $.order_list.filter_params;
                if (serialize) {
                    data.serialized = [];
                    if ($.isEmptyObject(filter_params)) {
                        data.serialized.push({ name: 'filter_params', value: '' });
                    } else {
                        $.each(filter_params, function (key, value) {
                            if ($.isArray(value)) {
                                $.each(value, function (k, v) {
                                    data.serialized.push({ name: 'filter_params[' + key + '][' + k + ']', value: v });
                                });
                            } else {
                                data.serialized.push({ name: 'filter_params[' + key + ']', value: value });
                            }
                        });
                    }
                } else {
                    data.filter_params = $.isEmptyObject(filter_params) ? '' : filter_params;
                }
                data.count = this.options.total_count;
            } else {
                if (serialize) {
                    data.serialized = $.order_list.container.find('.order.selected').map(function() {
                        data.count += 1;
                        return { name: 'order_id[]', value: $(this).attr('data-order-id') };
                    }).toArray();
                } else {
                    data.order_id = $.order_list.container.find('.order.selected').map(function() {
                        data.count += 1;
                        return $(this).attr('data-order-id');
                    }).toArray();
                }
            }
            return data;
        },

        initSortMenu: function () {

            var $menu = $('#s-orders-sort');

            // update ui menu helper
            var update = function (sort, change_hash) {
                var sort_field = sort[0];
                var sort_order = sort[1];
                var text = $('.s-sort[data-sort="' + sort_field + '"] a', $menu).text();
                $menu.find('.s-current-sort').data('sort', sort_field);
                $menu.find('.s-current-sort').data('order', sort_order);
                $menu.find('.s-current-sort .f-text').text(text);
                $menu.find('.s-sort-order').hide().filter('[data-order="' + sort_order + '"]').show();
                if (change_hash) {

                    var hash = window.location.hash || '';

                    hash = hash.replace(/(^[^#]*#\/*|\/$)/g, ''); /* fix syntax highlight*/

                    if (!hash.split('/')[1]) {
                        hash = '#/orders/state_id=new|processing|paid'
                    }

                    // clear hash, delete substring like sort[0]=foo and sort[1]=bar
                    hash = hash.replace(/(&*sort\[[01]\]=.*?[&\/]|&*sort\[[01]\]=.*?$)/g, '');

                    // check if exists any params in hash
                    var params_tail_exists = hash.indexOf('=') > 0;

                    if (params_tail_exists) {
                        // delete / and & in the end of hash
                        hash = hash.replace(/[\/&]$/, '');
                    }
                    // append new sort params
                    hash += (params_tail_exists ? '&' : '') + 'sort[0]=' + sort_field + '&sort[1]=' + sort_order + '/';

                    // update page
                    $.wa.setHash(hash);

                }
            };

            update(this.sort);

            // prevent binding events twice, cause menu item located in layout block and it isn't updated when inner content changed
            if (!$menu.data('inited')) {

                // when click to option click, change sort and order
                $menu.find('.s-sort a').click(function () {
                    var el = $(this);
                    var data = $menu.find('.s-current-sort').data();
                    var sort_field = data.sort;
                    var sort_order = data.order;
                    if (el.data('sort') === sort_field) {
                        sort_order = sort_order === 'desc' ? 'asc' : 'desc';
                    } else {
                        sort_field = el.data('sort');
                        sort_order = 'desc';
                    }
                    update([sort_field, sort_order], true);
                });

                $menu.data('inited', 1);
            }
        },

        initSidebar: function() {
            var sidebar = this.sidebar;

            // Replace list view type in all links in sidebar
            var view = this.options.view;
            sidebar.find('li.list a').each(function() {
                var item = $(this);
                var href = item.attr('href');
                var match = href.match(/view=((.*)&|(.*)\/|(.*))/);
                if (match) {
                    item.attr('href', href.replace('view='+(match[2]||match[3]||match[4]), 'view='+view));
                } else if ( ( match = href.match(/^#\/orders\/hash\/(.*?)\/?$/))) {/* */
                    item.attr('href', '#/orders/view='+view +'&hash='+encodeURIComponent(match[1])+'/');
                } else {
                    match = href.match(/orders\/((.*)\/|(.*))/);
                    var chunk = '';
                    if (match) {
                        if (match[1]) {
                            chunk = match[2] || match[3];
                            chunk += '&view=' + view;
                        } else {
                            chunk = 'view=' + view;
                        }
                        item.attr('href', '#/orders/' + chunk + '/');
                    }
                }
            });

            // Change active list view selection
            var $prev_li_selected = sidebar.find('li.selected').removeClass('selected');
            if (this.filter_params.state_id) {
                // Highlight a state
                if ($.isArray(this.filter_params.state_id)) {
                    $('#s-pending-orders').addClass('selected');
                } else {
                    sidebar.find('li[data-state-id="'+this.filter_params.state_id+'"]').addClass('selected');
                }
            } else if (this.filter_params.contact_id) {
                sidebar.find('li[data-contact-id='+this.filter_params.contact_id+']').addClass('selected');
            } else if (this.filter_params.storefront) {
                // Highlight storefront
                var decoded_url = decodeURIComponent(this.filter_params.storefront);
                if (decoded_url.slice(-1) === '/') {
                    decoded_url = decoded_url.slice(0, -1);
                }
                sidebar.find('li[data-storefront="'+decoded_url+'"]').addClass('selected');
            } else if (!$.order_list.filter_params_str) {
                $('#s-all-orders').addClass('selected');
            } else {
                // Do our best to highlight based on hash match
                var $li = sidebar.find('[href="'+window.location.hash+'"]:first').closest('li').addClass('selected');

                // When everything failed, leave the old selection
                if (!$li.length) {
                    $prev_li_selected.addClass('selected');
                }
            }

            sidebar.find('li.list a').unbind('click.order_list').bind('click.order_list', function() {
                // Highlight link in sidebar right avay after a click to be responsive.
                sidebar.find('li.selected').removeClass('selected');
                $(this).closest('li').addClass('selected');

                // Reload view even if user clicked on the active link again
                var hash = $(this).attr('href').replace(/(^[^#]*#\/*|\/$)/g, ''); /* fix syntax highlight*/
                if (hash == $.orders.hash) {
                    var params = $.orders.hash.replace('orders/', '');
                    $.order_list.dispatch(params, true);
                }
            });
        },

        initSelecting: function() {
            var that = this,
                container = this.container,
                select_all_input = this.select_all_input;

            select_all_input.click(function() {
                $(this).trigger('select', this.checked);
            });

            that.xhrs.printforms = null;

            var renderPrintforms = function(data) {
                var html = tmpl('template-order-list-printforms-menu-items', data);
                var $ul = that.$selectionMenu.find('.wf-actions');
                $ul.find('.s-printform-item,.s-printform-item-sep,.s-printform-item-button').remove();
                $ul.append(html)
            };

            // when 'shift' held on prevent default browser selecting
            $(document).keydown(function(e) {
                if (e.keyCode == 16) {
                    document.body.onselectstart = function() { return false; };
                }
            }).keyup(function(e) {
                if (e.keyCode == 16) {
                    document.body.onselectstart = null;
                }
            });

            var onSelectItem = function() {
                if ($.order_list.filter_params && !$.order_list.filter_params.length) {
                    var $table = $('#order-list'),
                        is_checked = select_all_input.attr("checked"),
                        is_selected = ( $table.find('.order.selected:first').length );

                    if (is_checked || is_selected) {
                        that.$selectionMenu.show();
                    } else {
                        that.$selectionMenu.hide();
                    }
                }
            };

            // handler of triggerable 'select' event
            container.off('select', '.order').on('select', '.order', function(e, selected) {
                selected = selected !== undefined ? selected : true;
                if (selected) {
                    $(this).addClass('selected').find('input:first').attr('checked', true);
                } else {
                    $(this).removeClass('selected').find('input:first').attr('checked', false);
                    if (select_all_input.is(':checked')) {
                        select_all_input.attr('checked', false);
                    }
                }
                onSelectItem();
                return false;
            });

            var loadPrintforms = function () {
                that.xhrs.printforms && that.xhrs.printforms.abort();

                renderPrintforms({
                    printforms: []
                });
                that.xhrs.printforms = null;
                if (select_all_input.is(':checked') && $.order_list.all_printforms !== null) {
                    renderPrintforms({
                        printforms: $.order_list.all_printforms
                    });
                    return;
                }
                
                that.xhrs.printforms = $.shop.getJSON(
                    '?module=orders&action=printforms',
                    that.getSelectedOrders(),
                    function (r) {
                        if (!$.isEmptyObject(r.data.printforms)) {
                            if (select_all_input.is(':checked')) {
                                $.order_list.all_printforms = r.data.printforms;
                            }
                            renderPrintforms(r.data);
                            that.xhrs.printforms = null;
                        }
                    }
                );
            };

            select_all_input.unbind('select').bind('select', function(e, selected) {
                selected = selected !== undefined ? selected : true;
                var self = $(this);
                if (selected) {
                    self.attr('checked', true);
                    container.find('.order').trigger('select', true, false);
                } else {
                    self.attr('checked', false);
                    container.find('.order').trigger('select', false, false);
                }
                loadPrintforms();
            });

            container.off('click', '.order input').on('click', '.order input', function(e) {
                var shiftKey = e.shiftKey,
                    checked = this.checked;
                var self = $(this).parents('.order:first');

                if (checked) {
                    self.addClass('selected');
                } else {
                    if (select_all_input.is(':checked')) {
                        select_all_input.attr('checked', false);
                    }
                    self.removeClass('selected');
                }

                if (shiftKey && checked) {   // when hold shift
                    var started = container.data('last_checked');
                    if (!started) {
                        started = container.find('.order:first').trigger('select', true);
                    }

                    // try find started before current
                    var found = self.prevAll('.selected[data-order-id='+started.attr('data-order-id')+']');
                    var item;
                    if (found.length) {
                        item = self.prev();
                        started = started.get(0);
                        while (item.length && started != item.get(0)) {
                            item.addClass('selected').find('input').attr('checked', true);
                            item = item.prev();
                        }
                    } else {
                        found = self.nextAll('.selected[data-order-id='+started.attr('data-order-id')+']');
                        if (found.length) {
                            item = self.next();
                            started = started.get(0);
                            while (item.length && started != item.get(0)) {
                                item.addClass('selected').find('input').attr('checked', true);
                                item = item.next();
                            }
                        }
                    }
                    if (!container.data('last_checked') && !found.length) {
                        started.trigger('selected', false);
                    }
                }
                if (checked) {
                    container.data('last_checked', self);
                }
                onSelectItem();
                loadPrintforms();

            });

            var printPrintforms = function(printforms, selected_orders) {

                var limit = 100;
                if (selected_orders.count > limit) {
                    alert($_('Maximum of %d orders is allowed for bulk form printing.').replace('%d', limit));
                    return;
                }

                var url = '?module=orders&action=printformsDisplay';

                var params_str = $.map(selected_orders.serialized, function (item) {
                    return item.name + '=' + item.value;
                }).join('&');
                var forms_str = $.map(printforms, function (form) {
                    return 'form[]=' + form;
                }).join('&');

                url += '&' + params_str + '&' + forms_str;

                var target_id = ('' + Math.random()).slice(2);
                window.open(url, target_id);
            };

            that.$selectionMenu.off('click.printforms').on('click.printforms', '.s-printform-item-button', function (e) {
                e.preventDefault();

                that.xhrs.printforms && that.xhrs.printforms.abort();
                that.xhrs.printforms = null;

                // collect forms
                var forms = that.$selectionMenu.find('.s-printform-item :checkbox').map(function () {
                    var $this = $(this);
                    var checked = $this.is(':checked');
                    if (!checked) {
                        return false;
                    }
                    return $this.data('id');
                }).toArray();

                if (!forms.length) {
                    return;
                }

                var selected_orders = that.getSelectedOrders(true);
                var count = selected_orders.count;
                if (count <= 0) {
                    return;
                }

                printPrintforms(forms, selected_orders);

                return false;
            });

        },

        updateTitle: function(title_suffix, count) {
            count = parseInt(count, 10) || 0;

            // context is mentioned in title
            var context = '';
            if (this.options.state_names) {
                if (this.filter_params.state_id) {
                    if (typeof this.filter_params.state_id === 'string') {
                        var state_id = this.filter_params.state_id;
                        context = this.options.state_names[state_id];
                    } else if ($.isArray(this.filter_params.state_id)) {
                        context = $_('Processing');
                    }
                } else {
                    context = $_('All orders');
                }
            }

            if (count) {
                document.title = '(' + count + ') ' + context + (title_suffix || '');
            } else {
                document.title = context + title_suffix;
            }
        },

        /**
         * @param {Object} counters
         *
         * Format: {
         *     state_counters: {
         *         new: '10' // string. Support incrementing, i.e.: '+5', '-7',
         *         processing: '10' // ....
         *     },
         *     common_counters: {
         *         pending: '5' // pending counter
         *     }
         * }
         *
         */
        updateCounters: function(counters) {
            var sidebar = this.sidebar;
            if (!sidebar) {
                sidebar = $('#s-sidebar');
            }
            var ext_new_counter = $('#s-pending-orders .small');
            for (var name in counters) {
                if (counters.hasOwnProperty(name)) {
                    var cntrs = counters[name];
                    for (var id in cntrs) {
                        if (cntrs.hasOwnProperty(id)) {
                            var item;
                            if (name == 'common_counters') {
                                item = $('#s-' + id + '-orders .count');
                            } else {
                                if (name === 'storefront_counters') {
                                    item = sidebar.find('li[data-'+name.replace('_counters', '')+'="'+id+'"] .count');
                                } else {
                                    item = sidebar.find('li[data-'+name.replace('_counters', '')+'-id='+id+'] .count');
                                }
                            }
                            var prev_cnt = parseInt(item.text(), 10) || 0;
                            var cnt = 0;
                            cntrs[id] = '' + cntrs[id];
                            if (cntrs[id].substr(0, 1) == '+') {
                                cnt = prev_cnt + (parseInt(cntrs[id].substr(1), 10) || 0);
                                item.text(cnt);
                            } else if (cntrs[id].substr(0, 1) == '-') {
                                cnt = prev_cnt - (parseInt(cntrs[id].substr(1), 10) || 0);
                                cnt = cnt < 0 ? 0 : cnt;
                                item.text(cnt);
                            } else {
                                cnt = parseInt(cntrs[id], 10) || 0;
                                item.text(cnt);
                            }
                            if (id == 'new') {
                                ext_new_counter.text(cnt ? '+' + cnt : '');
                                $.shop.updateAppCounter(cnt);
                                this.updateTitle(this.options.title_suffix, parseInt(cnt, 10));
                            }
                        }
                    }
                }
            }
        },

        updateListItems: function(data) {
            var self = this;
            var tmpl_name = 'template-order-list-'+this.options.view;
            if (document.getElementById(tmpl_name)) {
                var container = this.container;
                if (!$.isArray(data)) {
                    data = [data];
                }
                var rendered = $('<div></div>').append(tmpl(tmpl_name, {
                    orders: data,
                    check_all: self.options.view == 'table' ? self.select_all_input.attr('checked') : false
                }));
                var context = $('.order', container);
                $('.order', rendered).each(function() {
                    var item = $(this);
                    context.filter('[data-order-id='+item.attr('data-order-id')+']').replaceWith(item);
                });
                rendered.remove();
                self.container.trigger('append_order_list', [data]);
            }
        },

        hideListItems: function(id) {
            // deffered fiber
            var d = $.Deferred();
            setTimeout(function() {
                if ($.order_list && $.order_list.container && $.order_list.container.length) {
                    if (!$.isArray(id)) {
                        var items = $.order_list.container.find('.order[data-order-id='+id+']');
                    } else {
                        var context = $.order_list.container.find('.order');
                        var items = $();
                        for (var i = 0; i < id.length; i++) {
                            var item = context.filter('[data-order-id='+id[i]+']');
                            items = items.add(item);
                        }
                    }
                    var length = items.length;
                    var count = 0;
                    items.slideUp(450, function() {
                        count++;
                        if (count >= length) {
                            d.resolve();
                        }
                    });
                }
            }, 1000);
            return d.promise();
        },

        dispatch: function(params, hard) {
            if (typeof params === 'string') {
                params = $.shop.helper.parseParams(params);
            }
            var loaders = {
                list: function() {
                    $.order_list.finit();
                    $.orders.load('?module=orders&' + $.orders.buildOrdersUrlComponent(params), function() {
                        $.order_list.dispatch(params);
                    });
                },
                order: function() {
                    $.order_list.loadOrder(params.id);
                }
            };

            if (this.params === null) {     // order-list is just loaded
                this.params = params;
                if (hard) {
                    loaders.list();
                }
                return;
            }
            if (params.id) {  // order-list is loaded and id is changing
                if (hard || params.id != this.params.id) {
                    loaders.order();
                    this.params = params;
                    return;
                }
            }
            // params of order-list is changing
            if (hard || this.diff(params, this.params) || this.diff(this.params, params)) {
                loaders.list();
            }
        },

        diff: function(params1, params2) {
            for (var name in params1) {
                if (!params1.hasOwnProperty(name) || name == 'id') {
                    continue;
                }
                if (params1[name] !== params2[name]) {
                    return true;
                }
            }
            return false;
        },

        /**
         * @param {Number} id
         * @param {Boolean} lt (less than order with id, i.e. new orders). Default: falsy
         * @param {Boolean} counters (load list counters). Default: falsy
         * @returns {String}
         */
        buildLoadListUrl: function(id, lt, counters) {
            return '?module=orders&action=loadList&id=' + id +
                (this.filter_params_str ? '&' + this.filter_params_str : '') +
                (lt ? '&lt=1' : '') +
                (counters ? '&counters=1' : '') +
                (this.options.view ? '&view='+this.options.view : '') +
                ('&sort[0]=' + this.sort[0] + '&sort[1]=' + this.sort[1]);
        },

        updateProcess: function(status, options) {
            status = status || 'run';
            options = options || {};
            timeout = options.timeout || 60000;
            var self = this;
            var killProcess = function() {
                if (self.timer_id !== null) {
                    clearTimeout(self.timer_id);
                    self.timer_id = null;
                }
                if (self.xhrs.update_load !== null) {
                    self.xhrs.update_load.abort();
                    self.xhrs.update_load = null;
                }
            };
            killProcess();

            if (status == 'run') {
                var process = function(success, error) {
                    var first_li = self.container.find('.order:first');
                    var id = parseInt(first_li.attr('data-order-id'), 10) || 0;
                    return $.getJSON(self.buildLoadListUrl(id, true, true),
                            function (r) {
                                if (r.status == 'ok') {
                                    if (!$.isEmptyObject(r.data.counters)) {
                                        self.updateCounters(r.data.counters);
                                    }

                                    if (r.data.count) {
                                        try {
                                            self.container.prepend(
                                                tmpl('template-order-list-' + self.options.view, {
                                                    orders: r.data.orders,
                                                    check_all: self.options.view == 'table' ? self.select_all_input.attr('checked') : false
                                                }
                                            ));
                                            $('.lazyloading-progress-string').text(r.data.progress.loaded + ' ' + r.data.progress.of);
                                            self.container.trigger('append_order_list', [r.data.orders]);
                                        } catch (e) {
                                            if (console) {
                                                console.log('Error: ' + e.message);
                                                error();
                                            }
                                            return;
                                        }
                                    }
                                    if (typeof success === 'function') {
                                        success(r);
                                    }
                                } else {
                                    if (console) {
                                        console.log('Error when loading new orders: ' + r.errors);
                                    }
                                    if (typeof error === 'function') {
                                        error();
                                    }
                                }
                            }
                        ).error(function(r) {
                            if (console) {
                                if (r && r.errors) {
                                    console.log('Error when loading new orders: ' + r.errors);
                                } else {
                                    console.log(['Error when loading new orders', r]);
                                }
                            }
                            if (typeof error === 'function') {
                                error();
                            }
                        });
                };
                var runProcess = function() {
                    self.timer_id = setTimeout(function() {
                        var pr = function() {
                            return process(runProcess, killProcess);
                        };
                        if (self.xhrs.lazy_load === null) {
                            self.xhrs.update_load = pr();
                        } else {
                            self.xhrs.lazy_load.then(function() {
                                self.xhrs.update_load = pr();
                            });
                        }
                    }, timeout);
                };
                runProcess();
            }
        },

        /**
         * Finiting inited process
         *
         * @param {Boolean} destruct If true destructing object (delete)
         */
        finit: function(destruct) {
            var xhrs = this.xhrs, win = this.lazy_load_win;
            for (var k in xhrs) {
                if (xhrs.hasOwnProperty(k) && xhrs[k] !== null) {
                    xhrs[k].abort();
                }
            }
            this.updateProcess('kill');
            if (win) {
                win.lazyLoad('stop');
            }
            this.params = null;
        }
    };

})(jQuery);;
$.order_edit = {

    /**
     * {Number}
     */
    id : 0,

    /**
     * {Jquery object}
     */
    container : null,

    /**
     * {Jquery object}
     */
    form : null,

    customer_fields : null,
    customer_inputs : null,

    /**
     * {Array}
     */
    stocks: [],

    /**
     * On/off edit mode
     * {Boolen}
     */
    slide_on : false,

    /**
     * {Object}
     */
    options : {},

    init : function(options) {
        this.options = options;
        if (options.id) {
            this.id = options.id;
        }
        this.container = typeof options.container === 'string' ? $(options.container) : options.container;
        this.form = typeof options.form === 'string' ? $(options.form) : options.form;
        this.customer_fields = $('#s-order-edit-customer');
        this.customer_inputs = this.customer_fields.find(':input');

        options.stocks.sort(function(a, b) {
            return a.sort - b.sort;
        });
        this.stocks = options.stocks;

        if (options.title) {
            document.title = title;
        }

        if (!options.float_delimeter) {
            options.float_delimeter = '.';
        }

        this.float_delimeter = options.float_delimeter;

        this.initView();
    },

    initView : function() {
        var options = this.options;
        this.initCustomerForm(this.id ? 'edit' : 'add');

        // helpers and handlers here
        var updateStockIcon = function(order_item) {
            var select   = order_item.find('.s-orders-sku-stock-select');
            var option   = select.find('option:selected');
            var sku_item = order_item.find('.s-orders-skus').
                find('input[type=radio]:checked').
                parents('li:first');

            order_item.find('.s-orders-stock-icon-aggregate').show();
            order_item.find('.s-orders-stock-icon').html('').hide();

            // choose item to work with
            var item = sku_item.length ?
                sku_item :   // sku case
                order_item;  // product case (one sku)

            if (option.attr('data-icon')) {
                item.find('.s-orders-stock-icon-aggregate').hide();
                item.find('.s-orders-stock-icon').html(
                    option.attr('data-icon')
                ).show();
                order_item.find('.s-orders-stock-icon .s-stock-left-text').show();
                item.find('.s-orders-stock-icon .s-stock-left-text').hide();
            }
        };

        $.order_edit.slide(true, options.mode == 'add');

        this.container.find('.back').click(function() {
            if ($.order_edit.id) {
                $.order_edit.slide(false);
            } else {
                $.order_edit.slide(false, true);
            }
            $.orders.back();
            return false;
        });

        this.updateTotal(false);
        $('.s-order-item').each(function() {
            var item = $(this);
            updateStockIcon(item);
        });

        $('#order-currency').change(function () {
            $('#order-items .currency').html($(this).val());
            $.order_edit.options.currency = $(this).val();
        });

        var price_edit = options.price_edit || false;

        var add_order_input = $("#orders-add-autocomplete");
        add_order_input.autocomplete({
            source : '?action=autocomplete&with_counts=1',
            minLength : 3,
            delay : 300,
            select : function(event, ui) {

                $('.s-order-errors').empty();

                var url = '?module=orders&action=getProduct&product_id=' + ui.item.id;
                $.getJSON(url + ($.order_edit.id ? '&order_id=' + $.order_edit.id : '&currency=' + $.order_edit.options.currency), function(r) {
                    var table = $('#order-items');
                    var index = parseInt(table.find('.s-order-item:last').attr('data-index'), 10) + 1 || 1;
                    var product = r.data.product;
                    if (product.sku_id && product.skus[product.sku_id]) {
                        product.skus[product.sku_id].checked = true;
                    }

                    if ($('#order-currency').length && !$('#order-currency').attr('disabled')) {
                        $('<input type="hidden" name="currency">').val($('#order-currency').val()).insertAfter($('#order-currency'));
                        $('#order-currency').attr('disabled', 'disabled');
                    }

                    var add_row = $('#s-orders-add-row');
                    add_row.before(tmpl('template-order', {
                        data: r.data, options: {
                            index: index,
                            currency: $.order_edit.options.currency,
                            stocks: $.order_edit.stocks,
                            price_edit: price_edit
                        }
                    }));
                    var item = add_row.prev();
                    //item.find('.s-orders-services .s-orders-service-variant').trigger('change');

                    $('#s-order-comment-edit').show();

                    $.order_edit.updateTotal();

                    updateStockIcon(item);

                });
                add_order_input.val('');

                return false;
            }
        });

        this.container.
            off('change', '.s-orders-skus input[type=radio]').
            on('change', '.s-orders-skus input[type=radio]',
                function() {
                    var self = $(this);
                    var tr = self.parents('tr:first');
                    var li = self.closest('li');
                    var sku_id = this.value;
                    var product_id = tr.attr('data-product-id');
                    var index = tr.attr('data-index');
                    var mode = $.order_edit.id ? 'edit' : 'add';
                    var item_id = null;
                    if (mode == 'edit') {
                        item_id = parseInt(self.attr('name').replace('sku[edit][', ''), 10);
                    }

                    var url = '?module=orders&action=getProduct&product_id='+product_id+'&sku_id='+sku_id;
                    $.getJSON(url + ($.order_edit.id ? '&order_id=' + $.order_edit.id : '&currency=' + $.order_edit.options.currency), function(r) {
                        tr.find('.s-orders-services').replaceWith(
                            tmpl('template-order-services', {
                                services: r.data.sku.services,
                                service_ids: r.data.service_ids,
                                product_id: product_id,
                                options: {
                                    price_edit: price_edit,
                                    index: index,
                                    currency: $.order_edit.options.currency,
                                    stocks: $.order_edit.stocks
                                }
                            })
                        );
                        tr.find('.s-orders-product-price').
                            //find('span').html(r.data.sku.price_html || r.data.sku.price_str).end().
                            find('input').val(r.data.sku.price);
                        //.trigger('change');

                        var ns;
                        if (tr.find('input:first').attr('name').indexOf('add') !== -1) {
                            ns = 'add';
                        } else {
                            ns = 'edit';
                        }

                        tr.find('.s-orders-sku-stock-place').empty();
                        li.find('.s-orders-sku-stock-place').html(
                            tmpl('template-order-stocks-' + ns, {
                                sku:     r.data.sku,
                                index:   index,
                                stocks:  $.order_edit.stocks,
                                item_id: item_id   // use only for edit namespace
                            })
                        );

                        updateStockIcon(tr);
                        $.order_edit.updateTotal(tr);

                    });
                }
            );

        // change stocks select
        this.container.
            off('change', '.s-orders-sku-stock-select').
            on( 'change', '.s-orders-sku-stock-select', function() {
                var item = $(this).parents('tr.s-order-item:first');
                updateStockIcon(item);
            });

        var updateServicePriceInput = function(variant_option, service_input, update_val) {
                var price = variant_option.attr('data-price');
                var percent_price = variant_option.attr('data-percent-price');
                if (update_val) {
                    service_input.val(price);
                }
                service_input.attr('data-price', price);
                service_input.attr('data-percent-price', percent_price);
        };
        this.container.
            off('change', '.s-orders-service-variant').
            on('change', '.s-orders-service-variant', function() {
                var self = $(this);
                var option = self.find('option:selected');
                var li = self.parents('li:first');
                updateServicePriceInput(option, li.find('.s-orders-service-price'), true);
        });
        this.container.find('.s-orders-service-variant').each(function() {
                var item = $(this);
                var option = item.find('option:selected');
                var li = item.parents('li:first');
                updateServicePriceInput(option, li.find('.s-orders-service-price'), false);
        });

        this.container.off('click', '.s-order-item-delete').on('click', '.s-order-item-delete', function() {
//            $(this).parents('tr:first').replaceWith(
//                $.order_edit.container.find('.template-deleted').clone().show()
//            );

            var self = $(this);
            self.parents('tr:first').remove();
            if (!self.parents('table:first').find('tr.s-order-item:first').length) {
                $('#s-order-comment-edit').hide();
            }

            $.order_edit.updateTotal();
            return false;
        });

        // calculations
        this.container.
            off('change', '.s-orders-services input').
            on('change', '.s-orders-services input', $.order_edit.updateTotal);
        this.container.
            off('change', '.s-orders-product-price input').
            on('change', '.s-orders-product-price input', function() {
                var price = $.order_edit.parseFloat($(this).val());
                $.order_edit.container.find('.s-orders-service-price').each(function() {
                    var item = $(this);
                    if (item.data('currency') === '%' && item.attr('data-price') === item.val()) {
                        var p = price * (item.data('percentPrice') / 100);
                        item.val($.order_edit.formatFloat(p));
                        item.attr('data-price', p);
                    }
                });
                $.order_edit.updateTotal.apply(this);
            });
        this.container.
            off('change', '.s-orders-services .s-orders-service-variant').
            on('change', '.s-orders-services .s-orders-service-variant',
                    $.order_edit.updateTotal
        );

        $(".s-order-customer-details").on('change', 'input[type=text],select', function () {
            if  ($(this).attr('name').indexOf('address')) {
                $.order_edit.updateTotal();
            }
        });

        $("#shipping_methods").change(function(e) {
            var o = $(this).children(':selected');
            var rate = o.data('rate') || 0;
            $("#shipping-rate").val($.order_edit.formatFloat(rate));
            var delivery_info = [];
            if(o.data('error')) delivery_info.push('<span class="error">' + o.data('error') + '</span>');
            if(o.data('est_delivery')) delivery_info.push('<span class="hint est_delivery">' + o.data('est_delivery') + '</span>');
            if(o.data('comment')) delivery_info.push('<span class="hint">' + o.data('comment') + '</span>');
            if (delivery_info) {
                if(o.data('error')) {
                    $("#shipping-rate").addClass('error');
                } else {
                    $("#shipping-rate").removeClass('error');
                }
                $("#shipping-info").html(delivery_info.join('<br>')).show();
            } else {
                $("#shipping-rate").removeClass('error');
                $("#shipping-info").empty().hide();
            }
            $.order_edit.updateTotal(false);
            if (o.data('external') && !e.triggered_by_updateTotal) {
                $.order_edit.updateTotal();
            }
        });

        $("#payment_methods").change(function() {
            var pid = $(this).val();
            $("#payment-info > div").hide();
            if ($('#payment-custom-' + pid).length) {
                $('#payment-custom-' + pid).show();
            }
        });

        $("#discount,#shipping-rate").change(function() {
            $.order_edit.updateTotal(false);
        });

        this.container.off('keydown', '.s-orders-quantity').on('keydown', '.s-orders-quantity', function() {
            var self = $(this);
            var timer_id = self.data('timer_id');
            if (timer_id) {
                clearTimeout(timer_id);
            }
            self.data('timer_id', setTimeout(function() {
                $.order_edit.updateTotal();
            }, 450));
        });

        if (this.form && this.form.length) {

            var orderSaveSubmit = function () {

                var form = $(this);
                if (orderSaveSubmit.xhr) {
                    return false;
                }
                $.order_edit.showValidateErrors();

                // submit optimization
                // disable that services that aren't checked
                $('.s-orders-services input[name^=service]:not(:checked)', this.form).each(function() {
                    var item = $(this);
                    item.closest('li').find(':input').attr('disabled', true);
                });

                if (!$.order_edit.container.find('.error').length) {

                    $('.s-order-items-edit td.save i.loading').css('display', 'inline-block');
                    form.find('[type=submit]').attr('disabled', true);

                    var onAlwaysSubmit = function () {
                        orderSaveSubmit.xhr = null;
                        form.find('[type=submit]').attr('disabled', false);
                        $('.s-orders-services input:disabled', form).attr('disabled', false);
                        $('.s-order-items-edit td.save i.loading').css('display', 'none');
                    };
                    if ($.order_edit.id) {
                        orderSaveSubmit.xhr = $.order_edit.editSubmit(onAlwaysSubmit);
                    } else {
                        orderSaveSubmit.xhr = $.order_edit.addSubmit(onAlwaysSubmit);
                    }
                }
                return false;
            };

            this.form.unbind('sumbit').bind('submit', orderSaveSubmit);
        }

        this.initDiscountControl();
    },

    initDiscountControl: function() {
        var $discount_input = $('#discount');
        var $discount_description_input = $('#discount-description');
        var $update_discount_button = $('#update-discount');
        var $tooltip_icon = $('#discount-tooltip-icon');

        // Tooltip to show how discounts were calculated
        $(document).tooltip
        $tooltip_icon.tooltip({
            bodyHandler: function() {
                return $discount_description_input.val() || $discount_description_input.data('updated-manually-msg');
            }
        });
        $update_discount_button.tooltip({
            bodyHandler: function() {
                return $update_discount_button.data('description') || $discount_description_input.data('updated-manually-msg');
            }
        });

        // Nothing to show yet
        $tooltip_icon.hide();

        // When we get recalculated discount, update the fields accordingly
        $('#order-edit-form').on('order_total_updated', function(e, data) {
            if (!data.discount) {
                return;
            }

            // Remember recalculated discount value and description
            $update_discount_button.data('value', data.discount).data('description', data.discount_description);

            if ($update_discount_button.data('just-recalculated')) {
                // When value in discount input matches previous recalculation,
                // but new recalculated discount is different,
                // update visible fields immidiately
                if (data.discount+'' != $discount_input.val()) {
                    $update_discount_button.click();
                }
            } else {
                // Otherwise, make user decide whether they want to recalculate the discount
                $update_discount_button.show();
            }
        });

        // When user clicks the update button, put discount value and description to fields
        // and hide the button itself
        $update_discount_button.click(function () {
            $discount_description_input.val($update_discount_button.data('description')||'');
            $discount_input.val($update_discount_button.data('value')||0).change();
            $update_discount_button.hide().data('just-recalculated', true);
            updateTooltipVisibility();
            if ($tooltip_icon.is(':visible')) {
                $tooltip_icon.fadeOut(50, function(){
                    $tooltip_icon.fadeIn(50, function(){
                        $tooltip_icon.fadeOut(50, function(){
                            $tooltip_icon.fadeIn(50, function(){
                                $tooltip_icon.fadeOut(50, function(){
                                    $tooltip_icon.fadeIn(50, function(){
                                        $tooltip_icon.fadeOut(50, function(){
                                            $tooltip_icon.fadeIn(50, function(){
                                                // many animation
                                                //          @    such blinks
                                                //   wow
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            }
            return false;
        });

        // When user updates the discount field by hand, show the button to reset to calculated values
        $discount_input.on('keyup', function() {
            $discount_description_input.val('');
            $update_discount_button.show().data('just-recalculated', false);
            updateTooltipVisibility();
        });

        function updateTooltipVisibility() {
            if ($discount_input.val() > 0) {
                $tooltip_icon.stop().show();
            } else {
                $tooltip_icon.stop().hide();
            }
        }
    },

    updateTotal : function(ajax) {
        var ajax = ajax === undefined ? true : ajax;
        var container = $.order_edit.container;
        if (!container.find('.s-order-item').length) {
            $("#subtotal").text(0);
            $("#total").text(0);
            return;
        }
        var subtotal = 0;
        var $discount_input = $('#discount');

        // Data for orderTotal controller
        var data = {};
        var customer = $("#s-order-edit-customer").find('[name^="customer["]').serializeArray();
        for (var i = 0; i < customer.length; i++) {
            data[customer[i].name] = customer[i].value;
        }
        data.items = [];

        container.find('.s-order-item').each(function() {
            var tr = $(this);
            var product_id = tr.find('input[name^="product"]').val();
            var services = [];
            var price = $.order_edit.parseFloat(tr.find('.s-orders-product-price input').val());
            var quantity = $.order_edit.parseFloat(tr.find('input.s-orders-quantity').val());

            subtotal += price * quantity;

            if (tr.find('.s-orders-services').length) {
                tr.find('.s-orders-services input:checkbox:checked').each(function() {
                    var li = $(this).closest('li');
                    var service_price = $.order_edit.parseFloat(li.find('input.s-orders-service-price').val());

                    services.push({
                        id: $(this).val(),
                        price: service_price
                    });

                    subtotal   += service_price * quantity;

                });
            }

            // get SKU id
            var sku_input = tr.find('input[name^=sku]:not(:radio)').add(tr.find('input[name^=sku]:checked')).first();
            var sku_id = sku_input.val() || 0;

            data.items.push({
                product_id: product_id,
                quantity: quantity,
                price: price,
                sku_id: sku_id,
                services: services
            });
        });
        data.subtotal = subtotal;
        var discount = $.order_edit.parseFloat($discount_input.val() || 0);
        data.discount = discount;
        if ($.order_edit.id) {
            data.order_id =  $.order_edit.id;
        } else {
            data['currency'] = $('#order-edit-form input[name=currency]').val();
        }
        data['shipping_id'] = ($('#shipping_methods').val()||'').split('.')[0];
        data['customer[id]'] = $('#s-customer-id').val();

        if (ajax) {
            // Fetch shipping options and rates, and other info from orderTotal controller
            $.post('?module=order&action=total', data, function(response) {
                if (response.status == 'ok') {
                    var el = $("#shipping_methods");
                    var el_selected = el.val();
                    el.empty();

                    var shipping_method_ids = response.data.shipping_method_ids;
                    var shipping_methods = response.data.shipping_methods;

                    // exact match
                    var found = shipping_method_ids.indexOf(el_selected) !== -1;

                    for (var i = 0; i < shipping_method_ids.length; i += 1) {
                        var ship_id = shipping_method_ids[i];
                        var ship =  shipping_methods[ship_id];
                        var o = $('<option></option>');
                        o.html(ship.name).attr('value', ship_id).data('rate', ship.rate);
                        o.data('error', ship.error || undefined);
                        o.data('est_delivery', ship.est_delivery || undefined);
                        o.data('comment', ship.comment || undefined);
                        o.data('external', ship.external || false);
                        el.append(o);

                        // unexact match, but close
                        if (!found) {
                            var ship_id_parts = ('' + ship_id).split('.');
                            var el_selected_parts = el_selected.split('.');
                            if (ship_id_parts[0] !== undefined && el_selected_parts[0] !== undefined &&
                                    ship_id_parts[0] == el_selected_parts[0])
                            {
                                    found = true;
                                    el_selected = ship_id;
                            }
                        }
                    }

                    if (found) {
                        el.val(el_selected);
                        el_selected += '';
                        if (!shipping_methods[el_selected].external || data['shipping_id'] == el_selected.split('.')[0]) {
                            el.trigger($.Event('change', {
                                triggered_by_updateTotal: 1
                            }));
                        }
                    }

                    $('#order-edit-form').trigger('order_total_updated', response.data);
                }
            }, 'json');
        }

        $("#subtotal").text($.order_edit.formatFloat(Math.round(subtotal * 100) / 100));
        var shipping = $.order_edit.parseFloat($("#shipping-rate").val().replace(',', '.')) || 0;
        var undiscounted_total = subtotal + shipping;

        // correct discout by constraint: total must be >= 0
        if (discount < 0) {
            discount = 0;
            $discount_input.val('');
        } else {
            if (undiscounted_total - discount < 0) {
                discount = undiscounted_total;
            }
            $discount_input.val($.order_edit.formatFloat(Math.round(discount * 100) / 100));
        }

        var total = undiscounted_total - discount;
        $("#total").text($.order_edit.formatFloat(Math.round(total * 100) / 100));
    },

    editSubmit : function(always) {
        var form = this.form;
        return $.shop.jsonPost(
            form.attr('action'),
            form.serialize(),
            function(r) {
                $.order_edit.container.find('.back').click();
            },
            function(r) {
                $.shop.trace('editSubmit', r);
                if (r && r.errors && !$.isEmptyObject(r.errors)) {
                    $.order_edit.showValidateErrors(r.errors);
                }
            },
            always
        );
    },

    addSubmit : function(always) {
        var form = this.form;
        $.shop.trace('addSubmit', $(form));
        return $.shop.jsonPost(
            form.attr('action'),
            form.serialize(),
            function(r) {
                if ($.order_edit.slide(false, true)) {
                    location.href = '#/orders/state_id=new&view=split&id=' + r.data.order.id + '/';
                }
            },
            function(r) {
                $.shop.trace('addSubmit', r);
                if (r && r.errors && !$.isEmptyObject(r.errors)) {
                    $.order_edit.showValidateErrors(r.errors);
                }
            },
            always
        );
    },

    formatFloat: function(f) {
        if (this.float_delimeter === ',') {
            return ('' + f).replace('.', ',');
        }
        return '' + f;
    },

    parseFloat: function(str) {
        if (!str) {
            return 0;
        } else {
            return parseFloat(('' + str).replace(',', '.'));
        }
    },

    slideBack : function() {
        this.slide(false, this.options.mode == 'add');
    },

    slide : function(on, add, done) {
        if (arguments.length == 0) {
            this.slide(true, this.options.mode == 'add');
            return;
        }
        on = typeof on === 'undefined' ? true : on; // on/off
        add = typeof add === 'undefined' ? false : add;
        var duration = this.options.duration || 200;
        var view = this.options.view;
        var deferreds = [];

        if (!this.slide_on && on) { // make editable
            deferreds.push($('#s-sidebar').animate({
                'width' : 0
            }, duration, function() {
                $(this).hide();
            }));
            $('.s-level2').hide();
            deferreds.push($('#maincontent').animate({
                'margin-top' : 45
            }, duration));
            deferreds.push($('#s-content').animate({
                'margin-left' : 0
            }, duration));
            deferreds.push($('#s-orders').animate({
                'width' : 0
            }, duration, function() {
                $(this).hide();
            }));
            deferreds.push($('#s-order').animate({
                'margin-left' : 0
            }, duration).find('>div:first').removeClass('double-padded, bordered-left').find('h1 .back.order-list').hide().end().find('h1 .back.read-mode')
            .show());
            this.slide_on = true;
            $('.s-order-readable').hide();
            $('.s-order-editable').show();

            $.when(deferreds).done(function() {
                if ($.order_list.lazy_load_win) {
                    $.order_list.lazy_load_win.lazyLoad('sleep');
                }
                if (typeof done === 'function') {
                    done.call(this);
                }
            });

            return true;
        } else if (this.slide_on && !on) { // make readable
            deferreds
            .push($('#s-order').animate({
                'margin-left' : view != 'table' && !add ? 300 : 200
            }, duration).find('>div:first').addClass('double-padded, bordered-left').find('h1 .back.order-list').show().end().find('h1 .back.read-mode').hide());
            deferreds.push($('#s-orders').animate({
                'width' : 300
            }, duration).show());
            deferreds.push($('#s-content').animate({
                'margin-left' : 200
            }, duration));
            deferreds.push($('#maincontent').animate({
                'margin-top' : 84
            }, duration));
            $('.s-level2').show();
            deferreds.push($('#s-sidebar').animate({
                'width' : 200
            }, duration).show());
            this.slide_on = false;
            $('.s-order-editable').hide();
            $('.s-order-readable').show();

            $.when(deferreds).done(function() {
                if ($.order_list.lazy_load_win) {
                    $.order_list.lazy_load_win.lazyLoad('wake');
                }
                if (typeof done === 'function') {
                    done.call(this);
                }
            });

            return true;
        }
        return false;
    },

    showValidateErrors : function(validate_errors) {
        $('.error').removeClass('error');
        $('#s-order-edit-customer .errormsg').empty();
        if (validate_errors && validate_errors.customer) {
            var errors = validate_errors.customer;
            $.order_edit.customer_fields.find('.field-group:first').html(errors.html);
            delete errors.html;
            for (var name in errors) {
                $.order_edit.customer_fields.find('.s-error-customer-' + name).each(function() {
                    var item = $(this);
                    if (this.tagName == 'EM') {
                        item.text(errors[name]);
                    } else {
                        item.addClass('error');
                    }
                });
            }
        }

        var common_errors = [];

        $('.s-order-errors').empty();
        if (validate_errors && validate_errors.order) {
            if (!$.isEmptyObject(validate_errors.order.items)) {
                for (var index in validate_errors.order.items) {
                    var tr = $('.s-order-item[data-index='+index+']');
                    var errors = validate_errors.order.items[index];
                    for (var name in errors) {
                        var message = tr.find('.s-error-item-' + name);
                        if (message.length) {
                            message.text(errors[name]);
                        } else {
                            common_errors.push(errors[name]);
                        }
                    }
                    delete validate_errors.order.items[index];
                }
            }


            if (!$.isEmptyObject(validate_errors.order.product)) {
                var p_errors = validate_errors.order.product;
                for (var p_id in p_errors) {
                    if (p_errors.hasOwnProperty(p_id)) {
                        if ('quantity' in p_errors[p_id]) {
                            $('.s-order-item[data-product-id='+p_id+']').each(function () {
                                if ($(this).find('ul.s-orders-skus input:radio:checked').val() == '' + p_errors[p_id]['sku_id'] || !$(this).find('ul.s-orders-skus').length) {
                                    $(this).find('.s-orders-quantity').addClass('error');
                                    common_errors.push(p_errors[p_id]['quantity']);
                                }
                            });
                        }
                    }
                }
            }
            if (validate_errors.order.common) {
                common_errors.push(validate_errors.order.common);
            }

            if (common_errors.length) {
                $('.s-order-errors').html(common_errors.join("<br>"));
            }

        }
    },

    bindValidateErrorPlaceholders : function() {
        // firstname, middlename, lastname mark as having one name of error
        var names = ['firstname', 'middlename', 'lastname'];
        for (var i = 0, n = names.length; i < n; i += 1) {
            var name = names[i];
            $.order_edit.customer_inputs.filter('[name=' + $.order_edit.inputName(name) + ']').addClass('s-error-customer-name');
        }
        $.order_edit.customer_fields.find('.s-error-customer-name:last').after('<em class="errormsg s-error-customer-name"></em>');
    },

    initCustomerForm : function(editing_mode) {
        editing_mode = typeof editing_mode === 'undefined' ? 'add' : editing_mode;

        $.order_edit.bindValidateErrorPlaceholders();

        // editing mode (no autocomplete)
        if (editing_mode !== 'add') {
            return;
        }

        // adding mode (with autocomplete);
        var autocompete_input = $("#customer-autocomplete");

        // utility-functions
        var disable = function(disabled) {
            disabled = typeof disabled === 'undefined' ? true : disabled;
            $('#s-customer-id').attr('disabled', disabled);
            if (disabled) {
                $('#s-order-edit-customer').addClass('s-opaque');
            } else {
                $('#s-order-edit-customer').removeClass('s-opaque');
            }
        };
        var activate = function(activate) {
            activate = typeof activate === 'undefined' ? true : activate;
            if (activate) {
                disable(false);
                autocompete_input.val('').hide(200);
            } else {
                disable();
                resetInputValues();
                autocompete_input.val('').show();
            }
        };
        var testPhone = function(str) {
            return parseInt(str, 10) || str.substr(0, 1) == '+' || str.indexOf('(') !== -1;
        };
        var testEmail = function(str) {
            return str.indexOf('@') !== -1;
        };

        var resetInputValues = (function() {
            var initial_values = {};
            $.order_edit.customer_inputs.each(function() {
                var $self = $(this);
                initial_values[$self.attr('name')] = $self.val();
            });

            return function() {
                $.order_edit.customer_inputs.each(function() {
                    var $self = $(this);
                    $self.val(initial_values[$self.attr('name')] || '');
                });
            };
        });

        // mark whole form as disabled (disactivated) to user want use autocomplete
        activate(false);
        $.order_edit.customer_fields.off('focus', ':input').on('focus', ':input', function() {
            disable(false);
        });

        // Link to create a new customer resets fields even after something is selected in autocomplete
        $('#s-order-new-customer').click(function() {
            resetInputValues();
            activate();
            $.order_edit.customer_inputs.first().focus();
            $('#s-customer-id').val(0);
            return false;
        });

        var term = '';

        // autocomplete
        autocompete_input.autocomplete({
            source : function(request, response) {
                term = request.term;
                $.getJSON($.order_edit.options.autocomplete_url, request, function(r) {
                    (r = r || []).push({
                        label : $_('New customer'),
                        name  : $_('New customer'),
                        value : 0
                    });
                    response(r);
                });
            },
            delay : 300,
            minLength : 3,
            select : function(event, ui) {
                var item = ui.item;

                var focusFirstEmptyInput = function() {
                    var focused = false;
                    $.order_edit.customer_inputs.filter('input[type=text], textarea').each(function() {
                        var input = $(this);
                        if (input.is(':not(:hidden)') && !this.value) {
                            focused = true;
                            input.focus();
                            return false;
                        }
                    });
                    if (!focused) {
                        $.order_edit.customer_inputs.first().focus();
                    }
                };

                if (item.value) {
                    $.get('?action=contactForm&id=' + item.value, function(html) {
                        $.order_edit.customer_fields.find('.field-group:first').html(html);
                        $.order_edit.customer_inputs = $.order_edit.customer_fields.find(':input');
                        $('#s-customer-id').val(item.value);
                        activate();

                        // autocomplete make focus for its input. That brakes out plan!
                        // setTimout-hack for fix it
                        setTimeout(function() {
                            focusFirstEmptyInput();
                        }, 200);
                    });
                } else {
                    var selector = '[name=' + $.order_edit.inputName(
                        testPhone(term) ? 'phone' : (
                            testEmail(term) ? 'email' : 'firstname'
                    )) + ']';
                    $.order_edit.customer_inputs.filter(selector).val(term);
                    $('#s-customer-id').val(0);
                    activate();

                    // autocomplete make focus for its input. That brakes out plan!
                    // setTimout-hack for fix it
                    setTimeout(function() {
                        focusFirstEmptyInput();
                    }, 200);
                }

                return false;
            },
            focus: function(event, ui) {
                this.value = ui.item.name;
                return false;
            }
        });

        $('#order-add-form').submit(function() {
            disable(false);
        });
    },

    inputName : function(name) {
        return '"customer[' + name + ']"';
    },

    getPercentSymbol: function() {
        return '%';
    }
};
;
